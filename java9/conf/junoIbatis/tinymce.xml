<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="TinyMCE">

	<resultMap id="resultImage" class="com.worldcheck.juno.vo.common.TinyMCE">
		<result property="id" column="UPLOADED_IMAGE_ID" />
		<result property="fileType" column="FILETYPE" />
		<result property="imageData" column="IMAGE_DATA" />
		<result property="userName" column="UPDATED_BY" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="crn" column="CASE_ID" />
	</resultMap>

	<select id="getImage" resultMap="resultImage"
		parameterClass="java.lang.Long">
		SELECT * FROM RG_UPLOADED_IMAGES where UPLOADED_IMAGE_ID = #id#
	</select>

	<insert id="insertImage" parameterClass="com.worldcheck.juno.vo.common.TinyMCE">
		<selectKey resultClass="java.lang.Long" keyProperty="id">  
			select RG_UPLOADED_IMAGES_SEQ.nextval from dual
		</selectKey>
		insert into RG_UPLOADED_IMAGES
		(UPLOADED_IMAGE_ID,IMAGE_DATA,UPDATED_ON,UPDATED_BY,CASE_ID,FILETYPE)
		values
		(#id#,#imageData#,sysdate,#userName#,#crn#, #fileType#)
	</insert>
	
	<resultMap id="componentSet"
		class="com.worldcheck.juno.vo.component.TocComponent">
		<result property="title" column="component_title" />
		<result property="bookmark" column="bookmark" />
	</resultMap>
	
	<resultMap id="resultSubjects" class="com.worldcheck.juno.vo.component.TocSubject" groupBy="id">
		<result property="id" column="subject_id" />
		<result property="name" column="subject_name" />
		<result property="components" resultMap="TinyMCE.componentSet" />
	</resultMap>
	
	<select id="getSubjectComponents" parameterClass="java.util.HashMap" resultMap="resultSubjects">
		select 
		sub.subject_id, 
		min(rgsub.report_subject_name) as subject_name, 
		min(mst.bookmark_name) as bookmark, 
		min(mst.component_name) as component_title
		from rg_caserpt_template_component cmp
		join RG_COMPONENT_RE_MAP cmap on cmap.component_id = cmp.component_id,
		CMS_SUBJECT sub, RG_SUBJECT rgsub, RG_COMPONENT_MASTER mst
		where 
		(sub.re_ids like ('%,' || cmap.research_type_id || ',%') or
		sub.re_ids like (cmap.research_type_id || ',%') or
		sub.re_ids like ('%,' || cmap.research_type_id)  or
    	sub.re_ids = ''||cmap.research_type_id)
		and sub.entity_type_id = cmp.component_level_id
		and cmp.case_id = #crn# and cmp.processcycleid = #processCycleId#
		and cmp.case_id = sub.crn and cmp.active_ind = 'Y' and rgsub.subject_id = sub.subject_id
		and cmp.component_id = mst.component_id
		group by cmp.caserpt_components_id, sub.subject_id, rgsub.report_order, rgsub.subject_name, sub.is_primary_sub 
		order by sub.is_primary_sub desc, rgsub.report_order, upper(rgsub.subject_name), sub.subject_id, cmp.caserpt_components_id
	</select>

</sqlMap>