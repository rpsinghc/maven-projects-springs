<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="AnnexureVO">

	<select id="canMarkDone" resultClass="java.lang.Boolean">
		select case when count(*) > 0 then 'true' else 'false' END
		from RG_ANNEXURES where case_id = #crn# and processcycleid = #processCycleId# and nvl(is_auto_saved,'N') != 'Y' and REPORT_COMPONENT_ID = #componentMasterId#
	</select>

	<resultMap id="result" class="com.worldcheck.juno.vo.component.AnnexureVO">
		<result property="crn" column="CASE_ID" />
		<result property="id" column="ANNEXURE_ID" />
		<result property="reportComponentID" column="REPORT_COMPONENT_ID" />
		<result property="name" column="ANNEXURE_NAME" />
		<result property="title" column="TITLE" />
		<result property="textBoxValue" column="ANNEXURE_TEXT" />
		<result property="userName" column="UPDATED_BY" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="processCycleId" column="PROCESSCYCLEID" />
		
	</resultMap>
	<!-- EMC History  -->
	<select id="getArticleText" resultClass="java.lang.String">
		select rg.ANNEXURE_TEXT
		from
		RG_ANNEXURES_HST rg where rg.history_id=#recordId#
	</select>

	<select id="getHistoryCount" resultClass="java.lang.Integer"
		parameterClass="java.util.HashMap">
		SELECT count(*)
		FROM
		RG_ANNEXURES_HST
		rg 
		WHERE rg.case_id=#crn#
		and rg.REPORT_COMPONENT_ID = #componentId#
		and rg.PROCESSCYCLEID=#processCycleId#
	</select>

	<resultMap id="resultHistory" class="com.worldcheck.juno.vo.component.AnnexureVO">
		<result property="id" column="HISTORY_ID" />
		<result property="name" column="ANNEXURE_NAME" />
		<result property="textBoxValue" column="ANNEXURE_TEXT" />
		<result property="userName" column="UPDATED_BY" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="processCycleId" column="PROCESSCYCLEID" />
	</resultMap>

	<select id="getHistory" resultMap="resultHistory"
		parameterClass="java.util.HashMap">
		SELECT * FROM (SELECT a.*, ROWNUM rn FROM (
		SELECT
		rg.History_id,rg.ANNEXURE_TEXT,rg.ANNEXURE_NAME,
		rg.UPDATED_BY,
		
		rg.UPDATED_ON, rg.PROCESSCYCLEID

		FROM RG_ANNEXURES_HST rg

		WHERE rg.case_id=#crn#
		and rg.REPORT_COMPONENT_ID = #componentId#
		and rg.PROCESSCYCLEID=#processCycleId#

		order by rg.UPDATED_ON desc
		) a WHERE
		ROWNUM <![CDATA[ <= ]]>
		#limit#) WHERE rn <![CDATA[ >= ]]>
		#start#
	</select>

	<insert id="insert" parameterClass="java.util.HashMap">
		 insert into RG_ANNEXURES
		(ANNEXURE_ID,CASE_ID,ANNEXURE_NAME,TITLE,ANNEXURE_TEXT,
		REPORT_COMPONENT_ID,UPDATED_ON,UPDATED_BY,IS_AUTO_SAVED, PROCESSCYCLEID)
		values
		(RG_ANNEXURES_SEQ.NEXTVAL,#vo.crn#,#vo.name#,#vo.title#,#vo.textBoxValue#,#componentId#,
		sysdate,#vo.userName#,#vo.isAutoSave#, #vo.processCycleId#)
	</insert>

	<insert id="insertHistory" parameterClass="java.util.HashMap">
		insert into
		RG_ANNEXURES_HST
		(HISTORY_ID,ANNEXURE_ID,CASE_ID,ANNEXURE_NAME,TITLE,ANNEXURE_TEXT,
		REPORT_COMPONENT_ID,UPDATED_ON,UPDATED_BY, PROCESSCYCLEID)
		(select
		RG_ANNEXURES_HST_SEQ.NEXTVAL,ANNEXURE_ID,CASE_ID,ANNEXURE_NAME,TITLE,ANNEXURE_TEXT,
		REPORT_COMPONENT_ID,UPDATED_ON,UPDATED_BY, PROCESSCYCLEID
		from RG_ANNEXURES
		where
		CASE_ID = #crn#
		AND PROCESSCYCLEID = #processCycleId#
		AND upper(IS_AUTO_SAVED)=upper('N')
		AND
		REPORT_COMPONENT_ID = #reportComponentID#

		)
	</insert>

	<update id="update" parameterClass="java.util.HashMap">
		update RG_ANNEXURES set
		TITLE
		= #vo.title#,
		ANNEXURE_TEXT = #vo.textBoxValue# ,
		UPDATED_ON = sysdate,
		UPDATED_BY = #vo.userName#
		where
		CASE_ID = #vo.crn# AND
		REPORT_COMPONENT_ID = #componentId# AND
		PROCESSCYCLEID = #vo.processCycleId# AND
		upper(IS_AUTO_SAVED)=upper('N')
	</update>
	
	<select id="findById" resultClass="java.lang.Integer">
		select count(ANNEXURE_ID)
		from RG_ANNEXURES WHERE ANNEXURE_ID=#id#
	</select>
	
<!-- queries for auto save -->

	<select id="getAutoSave" parameterClass="java.util.HashMap"
		resultMap="result">
		select
		ANNEXURE_ID,CASE_ID,ANNEXURE_NAME,TITLE,ANNEXURE_TEXT,
		REPORT_COMPONENT_ID,UPDATED_ON,UPDATED_BY, PROCESSCYCLEID
		from RG_ANNEXURES
		where
		CASE_ID = #crn#
		AND PROCESSCYCLEID = #processCycleId#
		AND REPORT_COMPONENT_ID = #componentId# 
		AND upper(IS_AUTO_SAVED)=upper('Y')
	</select>

    <update id="updateAutoSave" parameterClass="java.util.HashMap">

		update RG_ANNEXURES
		set
		TITLE = #vo.title#,
		ANNEXURE_TEXT = #vo.textBoxValue# ,
		UPDATED_ON = sysdate,
		UPDATED_BY = #vo.userName#
		where
		CASE_ID = #vo.crn# 
		AND PROCESSCYCLEID = #vo.processCycleId#
		AND REPORT_COMPONENT_ID = #componentId# 
		AND upper(IS_AUTO_SAVED)=upper('Y')
		
	</update>
	
    <insert id="insertAutoSave" parameterClass="java.util.HashMap">
		<selectKey keyProperty="autoSaveId" resultClass="long">
			SELECT
			RG_ANNEXURES_SEQ.NEXTVAL from dual
	    </selectKey>
		insert into RG_ANNEXURES (
		ANNEXURE_ID,CASE_ID,REPORT_COMPONENT_ID,UPDATED_ON,UPDATED_BY,IS_AUTO_SAVED,TITLE,ANNEXURE_TEXT,
		ANNEXURE_NAME,PROCESSCYCLEID
		)values (
	     #autoSaveId#,#vo.crn#,#vo.reportComponentID#,sysdate,#vo.userName#,'Y',#vo.title#,#vo.textBoxValue#,#vo.name#,
	     #vo.processCycleId# 
		)
	 </insert>
	  
	<select id="findAutoSave" parameterClass="java.util.HashMap"
		resultClass="java.lang.Long">
		SELECT ANNEXURE_ID
		FROM RG_ANNEXURES
		WHERE
		upper(IS_AUTO_SAVED)=upper('Y') 
		AND CASE_ID=#crn#
		AND PROCESSCYCLEID=#processCycleId# 
		AND REPORT_COMPONENT_ID=#componentId#
		
	</select>
	
	<delete id="deleteAutoSave" parameterClass="map">
		delete FROM
		RG_ANNEXURES WHERE
		CASE_ID=#crn# AND PROCESSCYCLEID=#processCycleId# 
		AND upper(IS_AUTO_SAVED)=upper('Y')
		AND REPORT_COMPONENT_ID=#componentId# 
	</delete>
	
	<!-- Remove the autosave ID -->
	<delete id="delete">
		delete FROM RG_ANNEXURES WHERE
		ANNEXURE_ID = #id#
	</delete>
		
	
	<select id="getByCrn" parameterClass="java.util.HashMap"
		resultMap="result">
		select
		ANNEXURE_ID,CASE_ID,ANNEXURE_NAME,TITLE,ANNEXURE_TEXT,
		REPORT_COMPONENT_ID,UPDATED_ON,UPDATED_BY, PROCESSCYCLEID
		from RG_ANNEXURES
		where
		CASE_ID = #crn#
		AND PROCESSCYCLEID = #processCycleId#
		AND upper(IS_AUTO_SAVED)=upper('N')
		AND REPORT_COMPONENT_ID = #componentId#
	</select>

	

	
	<!-- Get Static Value -->
	<resultMap id="resultStatic" class="com.worldcheck.juno.vo.component.AnnexureVO">
		<result property="textBoxValue" column="ANNEXURE_TEXT" />
		<result property="name" column="ANNEXURE_NAME" />
		<result property="title" column="ANNEXURE_TITLE" />
		<result property="isReadOnly" column="IS_READONLY" />
		<result property="reportComponentID" column="REPORT_COMPONENT_ID" />
	</resultMap>

	<select id="getStaticData" resultMap="resultStatic"
		parameterClass="long">
		select
		ANNEXURE_TEXT,ANNEXURE_NAME,ANNEXURE_TITLE,REPORT_COMPONENT_ID,IS_READONLY
		from RG_ANNEXURES_STATIC
		where REPORT_COMPONENT_ID =
		#componentId#
	</select>

	<select id="getAnnexureName" resultClass="java.lang.String"
		parameterClass="int">
		select ci.COMPONENT_DESC from RG_COMPONENT_INFO ci
		,RG_REPORT_COMPONENTS rc
		where ci.COMPONENT_ID = rc.REPORT_COMPONENT_ID
		and rc.REPORT_COMPONENT_ID = #reportComponentID#
	</select>

	<!-- Mark Done for Annexure Component -->
	<parameterMap id="getParameterMap" class="java.util.Map">

		<parameter property="crn" jdbcType="VARCHAR" javaType="java.lang.String"
			mode="IN" />
		<parameter property="componentName" jdbcType="VARCHAR"
			javaType="java.lang.String" mode="IN" />
		<parameter property="errorCode" jdbcType="INTEGER" javaType="java.lang.Integer"
			mode="OUT" />

	</parameterMap>


	<!--- Calling stored procedure -->
	<procedure id="callMarkDone" parameterMap="getParameterMap">

		{ call
		RG_PROC_MARK_DONE(?,?,?)} 
	</procedure>

	<select id="getPastData" resultClass="java.lang.String" parameterClass="map">
		select
		rg.ANNEXURE_TEXT
		from
		RG_ANNEXURES rg where
		rg.CASE_ID=#crn# AND rg.PROCESSCYCLEID=#processCycleId# and
		rg.REPORT_COMPONENT_ID = #componentId#
		AND rg.is_auto_saved='N'
	</select>
	
	
	<resultMap id="miniRecord"
		class="com.worldcheck.juno.vo.component.AnnexureVO"
		groupBy="id">
		<result property="id" column="ANNEXURE_ID" />
		<result property="updateOn" column="UPDATED_ON" />
	</resultMap>

	<select id="getUpdationTimeById" resultMap="miniRecord" parameterClass="map">
		SELECT
		rg.ANNEXURE_ID,
		rg.UPDATED_ON
		FROM RG_ANNEXURES rg
		WHERE
		rg.CASE_ID=#crn# AND rg.PROCESSCYCLEID=#processCycleId# and rg.REPORT_COMPONENT_ID=#componentId# and rg.IS_AUTO_SAVED = 'N'
	</select>
	
	
	<select id="getMaxTime" parameterClass="java.util.HashMap"
		resultClass="java.util.Date">
		select nvl(max(UPDATED_ON),sysdate) from RG_ANNEXURES rg where
		rg.case_id=#crn#
		and rg.IS_AUTO_SAVED = 'N'AND rg.PROCESSCYCLEID=#processCycleId# and rg.REPORT_COMPONENT_ID=#componentId#
	</select>

</sqlMap>