<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BusinessComponentVO">

	<resultMap id="result"
		class="com.worldcheck.juno.vo.component.BusinessComponentVO">
		<result property="id" column="BUSINESS_SUMMARY_ID" />
		<result property="crn" column="CASE_ID" />
		<result property="processCycleName" column="DESCRIPTION" />
		<result property="subjectName" column="SUBJECT_NAME" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="userName" column="UPDATED_BY" />
		<result property="subjectId" column="SUBJECT_ID" />
		<result property="processCycleId" column="PROCESSCYCLEID" />
		

	</resultMap>


	<resultMap id="formResult"
		class="com.worldcheck.juno.vo.component.BusinessComponentVO">
		<result property="id" column="BUSINESS_SUMMARY_ID" />
		<result property="crn" column="CASE_ID" />
		<result property="processCycleName" column="DESCRIPTION" />
		<result property="subjectName" column="SUBJECT_NAME" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="updateBy" column="UPDATED_BY" />
		<result property="subjectId" column="SUBJECT_ID" />
		<result property="processCycleId" column="PROCESSCYCLEID" />
		<result property="tableBottomNotes" column="TABLE_BOTTOM_NOTES" />
		<result property="title" column="TITLE" />
		
	</resultMap>



	<resultMap id="resultHistory"
		class="com.worldcheck.juno.vo.component.BusinessComponentVO">
		<result property="tableBottomNotes" column="TABLE_BOTTOM_NOTES" />
		<result property="userName" column="UPDATED_BY" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="processCycleName" column="DESCRIPTION" />
		<result property="id" column="HISTORY_ID" />
	</resultMap>




	<resultMap id="resultVO"
		class="com.worldcheck.juno.vo.component.BusinessComponentVO">
		<result property="id" column="BUSINESS_SUMMARY_ID" />
		<result property="crn" column="CASE_ID" />
		<result property="processCycleName" column="DESCRIPTION" />
		<result property="subjectName" column="SUBJECT_NAME" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="userName" column="UPDATED_BY" />
		<result property="subjectId" column="SUBJECT_ID" />
		<result property="processCycleId" column="PROCESSCYCLEID" />
		<result property="tableBottomNotes" column="TABLE_BOTTOM_NOTES" />
		<result property="title" column="TITLE" />


	</resultMap>


<resultMap id="miniBusinessRecord" 
				 class="com.worldcheck.juno.vo.component.BusinessComponentVO" groupBy="id">
		<result property="id" column="BUSINESS_SUMMARY_ID" />
		<result property="updateOn" column="UPDATED_ON" />
	</resultMap>
	
	<!-- Insert example, using the Account parameter class -->
	<insert id="insert"
		parameterClass="com.worldcheck.juno.vo.component.BusinessComponentVO">
		<selectKey keyProperty="id" resultClass="long">
			SELECT
			RG_BUSINESS_SUMMARY_SEQ.NEXTVAL from dual
		</selectKey>
		INSERT INTO
		RG_BUSINESS_SUMMARY
		(BUSINESS_SUMMARY_ID,SUBJECT_ID,PROCESSCYCLEID,CASE_ID,TITLE,
		UPDATED_ON,UPDATED_BY,TABLE_BOTTOM_NOTES,IS_AUTO_SAVED)
		VALUES
		(#id#,#subjectId#,#processCycleId#,#crn#,#title#,sysdate,#updateBy#,#tableBottomNotes#,'N')
	</insert>

	<select id="listByCRN" resultMap="result" parameterClass="java.util.HashMap">

		SELECT * FROM (SELECT a.*, ROWNUM rn FROM (SELECT
		rbs.BUSINESS_SUMMARY_ID,rbs.SUBJECT_ID,rbs.PROCESSCYCLEID,rbs.CASE_ID,
		rbs.UPDATED_ON,
		NVL(rbs.UPDATED_BY,'System') UPDATED_BY,
		cms.REPORT_SUBJECT_NAME SUBJECT_NAME,cmscase.DESCRIPTION
		FROM RG_BUSINESS_SUMMARY rbs,RG_SUBJECT cms,CMS_CASECYCLE cmscase
		WHERE cms.SUBJECT_ID=rbs.SUBJECT_ID ANd
		rbs.PROCESSCYCLEID=cmscase.CASECYCLE_ID
		ANd CASE_ID=#crn# AND
		upper(IS_AUTO_SAVED)=upper('N')


		<isNotNull property="subjectId">
			<isNotEqual prepend="AND" property="subjectId"
				compareValue="0">
				rbs.SUBJECT_ID=#subjectId# 
			</isNotEqual>
		</isNotNull>

		<isNotNull property="processCycleId">
			<isNotEqual prepend="AND" property="processCycleId"
				compareValue="0">
				rbs.PROCESSCYCLEID=#processCycleId# 
			</isNotEqual>
		</isNotNull>

		order by cms.is_primary_sub desc,cms.REPORT_ORDER asc,upper(cms.REPORT_SUBJECT_NAME) asc,cmscase.processcycle_order desc
		) a WHERE
		ROWNUM <![CDATA[ <= ]]>
		#limit#) WHERE rn <![CDATA[ >= ]]>
		#start#

	</select>

	<select id="getById" resultMap="formResult">

		SELECT
		rbs.BUSINESS_SUMMARY_ID,rbs.SUBJECT_ID,rbs.PROCESSCYCLEID,rbs.CASE_ID,
		rbs.UPDATED_ON,rbs.UPDATED_BY, rbs.TITLE,rbs.TABLE_BOTTOM_NOTES,
		cms.REPORT_SUBJECT_NAME SUBJECT_NAME,cmscase.DESCRIPTION

		FROM RG_BUSINESS_SUMMARY
		rbs,RG_SUBJECT cms,CMS_CASECYCLE cmscase
		WHERE
		cms.SUBJECT_ID=rbs.SUBJECT_ID ANd
		rbs.PROCESSCYCLEID=cmscase.CASECYCLE_ID
		AND rbs.BUSINESS_SUMMARY_ID
		=#id# 

	</select>


	<select id="getProcessList" resultClass="java.lang.Integer"
		parameterClass="java.util.HashMap">
		SELECT PROCESSCYCLEID FROM RG_BUSINESS_SUMMARY
		WHERE
		SUBJECT_ID=#subId#
		AND CASE_ID=#crn# AND
		upper(IS_AUTO_SAVED)=upper('N')
    </select>

	<!--
		<insert id="inserthistory" parameterClass="java.util.HashMap"> insert
		into RG_BUSINESS_SUMMARY_HST(HISTORY_ID , BUSINESS_SUMMARY_ID ,
		PROCESSCYCLEID , CASE_ID , TITLE , UPDATED_ON , UPDATED_BY ,
		TABLE_BOTTOM_NOTES , SUBJECT_ID) select
		RG_BUSINESS_SUMMARY_HST_SEQ.nextval, BUSINESS_SUMMARY_ID,
		PROCESSCYCLEID PROCESSCYCLEID , CASE_ID,TITLE , UPDATED_ON,
		UPDATED_BY, TABLE_BOTTOM_NOTES,SUBJECT_ID from RG_BUSINESS_SUMMARY
		where case_id =#crn# and SUBJECT_ID = #subId# AND
		upper(IS_AUTO_SAVED)=upper('N') </insert>
	-->


	<insert id="insertHistory"
		parameterClass="com.worldcheck.juno.vo.component.BusinessComponentVO">
		insert into RG_BUSINESS_SUMMARY_HST(HISTORY_ID ,
		BUSINESS_SUMMARY_ID ,SUBJECT_ID,
		PROCESSCYCLEID ,
		CASE_ID ,
		TITLE ,
		UPDATED_ON ,
		UPDATED_BY ,
		TABLE_BOTTOM_NOTES
		)
		VALUES
		(RG_BUSINESS_SUMMARY_HST_SEQ.nextval,#id#,#subjectId#,#processCycleId#,#crn#,#title#,sysdate,#updateBy#,#tableBottomNotes#)

	</insert>


	<update id="updateAutoSave"
		parameterClass="com.worldcheck.juno.vo.component.BusinessComponentVO">
		update RG_BUSINESS_SUMMARY set
		TITLE = #title#,
		TABLE_BOTTOM_NOTES=#tableBottomNotes# ,
		PROCESSCYCLEID=#processCycleId# ,
		UPDATED_ON=sysdate
		where
		BUSINESS_SUMMARY_ID=#autoSaveId#

		AND upper(IS_AUTO_SAVED)=upper('Y')
	</update>



	<update id="update"
		parameterClass="com.worldcheck.juno.vo.component.BusinessComponentVO">
		update RG_BUSINESS_SUMMARY set
		TITLE = #title#,
		TABLE_BOTTOM_NOTES=#tableBottomNotes# ,
		PROCESSCYCLEID=#processCycleId# ,
		UPDATED_ON=sysdate,UPDATED_BY=#updateBy#
		where
		BUSINESS_SUMMARY_ID =#id# AND
		upper(IS_AUTO_SAVED)=upper('N')
	  </update>



	<select id="getHistory" resultMap="resultHistory"
		parameterClass="java.util.HashMap">

		SELECT * FROM (SELECT a.*, ROWNUM rn FROM (SELECT rghst.UPDATED_ON,
		rghst.HISTORY_ID,
		rghst.UPDATED_BY, 
		NVL(rghst.TABLE_BOTTOM_NOTES,' ')
		TABLE_BOTTOM_NOTES,cmscase.DESCRIPTION
		FROM
		RG_BUSINESS_SUMMARY_HST
		rghst, cms_casecycle cmscase
		WHERE BUSINESS_SUMMARY_ID=#recordId#
		AND cmscase.casecycle_id= rghst.processcycleid

		order by rghst.UPDATED_ON desc

		) a WHERE ROWNUM <![CDATA[ <= ]]>
		#limit#) WHERE rn <![CDATA[ >= ]]>
		#start#

	</select>

	<delete id="deleteId">
		delete FROM RG_BUSINESS_SUMMARY WHERE
		BUSINESS_SUMMARY_ID in (#id#)
		

	</delete>


	<!--generic query-->
	<delete id="deleteNewAutoSave">
		delete FROM RG_BUSINESS_SUMMARY WHERE
		CASE_ID=#crn#
		AND
		upper(IS_AUTO_SAVED)=upper('Y') AND
		PARENT_RECORD_ID IS NULL
	</delete>

	<!--generic query-->
	<delete id="deleteAutoSave">
		delete FROM RG_BUSINESS_SUMMARY
		where CASE_ID=#crn#
		AND
		upper(IS_AUTO_SAVED)=upper('Y') AND
		PARENT_RECORD_ID = #parentId#
	</delete>

	<!--generic query-->
	<select id="findAutoSave" parameterClass="java.util.HashMap"
		resultClass="java.lang.Long">
		SELECT rg.BUSINESS_SUMMARY_ID
		FROM RG_BUSINESS_SUMMARY rg
		WHERE
		upper(rg.IS_AUTO_SAVED)=upper('Y') AND
		rg.PARENT_RECORD_ID =
		#parentId#
	</select>

	<!--generic query-->
	<select id="findNewAutoSave" parameterClass="java.util.HashMap"
		resultClass="java.lang.Long">
		SELECT rg.BUSINESS_SUMMARY_ID
		FROM RG_BUSINESS_SUMMARY rg
		WHERE CASE_ID=#crn# AND
		upper(rg.IS_AUTO_SAVED)=upper('Y') AND
		PARENT_RECORD_ID IS NULL
	</select>


	<!--generic query-->
	<select id="findById" resultClass="int">
		select
		count(rg.BUSINESS_SUMMARY_ID)
		FROM RG_BUSINESS_SUMMARY rg
		WHERE
		rg.BUSINESS_SUMMARY_ID = #id#
	</select>

	<!--generic query-->
	<delete id="delete">
		delete FROM RG_BUSINESS_SUMMARY WHERE
		BUSINESS_SUMMARY_ID = #id#
	</delete>

	<!--generic query-->
	<delete id="deleteIds" parameterClass="java.util.HashMap">
		delete FROM RG_BUSINESS_SUMMARY WHERE
		BUSINESS_SUMMARY_ID IN

		<iterate property="ids" open="(" close=")" conjunction=",">
			#ids[]#
	    </iterate>
	</delete>



	<update id="insertDefaultEntries" parameterClass="java.util.HashMap">

		declare
		recordId number(10);
		hstId number(10);
		subList varray_varchar;
		subId number;
		crn VARCHAR2(200):=#crn#;
		processCycle
		number:=#processCycleId#;
		
		userName VARCHAR2(200):=#userName#;


		begin
		subList:= varray_varchar
		<iterate property="ids" open="(" close=")" conjunction=",">
			#ids[].subjectId#
				 </iterate>
		;
		for elem in 1 .. subList.count
		loop
		subId:=subList(elem);
		dbms_output.put_line(subId);
		select RG_BUSINESS_SUMMARY_SEQ.NEXTVAL
		into recordId from dual;
		<!--  select RG_BUSINESS_SUMMARY_HST_SEQ.nextval
		into hstId from dual;-->
		INSERT INTO RG_BUSINESS_SUMMARY
		(BUSINESS_SUMMARY_ID,SUBJECT_ID,PROCESSCYCLEID,CASE_ID,TABLE_BOTTOM_NOTES,TITLE,
		UPDATED_ON,UPDATED_BY)

		values(recordId, subId , processCycle , crn,(select DEFAULT_TEXT from rg_component_default_text where component_id=22),'Business'
		,sysdate,userName);

		<!--INSERT INTO RG_BUSINESS_SUMMARY_HST
		(HISTORY_ID,BUSINESS_SUMMARY_ID,SUBJECT_ID,PROCESSCYCLEID,CASE_ID,
		UPDATED_ON,UPDATED_BY)values( hstId, recordId, subId , processCycle ,
		crn ,sysdate,userName);-->


		end loop;

		END;
	</update>

	<select id="getHistoryCountForCRN" resultClass="java.lang.Long"
		parameterClass="java.lang.String">
		select count(*) from (
		select case_id from RG_BUSINESS_SUMMARY where
		case_id=#crn#
		union
		select case_id from RG_BUSINESS_SUMMARY_HST where
		case_id=#crn#
		)
  
  </select>


	<select id="getSearchCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">

		SELECT
		count(*)
		FROM RG_BUSINESS_SUMMARY rbs,RG_SUBJECT
		cms,CMS_CASECYCLE cmscase
		WHERE cms.SUBJECT_ID=rbs.SUBJECT_ID ANd
		rbs.PROCESSCYCLEID=cmscase.CASECYCLE_ID
		ANd CASE_ID=#crn# AND
		upper(IS_AUTO_SAVED)=upper('N')

		<isNotNull property="subjectId">
			<isNotEqual prepend="AND" property="subjectId"
				compareValue="0">
				rbs.SUBJECT_ID=#subjectId# 
			</isNotEqual>
		</isNotNull>

		<isNotNull property="processCycleId">
			<isNotEqual prepend="AND" property="processCycleId"
				compareValue="0">
				rbs.PROCESSCYCLEID=#processCycleId# 
			</isNotEqual>
		</isNotNull>

	</select>

	<select id="getHistoryCount" resultClass="java.lang.Integer">
		SELECT count(*)
		FROM
		RG_BUSINESS_SUMMARY_HST
		rg where
		rg.BUSINESS_SUMMARY_ID=#recordId#


	</select>



	<insert id="insertAutoSave"
		parameterClass="com.worldcheck.juno.vo.component.BusinessComponentVO">
		<selectKey keyProperty="autoSaveId" resultClass="long">
			SELECT
			RG_BUSINESS_SUMMARY_SEQ.NEXTVAL from dual
		</selectKey>
		INSERT INTO RG_BUSINESS_SUMMARY
		(BUSINESS_SUMMARY_ID,SUBJECT_ID,PROCESSCYCLEID,CASE_ID,TITLE,
		UPDATED_ON,UPDATED_BY,TABLE_BOTTOM_NOTES,IS_AUTO_SAVED,PARENT_RECORD_ID)
		VALUES
		(#autoSaveId#,#subjectId#,#processCycleId#,#crn#,#title#,sysdate,#updateBy#,#tableBottomNotes#,'Y',#id#)


	</insert>


	<!--generic query-->
	<select id="getSubProcCycleList" resultMap="ReportSubjectVO.subProcCycleList">
		select rem.subject_id
		subject_id,
		rem.processcycleid Process_Cycle_Id,cs.subject_name
		subject_name,
		ccl.DESCRIPTION Process_Cycle
		from RG_BUSINESS_SUMMARY rem,
		RG_SUBJECT cs ,CMS_CASECYCLE ccl
		where cs.CRN = rem.case_id
		and
		ccl.CASECYCLE_ID= rem.processcycleid
		and cs.subject_id =rem.subject_id
		and rem.case_id = #crn#
    	and rem.is_auto_saved = 'N'
		order by cs.subject_id, rem.processcycleid
	</select>


	<select id="getProcessCycleList" parameterClass="java.util.HashMap"
		resultMap="ProcessCycleVO.processCycleList">
		select rem.processcycleid Process_Cycle_Id,cc.DESCRIPTION
		Process_Cycle
		from RG_BUSINESS_SUMMARY rem, cms_casecycle cc
		where rem.subject_id=#subId# and rem.case_id=#crn#
		and cc.casecycle_id= rem.processcycleid
		and upper(rem.IS_AUTO_SAVED)=upper('N')
		 and rem.BUSINESS_SUMMARY_ID != #recordId#
		<!--  select 'Interim 1' Process_Cycle , 2 Process_Cycle_Id from
		cms_clientcase cc
		where cc.CLIENT_INT_DUEDATE1 is not null
		AND
		NOT EXISTS
		(select
		summarry.BUSINESS_SUMMARY_ID from RG_BUSINESS_SUMMARY summarry
		where summarry.BUSINESS_SUMMARY_ID != #recordId# and
		summarry.subject_id = #subId#
		and summarry.processcycleid = 2 and
		upper(summarry.IS_AUTO_SAVED)=upper('N'))
		and cc.crn = #crn#
		UNION ALL
		select 'Interim 2' Process_Cycle, 3 Process_Cycle_Id from
		cms_clientcase cc
		where cc.CLIENT_INT_DUEDATE2 is not null
		AND
		NOT EXISTS
		(select summarry.BUSINESS_SUMMARY_ID from RG_BUSINESS_SUMMARY summarry
		where summarry.BUSINESS_SUMMARY_ID != #recordId# and
		summarry.subject_id = #subId#
		and summarry.processcycleid = 3 and
		upper(summarry.IS_AUTO_SAVED)=upper('N'))
		and cc.crn = #crn#
		UNION ALL
		select 'Final' Process_Cycle, 1 Process_Cycle_Id from cms_clientcase
		cc
		where cc.FINAL_DUE_DATE is not null
		AND
		NOT EXISTS
		(select
		summarry.BUSINESS_SUMMARY_ID from RG_BUSINESS_SUMMARY summarry
		where
		summarry.BUSINESS_SUMMARY_ID != #recordId# and summarry.subject_id =
		#subId#
		and summarry.processcycleid = 1 and
		upper(summarry.IS_AUTO_SAVED)=upper('N'))
		and cc.crn = #crn# order by
		process_cycle_id-->
</select>

	<insert id="makeCopy"
		parameterClass="java.util.HashMap">

		<selectKey keyProperty="id" resultClass="long">
			SELECT
			RG_BUSINESS_SUMMARY_SEQ.NEXTVAL from dual
		</selectKey>

		INSERT INTO RG_BUSINESS_SUMMARY
		(BUSINESS_SUMMARY_ID,SUBJECT_ID,PROCESSCYCLEID,CASE_ID,TITLE,
		UPDATED_ON,UPDATED_BY,TABLE_BOTTOM_NOTES)

		select
		#id#, SUBJECT_ID,#processCycleId#,CASE_ID,TITLE,
		sysdate,#userName#,TABLE_BOTTOM_NOTES from RG_BUSINESS_SUMMARY
		where BUSINESS_SUMMARY_ID=#recordId#
	</insert>
	
	<select id="checkIfExist" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
	select count(*) from RG_BUSINESS_SUMMARY where PROCESSCYCLEID=#processCycleId# and SUBJECT_ID = #subjectId#  and
		case_id=#crn# and upper(IS_AUTO_SAVED)=upper('N')
	</select>
	
	
	<insert id="makeCopyHst"
		parameterClass="java.util.HashMap">

		insert into RG_BUSINESS_SUMMARY_HST(HISTORY_ID ,
		BUSINESS_SUMMARY_ID ,SUBJECT_ID,
		PROCESSCYCLEID ,
		CASE_ID ,
		TITLE ,
		UPDATED_ON ,
		UPDATED_BY ,
		TABLE_BOTTOM_NOTES
		)

		select
		RG_BUSINESS_SUMMARY_HST_SEQ.nextval,#recordId#, SUBJECT_ID,PROCESSCYCLEID,CASE_ID,TITLE,
		sysdate,UPDATED_BY,TABLE_BOTTOM_NOTES from RG_BUSINESS_SUMMARY
		where BUSINESS_SUMMARY_ID=#recordId#
	</insert>
	
	<select id="getArticleText" resultClass="java.lang.String">
		select TABLE_BOTTOM_NOTES from
		RG_BUSINESS_SUMMARY_HST where history_id=#recordId#
	</select>
	
	<select id="getUpdationTimeById" resultMap="miniBusinessRecord">
		SELECT rg.BUSINESS_SUMMARY_ID,
		rg.UPDATED_ON
		FROM RG_BUSINESS_SUMMARY rg
		WHERE
		rg.BUSINESS_SUMMARY_ID = #id#
	</select>
	
	<insert id="insertHistoryBeforeDeletion" parameterClass="map">
	insert into RG_BUSINESS_SUMMARY_HST(HISTORY_ID ,
		BUSINESS_SUMMARY_ID ,SUBJECT_ID,
		PROCESSCYCLEID ,
		CASE_ID ,
		TITLE ,
		UPDATED_ON ,
		UPDATED_BY ,
		TABLE_BOTTOM_NOTES
		)
		 SELECT
		RG_BUSINESS_SUMMARY_HST_SEQ.nextval,inner_view.*
		FROM
		<iterate property="recList" conjunction="UNION ALL" open="("
			close=")">
			 (SELECT #recList[]# BUSINESS_SUMMARY_ID ,SUBJECT_ID,
				PROCESSCYCLEID ,
				CASE_ID ,
				TITLE ,sysdate,#userName# UPDATED_BY ,TABLE_BOTTOM_NOTES
			  from RG_BUSINESS_SUMMARY  
   			 where BUSINESS_SUMMARY_ID=#recList[]#)			
		</iterate>
		inner_view
  
	</insert>
</sqlMap>
