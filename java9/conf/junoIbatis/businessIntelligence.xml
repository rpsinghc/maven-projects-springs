<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BusinessIntelligenceVO">
	<!-- start added by pradeep -->
	
	<resultMap id="result"
		class="com.worldcheck.juno.vo.component.BusinessIntelligenceVO">
		<result property="id" column="BUS_INT_ID" />
		<result property="crn" column="case_id" />
		<result property="processCycleName" column="DESCRIPTION" />
		<result property="updateBy" column="UPDATED_BY" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="processCycleId" column="processcycleid" />
	</resultMap>
	
	<resultMap id="formResult" class="com.worldcheck.juno.vo.component.BusinessIntelligenceVO">
		<result property="id" column="BUS_INT_ID" />
		<result property="crn" column="CASE_ID" />
		<result property="processCycleName" column="DESCRIPTION" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="updateBy" column="UPDATED_BY" />
		<result property="processCycleId" column="PROCESSCYCLEID" />
		<result property="tableNote" column="TABLE_BOTTOM_NOTES" />
	</resultMap>
	
	<resultMap id="resultHistory" class="com.worldcheck.juno.vo.component.BusinessIntelligenceVO">
		<result property="tableNote" column="TABLE_BOTTOM_NOTES" />
		<result property="updateOn" column="UPDATED_ON" />
		<result property="updateBy" column="UPDATED_BY" />
		<result property="id" column="HISTORY_ID" />
	</resultMap>
	
	<!-- end added by pradeep -->
	
	<!-- added by pradeep -->
	
	<select id="listByCRN" resultMap="result" parameterClass="java.util.HashMap">
		SELECT bs.BUS_INT_ID, 
				bs.case_id, 
				bs.processcycleid, 
				NVL(bs.UPDATED_BY,'System') UPDATED_BY,
				bs.updated_on, 
				cc.description
    	FROM rg_business_int bs 
    			INNER JOIN cms_casecycle cc 
    			ON bs.processcycleid = cc.casecycle_id  
    	where 
   			bs.CASE_ID=#crn# 
   			AND bs.IS_AUTO_SAVED =('N') 
   			order by cc.processcycle_order desc
	</select>
	
	
	<update id="insertDefaultEntries" parameterClass="java.util.HashMap">

		declare
			recordId number(10);
			hstId number(10);
			processList
			varray_varchar;
			processId number;
			crn VARCHAR2(200):=#crn#;
			userName VARCHAR2(200):=#userName#;
		begin
			processList:= varray_varchar
			<iterate property="ids" open="(" close=")" conjunction=",">
				#ids[].id#
			</iterate>;
			for elem in 1 .. processList.count
			loop
				processId:=processList(elem);
				select RG_BUSINESS_INT_SEQ.NEXTVAL into recordId from dual;
				insert into
				rg_business_int (
					BUS_INT_ID,CASE_ID,PROCESSCYCLEID,UPDATED_ON,UPDATED_BY,TABLE_BOTTOM_NOTES
				)
				values(recordId,crn ,processId,sysdate,userName,(select DEFAULT_TEXT from rg_component_default_text where component_id=29) );
			end loop;
			commit;
		END;
	</update>
	<select id="getSearchCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">

		SELECT count(*)	FROM
			rg_business_int res, CMS_CASECYCLE cmscase
		WHERE
			res.PROCESSCYCLEID=cmscase.CASECYCLE_ID
			and	res.CASE_ID=#crn# AND upper(res.IS_AUTO_SAVED)=upper('N')
		
	</select>
	
	<select id="getHistoryCountForCRN" resultClass="java.lang.Long"	parameterClass="java.lang.String">
		    select count(*) from (
		select case_id from rg_business_int where
		case_id=#crn#
		union
		select case_id from rg_business_int_hst where
		case_id=#crn#
		)
    </select>
    
    <select id="findAutoSave" parameterClass="java.util.HashMap"
		resultClass="java.lang.Long">
		SELECT rg.BUS_INT_ID
			FROM rg_business_int rg
			WHERE upper(rg.IS_AUTO_SAVED)=upper('Y') AND rg.PARENT_RECORD_ID = #parentId#
	</select>
	
	
	
	
	<select id="getById" resultMap="formResult">
		SELECT bi.bus_int_id, bi.PROCESSCYCLEID, bi.CASE_ID,
			bi.UPDATED_ON, bi.UPDATED_BY, bi.table_bottom_notes,
			cmscase.DESCRIPTION
		FROM 
			rg_business_int bi, CMS_CASECYCLE cmscase
		WHERE
			bi.PROCESSCYCLEID = cmscase.CASECYCLE_ID AND bi.bus_int_id = #id#
	</select>
	<!-- Get Update record By Id -->
	<resultMap id="miniRecord"
		class="com.worldcheck.juno.vo.component.ExecutiveSummaryVO"
		groupBy="id">
		<result property="id" column="bus_int_id" />
		<result property="updateOn" column="UPDATED_ON" />
	</resultMap>
	<select id="getUpdationTimeById" resultMap="miniRecord">
		SELECT
			bi.bus_int_id,
			bi.UPDATED_ON
		FROM rg_business_int bi
		WHERE
			bi.bus_int_id = #id#
	</select>
	
	<update id="update"
		parameterClass="com.worldcheck.juno.vo.component.BusinessIntelligenceVO">
		update RG_BUSINESS_INT 
			set	TABLE_BOTTOM_NOTES = #tableNote#,
			UPDATED_ON = sysdate,
			UPDATED_BY=#updateBy#
		where
			bus_int_id  = #id#
			and upper(IS_AUTO_SAVED)=upper('N')
	</update>
	
	<delete id="deleteAutoSave">
		delete FROM RG_BUSINESS_INT
		where CASE_ID=#crn#
			AND	upper(IS_AUTO_SAVED)= upper('Y') 
			AND	PARENT_RECORD_ID = #parentId#
	</delete>
	
	<insert id="insertHistory" parameterClass="com.worldcheck.juno.vo.component.BusinessIntelligenceVO">
		insert into	rg_business_int_hst(
			HISTORY_ID ,
			CASE_ID,
			PROCESSCYCLEID,
			TABLE_BOTTOM_NOTES,
			UPDATED_ON,
			UPDATED_BY,
			bus_int_id)
		values(
			RG_BUSINESS_INT_HST_SEQ.NEXTVAL,
			#crn#,
			#processCycleId#,
			#tableNote#,
			sysdate,
			#updateBy#,
			#id#
		)  
    </insert>
    <!-- get history for the business intelligence -->
    <select id="getHistory" resultMap="resultHistory" parameterClass="java.util.HashMap">
		SELECT * FROM (SELECT a.*, ROWNUM rn FROM (SELECT UPDATED_ON,
			rghst.UPDATED_BY,
			TABLE_BOTTOM_NOTES ,HISTORY_ID
		FROM
			rg_business_int_hst rghst
		WHERE 
			bus_int_id =#recordId#
			order by UPDATED_ON desc

		) a WHERE ROWNUM <![CDATA[ <= ]]>
		#limit#) WHERE rn <![CDATA[ >= ]]>
		#start#

	</select>
	<!-- insert & update auto save starts -->
	<insert id="insertAutoSave" parameterClass="com.worldcheck.juno.vo.component.BusinessIntelligenceVO">
		<selectKey keyProperty="autoSaveId" resultClass="long">
			SELECT RG_BUSINESS_INT_SEQ.NEXTVAL from dual
		</selectKey>
		insert into RG_BUSINESS_INT (
			bus_int_id,
			CASE_ID,
			PROCESSCYCLEID,
			TABLE_BOTTOM_NOTES,
			UPDATED_ON,
			UPDATED_BY,
			IS_AUTO_SAVED,
			PARENT_RECORD_ID
		)values(
			#autoSaveId#,
			#crn#,
			#processCycleId#,
			#tableNote#,
			sysdate,
			#updateBy#,
			'Y',
			#id#
		)
	</insert>
	<update id="updateAutoSave" parameterClass="com.worldcheck.juno.vo.component.BusinessIntelligenceVO">
		update RG_BUSINESS_INT
			set
				TABLE_BOTTOM_NOTES = #tableNote#,
				UPDATED_ON=sysdate,
				UPDATED_BY=#updateBy#
			where
				bus_int_id = #autoSaveId#
				AND upper(IS_AUTO_SAVED)=upper('Y')
	</update>
	<!-- insert & update auto save ends -->	
	<delete id="delete">
		delete 
			FROM RG_BUSINESS_INT 
		WHERE
			bus_int_id = #id#
	</delete>	
	
	<select id="getHistoryCount" resultClass="java.lang.Integer">
		SELECT count(*)
		FROM
			RG_BUSINESS_INT_HST bih 
		where
			bih.bus_int_id = #recordId#
	</select>
	<select id="getArticleText" resultClass="java.lang.String">
		select TABLE_BOTTOM_NOTES
		from
			RG_BUSINESS_INT_HST 
		where history_id=#recordId#
	</select>
	
	<select id="getProcessCycleList" parameterClass="java.util.HashMap"	resultMap="ProcessCycleVO.processCycleList">
		select bi.processcycleid Process_Cycle_Id,
				cc.DESCRIPTION Process_Cycle
		from 
			RG_BUSINESS_INT bi, cms_casecycle cc
		where
		 	bi.case_id = #crn#
			and cc.casecycle_id = bi.processcycleid
			and upper(bi.IS_AUTO_SAVED) = upper('N')
	</select>
		
</sqlMap>
