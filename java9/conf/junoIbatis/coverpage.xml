<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="CoverPageVO">
	<!--generic query-->
	<insert id="insert" parameterClass="com.worldcheck.juno.vo.component.CoverPageVO">
		<selectKey keyProperty="id" resultClass="long">
			SELECT
			RG_COVERPAGE_SEQ.NEXTVAL from dual
	  </selectKey>
		insert into RG_COVERPAGE (
		COVERPAGE_ID,
		CASE_ID,
		PROCESSCYCLEID,
		PRIMARY_SUB,
		PRIMARY_SUB_SUBJECT_ID,
		COVERPAGE_DATE,
		UPDATED_ON,
		UPDATED_BY

		)values (
		#id#,
		#crn#,
		#processCycleId#,
		#priSubLocalName#,
		#priSub1Id#,
		to_date(#cpDate#,'DD-MM-YYYY'),
		sysdate,
		#updateBy#
		)
	</insert>
	<update id="update" parameterClass="com.worldcheck.juno.vo.component.CoverPageVO">
		update RG_COVERPAGE set
		PRIMARY_SUB = #priSubLocalName#,
		PRIMARY_SUB_SUBJECT_ID = #priSub1Id#,
		COVERPAGE_DATE = to_date(#cpDate#,'DD-MM-YYYY'),
		UPDATED_ON = sysdate,
		UPDATED_BY = #updateBy#
		where
		COVERPAGE_ID = #id#
	  </update>

	<update id="insertReportSubjectNames" parameterClass="com.worldcheck.juno.vo.common.ReportSubjectVO">
		update
		RG_SUBJECT set
		REPORT_ORDER =#junoOrder#,
		REPORT_SUBJECT_NAME=#reportSubjectName#,
		LOCAL_LANGUAGE_NAME=#localLanguageName#,
		SUBJECT_NAME=#cmsSubjectName#
		where SUBJECT_ID=#subjectId#
	</update>
	<resultMap id="result" class="com.worldcheck.juno.vo.component.CoverPageVO">
		<result property="id" column="COVERPAGE_ID" />
		<result property="crn" column="CASE_ID" />
		<result property="priSubLocalName" column="PRIMARY_SUB" />
		<result property="priSub1Id" column="PRIMARY_SUB_SUBJECT_ID" />
		<result property="cpDate" column="sdate" />
		<result property="processCycleId" column="PROCESSCYCLEID" />
		<result property="displayDate" column="displayDate" />
		<result property="updateBy" column="UPDATED_BY" />
	</resultMap>

	<select id="getByCRN" resultMap="result">
		select COVERPAGE_ID,
		CASE_ID,
		PRIMARY_SUB,
		PRIMARY_SUB_SUBJECT_ID,
		to_char(COVERPAGE_DATE,'DD-MM-YYYY') sdate,
		PROCESSCYCLEID,to_char(UPDATED_ON, 'DD-MM-YY HH24:MI:SS') displayDate,
		cov.UPDATED_BY
		from RG_COVERPAGE cov where
		CASE_ID =#crn#
		and PROCESSCYCLEID = #processCycleId#
	</select>
	
	<select id="isMarkDone" resultClass="java.lang.String">
		select COMPONENT_STATUS from
		RG_CASERPT_TEMPLATE_COMPONENT
		where COMPONENT_ID =#componentId# and
		CASE_ID =#crn# 
	</select>
	
	<resultMap id="subjectDetails" class="com.worldcheck.juno.vo.common.ReportSubjectVO">
		<result property="subjectId" column="SUBJECT_ID" />
		<result property="reportSubjectName" column="REPORT_SUBJECT_NAME" />
		<result property="cmsSubjectName" column="SUBJECT_NAME" />
		<result property="oldCmsSubjectName" column="OLD_CMS_SUBJECT_NAME" />
		<result property="junoOrder" column="REPORT_ORDER" />
		<result property="primary" column="IS_PRIMARY_SUB" />
		<result property="localLanguageName" column="LOCAL_LANGUAGE_NAME" />
		<result property="countryVO" resultMap="CoverPageVO.countryMasterVO" />
	</resultMap>
		
	<resultMap id="countryMasterVO" class="com.worldcheck.atlas.vo.masters.CountryMasterVO">
		<result property="country" column="COUNTRY"/>
	</resultMap>
	
	<select id="getSubjectList" resultMap="subjectDetails">
		SELECT 	SUB.SUBJECT_ID,SUB.REPORT_SUBJECT_NAME,cms.SUBJECT_NAME,sub.SUBJECT_NAME OLD_CMS_SUBJECT_NAME,SUB.REPORT_ORDER,
			case when SUB.IS_PRIMARY_SUB = 1 then 'true' else 'false' end IS_PRIMARY_SUB,
			COUNT.COUNTRY, sub.LOCAL_LANGUAGE_NAME
			FROM RG_SUBJECT SUB , CMS_COUNTRY_MASTER COUNT, CMS_SUBJECT cms
			WHERE SUB.CRN=#crn# and cms.SUBJECT_ID = SUB.CMS_SUBJECT_ID AND cms.COUNTRY_ID=COUNT.COUNTRY_MASTER_ID
			and SUB.CMS_SUBJECT_ID IS NOT NULL
			ORDER BY SUB.IS_PRIMARY_SUB DESC, SUB.REPORT_ORDER ASC,upper(SUB.SUBJECT_NAME) ASC
	</select>
	
	<select id="canMarkDone" resultClass="java.lang.Boolean">
		select case when count(*) > 0 then 'true' else 'false' END
		from RG_COVERPAGE where
		CASE_ID =#crn# and PROCESSCYCLEID = #processCycleId#
	</select>
	
	<update id="removeLocalLanguageName" parameterClass="java.util.HashMap">
		update RG_COVERPAGE 
		set PRIMARY_SUB = ''
		WHERE
		CASE_ID = #crn# and
		PROCESSCYCLEID IN
		<iterate property="processCycleId" open="(" close=")" conjunction=",">
			#processCycleId[]#
	    </iterate>
	</update>

</sqlMap>