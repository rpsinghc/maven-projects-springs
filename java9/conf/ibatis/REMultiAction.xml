<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="REMaster">

	<resultMap id="researchElementMasterVO" class="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
	    <result property="rEMasterId" column="rEMasterId"/>
	    <result property="researchElementGroupName" column="researchElementGroupName"/>
	    <result property="researchElementcode" column="researchElementName"/>
	    <result property="subjectType" column="subjectType"/>
	 	<result property="researchElementName" column="researchElementName"/>
	  	<result property="points" column="points"/>
	   	<result property="supportingVendorTeam" column="supportingVendorTeam"/>
	    <result property="biTeam" column="biTeam"/>
		<result property="removeForEnglishCountry" column="REMOVE_ENGLISH"/>
    </resultMap>
	
	<resultMap id="researchElementMasterExcelVO" class="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
	    <result property="rEMasterId" column="rEMasterId"/>
	    <result property="researchElementGroupName" column="researchElementGroupName"/>
		<result property="researchElementType" column="researchElementType"/>
	    <result property="researchElementcode" column="researchElementName"/>
	    <result property="subjectType" column="subjectType"/>
	    <result property="researchElementStatus" column="researchElementStatus"/>
	 	<result property="researchElementName" column="researchElementName"/>
	  	<result property="points" column="points"/>
	   	<result property="supportingVendorTeam" column="supportingVendorTeam"/>
	    <result property="biTeam" column="biTeam"/>
		<result property="removeForEnglishCountry" column="REMOVE_ENGLISH"/>
    </resultMap>
	
	<insert id="addNewResearchElement" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
			<selectKey resultClass="int" type="pre" keyProperty="rEMasterId">
					SELECT CMS_REMASTER_SEQ.nextval AS VALUE FROM DUAL
		    </selectKey>
	   INSERT INTO CMS_RE_MASTER( RE_MASTER_ID,IS_INDIVIDUAL,GROUP_ID,ENTITY_TYPE_ID, NAME, STATUS, ST_OR_VT, REMOVE_ENGLISH,BI_TEAM,
	    			JLPOINTS,UPDATED_BY,UPDATED_ON)
		values (#rEMasterId#,#isIndividual#,#reGroupId#,#reEntityTypeId#,#researchElementName#, #researchElementStatus#,
					#supportingVendorTeam#,#removeForEnglishCountry#,#biTeam#,#points#,#updatedBy#,sysdate)  							
	</insert>
	
	<insert id="addNewREGroup" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
			<selectKey resultClass="int" type="pre" keyProperty="rEMasterId">
					SELECT CMS_REMASTER_SEQ.nextval AS VALUE FROM DUAL
		    </selectKey>
			insert into CMS_RE_MASTER(RE_MASTER_ID,IS_INDIVIDUAL,ENTITY_TYPE_ID,NAME,STATUS,ST_OR_VT,REMOVE_ENGLISH,
				 BI_TEAM,JLPOINTS,UPDATED_BY,UPDATED_ON,GROUP_NAME,GROUP_ID,SUB_GROUP_ID) 
			values (#rEMasterId#,#isIndividual#,#reEntityTypeId#,#researchElementName#,#researchElementStatus#,
			   	#supportingVendorTeam#,#removeForEnglishCountry#,#biTeam#,#pointval#,#updatedBy#,sysdate,
			   	(select decode((select count(*) from CMS_RE_MASTER where UPPER(GROUP_NAME) = UPPER(#researchElementGroupName#)),0,#researchElementGroupName#,
					(select distinct GROUP_NAME from CMS_RE_MASTER where UPPER(GROUP_NAME) = UPPER(#researchElementGroupName#))) groupName from  dual)
			   	,#reGroupId#,#reGroupId#)						
	</insert>
	
	<select id="searchRE" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO" resultMap="researchElementMasterVO">
			SELECT * FROM (SELECT  searchResult.*, ROWNUM rn FROM ( 
				Select 
						RE.RE_MASTER_ID rEMasterId,
						RE.GROUP_NAME researchElementGroupName,
						RE.NAME researchElementName,
						ETM.ENTITY_NAME subjectType,
						case when (RE.JLPOINTS <![CDATA[ < ]]> 1 and RE.JLPOINTS <![CDATA[ > ]]> 0 ) then LPAD(RE.JLPOINTS,3,'0') 
        					else to_char(RE.JLPOINTS) end points,
						RE.ST_OR_VT supportingVendorTeam,
						RE.BI_TEAM biTeam,
						RE.REMOVE_ENGLISH
				FROM 
						CMS_RE_MASTER RE,
						CMS_ENTITYTYPE_MASTER ETM
				WHERE 
						RE.ENTITY_TYPE_ID= ETM.ENTITY_TYPE_ID			
				<isNotNull prepend="AND" property="researchElementName">
					<isNotEmpty property="researchElementName">
						UPPER(RE.NAME) LIKE '%'|| UPPER(#researchElementName#) || '%'
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="subjectType">
					<isNotEmpty property="subjectType">
						RE.ENTITY_TYPE_ID = #subjectType#
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="researchElementGroupName">
					<isNotEmpty property="researchElementGroupName">
						UPPER(RE.GROUP_NAME) LIKE '%'|| UPPER(#researchElementGroupName#) || '%'
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="researchElementStatus">
					<isNotEmpty property="researchElementStatus">
						RE.STATUS = #researchElementStatus#
					</isNotEmpty>
				</isNotNull> 
				<isNotNull property="sortColumnName">
					 <isEqual property="sortColumnName" compareValue="rEMasterId">
							order by ($sortColumnName$) $sortType$
					</isEqual>
					<isNotEqual property="sortColumnName" compareValue="rEMasterId">
							order by upper($sortColumnName$) $sortType$
					</isNotEqual>
				</isNotNull>
			 ,upper(researchElementGroupName),upper(researchElementName))searchResult WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
	</select>
	
	<select id="searchRECount" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO" resultClass="java.lang.Integer">
			Select COUNT(*) 
			FROM CMS_RE_MASTER RE,CMS_ENTITYTYPE_MASTER ETM
			WHERE RE.ENTITY_TYPE_ID= ETM.ENTITY_TYPE_ID			
				<isNotNull prepend="AND" property="researchElementName">
					<isNotEmpty property="researchElementName">
						UPPER(RE.NAME) LIKE '%'|| UPPER(#researchElementName#) || '%'
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="subjectType">
					<isNotEmpty property="subjectType">
						RE.ENTITY_TYPE_ID = #subjectType#
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="researchElementGroupName">
					<isNotEmpty property="researchElementGroupName">
						UPPER(RE.GROUP_NAME) LIKE '%'|| UPPER(#researchElementGroupName#) || '%'
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="researchElementStatus">
					<isNotEmpty property="researchElementStatus">
						RE.STATUS = #researchElementStatus#
					</isNotEmpty>
				</isNotNull> 
	</select>

	<update id="statusUpdate" parameterClass = "java.util.Map">     
		UPDATE CMS_RE_MASTER 
			SET STATUS = #reStatusval#,
				UPDATED_BY = #userName#,
				UPDATED_ON = sysdate
		WHERE CMS_RE_MASTER.RE_MASTER_ID IN ($rEMasterId$)
	</update>
	
	<select id="canResDeactivated" parameterClass = "java.lang.String" resultClass="java.lang.Integer"> 
		Select count(distinct SUBJECT_ID)  from CMS_SUB_TEAM_RE_MAP
		WHERE RE_ID in ($reIds$)
	    	AND CRN in (select ccc.CRN from CMS_CLIENTCASE ccc,CMS_CASE_STATUS_MASTER ccsm 
	    				where ccc.CASE_STATUS_ID = ccsm.CASE_STATUS_ID and ccsm.CASE_STATUS_ID in (1,2,3))	
	</select>

	<select id="getREInfo" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO"
			resultClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
		select RE.RE_MASTER_ID "researchElementTypeId",
					RE.IS_INDIVIDUAL "reType",
					RE.NAME "researchElementName",
					RE. ENTITY_TYPE_ID "reEntityTypeId",
					case when (RE.JLPOINTS <![CDATA[ < ]]> 1 and RE.JLPOINTS <![CDATA[ > ]]> 0 ) then LPAD(RE.JLPOINTS,3,'0') 
        				else to_char(RE.JLPOINTS) end "points",
					RE.STATUS "researchElementStatus",
					RE.ST_OR_VT "supportingVendorTeam",
					RE.BI_TEAM "biTeam",
					RE.REMOVE_ENGLISH "removeForEnglishCountry",
					RE.GROUP_NAME "researchElementGroupName",
					nvl(RE.GROUP_ID,0) "reGroupIdVal"
				FROM
					CMS_RE_MASTER RE 
					where RE.RE_MASTER_ID =#rEMasterId#
	</select>

	<select id="getGroupInfo" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO" 
					resultClass="com.worldcheck.atlas.vo.masters.ResearchElementGroupMasterVO">
		select RE.RE_MASTER_ID "reCodeval",RE.NAME "reNameval",RE.ST_OR_VT "reSubVenTeam",
				case when (RE.JLPOINTS <![CDATA[ < ]]> 1 and RE.JLPOINTS <![CDATA[ > ]]> 0 ) then LPAD(RE.JLPOINTS,3,'0') 
        				else to_char(RE.JLPOINTS) end "rePointsval",
		  RE.GROUP_ID "reGroupId",RE.BI_TEAM "reBITeam",RE.GROUP_NAME "reGroupval",CEM.ENTITY_TYPE_ID "reEntityTypeIdval",
		  RE.STATUS "reStatusval",RE.REMOVE_ENGLISH "reRemEng"
		FROM CMS_RE_MASTER RE,CMS_ENTITYTYPE_MASTER CEM 
		where CEM.ENTITY_TYPE_ID = RE.ENTITY_TYPE_ID
			AND RE.GROUP_ID =(select GROUP_ID from CMS_RE_MASTER  where RE_MASTER_ID = #rEMasterId#)
	</select>
	
	<select id="getReInfoDetails" parameterClass="java.lang.String" resultClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
		select RE.RE_MASTER_ID "rEMasterId",
		    RE.NAME "researchElementName",
		    RE.ENTITY_TYPE_ID "reEntityTypeId",
		    RE.STATUS "researchElementStatus" 
		FROM
		    CMS_RE_MASTER RE 
		    where RE.RE_MASTER_ID IN ($rEMasterId$)
	</select>
	
	<select id="getGroupId" resultClass="java.lang.Integer" parameterClass="java.lang.String">
		 select decode(a.GROUP_ID,null,b.GROUPID,a.GROUP_ID) groupID 
		 from (select #groupName# groupName, nvl(max(GROUP_ID),0)+1 groupID from CMS_RE_MASTER group by #groupName#) b 
		 left join
  		 (select distinct GROUP_NAME,GROUP_ID from CMS_RE_MASTER   WHERE UPPER(GROUP_NAME) = UPPER(#groupName#)) a 
  		 on UPPER(b.groupName) = UPPER(a.GROUP_NAME) and b.groupid =a.GROUP_ID 
	</select>

	<update id="updateRE" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
		 UPDATE CMS_RE_MASTER RE set 
					ENTITY_TYPE_ID =  #reEntityTypeId#,
					"NAME" = #researchElementName#,
					STATUS =  #researchElementStatus#,
					ST_OR_VT = #supportingVendorTeam#,
					REMOVE_ENGLISH =  #removeForEnglishCountry#,
					BI_TEAM =  #biTeam#,
					JLPOINTS = #points#,
					UPDATED_BY = #updatedBy#,
					UPDATED_ON = sysdate,
					IS_INDIVIDUAL =  #researchElementType#,
					GROUP_NAME = #researchElementGroupName#,
					GROUP_ID = #reGroupId#
			WHERE
			 RE.RE_MASTER_ID = #researchElementTypeId#					
	</update>
	
	<update id="updateGroupRE" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
		 UPDATE CMS_RE_MASTER RE set 
		    ENTITY_TYPE_ID =  #reEntityTypeId#,
		    NAME = #researchElementName#,
		    STATUS =  #researchElementStatus#,
		    ST_OR_VT = #supportingVendorTeam#,
		    REMOVE_ENGLISH =  #removeForEnglishCountry#,
		    BI_TEAM =  #biTeam#,
		    JLPOINTS = #pointval#,
		    UPDATED_BY = #updatedBy#,
		    UPDATED_ON = sysdate,
		    IS_INDIVIDUAL =  #isIndividual#,
		    GROUP_NAME = #researchElementGroupName#,
		    GROUP_ID = #reGroupId#
		WHERE
		    RE.RE_MASTER_ID = #researchElementTypeId#						
	</update>
	
	<update id="updateCaseREPoints" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
		 UPDATE CMS_SUB_TEAM_RE_MAP set JLPOINTS =  #points#
		 WHERE RE_ID = #researchElementTypeId# 
		 		AND CRN in (select ccc.CRN from CMS_CLIENTCASE ccc,CMS_CASE_STATUS_MASTER ccsm 
	    					where ccc.CASE_STATUS_ID = ccsm.CASE_STATUS_ID and ccsm.CASE_STATUS_ID in (1,2,3))					
	</update>
	
	<update id="updateCaseGrpREPoints" parameterClass="com.worldcheck.atlas.vo.masters.ResearchElementMasterVO">
		 UPDATE CMS_SUB_TEAM_RE_MAP set JLPOINTS =  #pointval#
		 WHERE RE_ID = #researchElementTypeId# 
		 		AND CRN in (select ccc.CRN from CMS_CLIENTCASE ccc,CMS_CASE_STATUS_MASTER ccsm 
	    					where ccc.CASE_STATUS_ID = ccsm.CASE_STATUS_ID and ccsm.CASE_STATUS_ID in (1,2,3))					
	</update>
	
	
	<select id="isGroupNameUnique"  resultClass="java.lang.Integer" parameterClass = "java.util.Map">
	   SELECT  COUNT(GROUP_ID) 
	   FROM CMS_RE_MASTER 
	   WHERE UPPER(GROUP_NAME) = UPPER(#groupName#) 
     </select>
     
     <select id="isSubjectTypeREUnique"  resultClass="java.lang.Integer" parameterClass = "java.util.Map">
	   select count(RE_MASTER_ID) 
	   FROM CMS_RE_MASTER  
	   where  ENTITY_TYPE_ID=#subjectType# and UPPER(name) = UPPER(#reName#) 
	   <isNotNull prepend="AND" property="reId">
			<isNotEmpty property="reId">
				RE_MASTER_ID != #reId#
			</isNotEmpty>
	   </isNotNull> 
     </select>
     
     
     <select id="isWIPCaseImpacted"  resultClass="java.lang.Integer" parameterClass = "java.util.Map">
	   select count(RE_MASTER_ID) 
	   FROM CMS_RE_MASTER  
	   where  RE_MASTER_ID = #reId# and UPPER(BI_TEAM) = UPPER(#reBITeam#)
     </select>
     
     <select id="wipImpactedCaseCount"  resultClass="java.lang.Integer" parameterClass = "java.lang.String">
	     select count(ccc.CRN) 
		 from CMS_CLIENTCASE ccc,CMS_CASE_STATUS_MASTER ccsm   
		   where ccc.CASE_STATUS_ID = ccsm.CASE_STATUS_ID and ccsm.CASE_STATUS_ID in (1,2,3) 
		          and ccc.CRN in (select distinct cstrm.CRN from CMS_SUB_TEAM_RE_MAP cstrm where cstrm.RE_ID in ($reIds$))
	 </select>

	  <delete id="deleteREDetails" parameterClass="java.lang.String">
			DELETE FROM CMS_RE_MASTER
			WHERE RE_MASTER_ID = #reId#
	  </delete>

	  <!--Added By Juheen.For CR-2(query to ExportToExcel in RE Master.) -->
	   <select id="exportToXl_RE" parameterClass="java.util.Map"  resultMap="researchElementMasterExcelVO">
		
				Select 
						RE.RE_MASTER_ID rEMasterId,
						 case when RE.is_individual=1
                         then 'Checkbox'
                         else 'Radio Button'
                         end researchElementType,
						 RE.GROUP_NAME researchElementGroupName,
						 RE.NAME researchElementName,
					     ETM.ENTITY_NAME subjectType,
						 case when RE.STATUS=1
                         then 'Active'
                         else 'Deactive'
                         end researchElementStatus,
						case when (RE.JLPOINTS <![CDATA[ < ]]> 1 and RE.JLPOINTS <![CDATA[ > ]]> 0 ) then LPAD(RE.JLPOINTS,3,'0') 
        					else to_char(RE.JLPOINTS) end points,
						RE.ST_OR_VT supportingVendorTeam,
						RE.BI_TEAM biTeam,
						RE.REMOVE_ENGLISH
				FROM 
						CMS_RE_MASTER RE,
						CMS_ENTITYTYPE_MASTER ETM
				WHERE 
						RE.ENTITY_TYPE_ID= ETM.ENTITY_TYPE_ID			
				<isNotNull prepend="AND" property="researchElementName">
					<isNotEmpty property="researchElementName">
						UPPER(RE.NAME) LIKE '%'|| UPPER(#researchElementName#) || '%'
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="subjectType">
					<isNotEmpty property="subjectType">
						RE.ENTITY_TYPE_ID = #subjectType#
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="researchElementGroupName">
					<isNotEmpty property="researchElementGroupName">
						UPPER(RE.GROUP_NAME) LIKE '%'|| UPPER(#researchElementGroupName#) || '%'
					</isNotEmpty>
				</isNotNull> 
				<isNotNull prepend="AND" property="researchElementStatus">
					<isNotEmpty property="researchElementStatus">
						RE.STATUS = #researchElementStatus#
					</isNotEmpty>
				</isNotNull> 
				 ORDER BY upper(subjectType) ASC ,
               upper(researchElementGroupName),
              upper(researchElementName)
				
	</select>

</sqlMap>


