<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="OfficeUtilization">

	<!--- Showing data by ID -->
	
		<resultMap id="publicHolidayMasterVO" class="com.worldcheck.atlas.vo.masters.PublicHolidayMasterVO">
			<result property="holidayDate" column="holidayDate" />
			<result property="holiday" column="holiday" />
			<result property="office" column="office" />
		</resultMap>

		
		<select id="getPublicHoliday" resultMap="publicHolidayMasterVO" parameterClass="java.util.HashMap">
			SELECT * FROM (SELECT  searchResult.*, ROWNUM rn FROM 
				( select to_char(chm.DATED_ON,'dd-MON') holidayDate,chm.HOLIDAY_DESC holiday, com.OFFICE
				from CMS_HOLIDAY_MASTER chm, CMS_OFFICE_MASTER com 
				where com.OFFICE_MASTER_ID=chm.OFFICE_ID 
					and chm.DATED_ON between (trunc(sysdate, 'MM')) and last_day(ADD_MONTHS(sysdate,1))
				order by chm.DATED_ON,com.OFFICE )searchResult 
			WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
		</select>
		
		<select id="getPublicHolidayCount" resultClass="java.lang.Integer" >
			select count(*) 
			from CMS_HOLIDAY_MASTER chm, CMS_OFFICE_MASTER com 
			where com.OFFICE_MASTER_ID=chm.OFFICE_ID 
				and chm.DATED_ON between (trunc(sysdate, 'MM')) and last_day(ADD_MONTHS(sysdate,1))
		</select>
	  
		<resultMap id="productivityAndRevenueSummaryVO" class="com.worldcheck.atlas.vo.report.ProductivityAndRevenueSummaryVO">
			<result property="office" column="office" />
			<result property="avgWipPoints" column="avgWipPoints" />
			<result property="avgWipPointsForMonth" column="avgWipPointsForMonth" />
			<result property="avgCmpPointsForMonth" column="avgCmpPointsForMonth" />
			<result property="totalPoints" column="totalPoints" />
			<result property="avgWipRevenue" column="avgWipRevenue" />
			<result property="avgWipRevenueForMonth" column="avgWipRevenueForMonth" />
			<result property="avgCmpRevenueForMonth" column="avgCmpRevenueForMonth" />
			<result property="totalRevenue" column="totalRevenue" />
		</resultMap>
	  
		<select id="getProductivityRevenueSummaryDetails" resultMap="productivityAndRevenueSummaryVO" >
			select currentMonth.office office, 
				ROUND(allwip.AVG_Points,2) avgWipPoints,
				ROUND(currentMonth.WIP_Points,2) avgWipPointsForMonth, 
				ROUND(currentMonth.CMP_Points,2) avgCmpPointsForMonth, 
				ROUND((currentMonth.WIP_Points + currentMonth.CMP_Points),2) totalPoints, 
				ROUND(allwip.AVG_Revenue,2) avgWipRevenue, 
				ROUND(currentMonth.WIP_REV,2) avgWipRevenueForMonth, 
				ROUND(currentMonth.CMP_REV,2) avgCmpRevenueForMonth, 
				ROUND((currentMonth.CMP_REV + currentMonth.WIP_REV),2) totalRevenue
			from 
			    (select curMonJLP.office, decode(curMonJLP.CMP_Points,null,0,curMonJLP.CMP_Points) CMP_Points,decode(curMonJLP.WIP_Points,null,0,curMonJLP.WIP_Points) WIP_Points,
			          decode(curMonREV.WIP_REV,null,0,curMonREV.WIP_REV) WIP_REV, decode(curMonREV.CMP_REV,null,0,curMonREV.CMP_REV) CMP_REV 
			    from (select Office,decode(CMP_JLP/(decode(ANALYST_COUNT,0,null,ANALYST_COUNT)),null,0.0,CMP_JLP/ANALYST_COUNT) CMP_Points, 
			          	decode(WIP_JLP/(decode(ANALYST_COUNT,0,null,ANALYST_COUNT)),null,0.0,WIP_JLP/ANALYST_COUNT) WIP_Points 
			          from DW_OFC_UTIL_JLP where CALENDAR_MONTH = to_char(SYSDATE,'MM') and CALENDAR_YEAR = to_char(sysdate,'YYYY')  order by OFFICE ) curMonJLP 
			    left join
			        (select Office,decode(WIP_REVENUE/(decode(ANALYST_COUNT,0,null,ANALYST_COUNT)),null,0.0,WIP_REVENUE/ANALYST_COUNT) WIP_REV,
				decode(CMP_REVENUE/(decode(ANALYST_COUNT,0,null,ANALYST_COUNT)),null,0.0,CMP_REVENUE/ANALYST_COUNT) CMP_REV
			         from DW_OFC_UTIL_REV where CALENDAR_MONTH = to_char(SYSDATE,'MM') and CALENDAR_YEAR = to_char(sysdate,'YYYY')  order by OFFICE ) curMonREV 
			    on curMonJLP.Office=curMonREV.Office) currentMonth  
			left join 
			    (select allWipJLP.office, decode(allWipJLP.AVG_Points,null,0,allWipJLP.AVG_Points) AVG_Points,decode(allWipRev.AVG_Revenue,null,0,allWipRev.AVG_Revenue) AVG_Revenue   
			    	from (select office,sum(decode(WIP_JLP/(decode(ANALYST_COUNT,0,null,ANALYST_COUNT)),null,0.0,WIP_JLP/ANALYST_COUNT)) AVG_Points 
			      		  from DW_OFC_UTIL_JLP group by office order by OFFICE) allWipJLP
			    	left join 
			    		(select office, sum(decode(WIP_REVENUE/(decode(ANALYST_COUNT,0,null,ANALYST_COUNT)),null,0.0,WIP_REVENUE/ANALYST_COUNT)) AVG_Revenue 
			    		 from DW_OFC_UTIL_REV group by office order by OFFICE) allWipRev 
			    	on allWipJLP.office = allWipRev.office) allwip on allwip.office=currentMonth.office 
			order by currentMonth.office
		</select>
		
		<resultMap id="casesReceivedSummaryVO" class="com.worldcheck.atlas.vo.report.CasesReceivedSummaryVO" groupBy="office">
			<result property="office" column="OFFICE" />
			<result property="total" column="TOTAL" />
			<result property="reportTypeList" resultMap="OfficeUtilization.ncrsReportTypeVOMap" />
		</resultMap>
		
		<resultMap id="ncrsReportTypeVOMap" class="com.worldcheck.atlas.vo.report.NCRSReportTypeVO">
			<result property="reportCrnInitial" column="REPORT_CRN_INITIAL" />
			<result property="caseCount" column="CASE_COUNT" />
			<result property="casePercent" column="CASE_PCT" />
		</resultMap>
		
		<select id="getCasesReceivedSummary" resultMap="casesReceivedSummaryVO" >
			SELECT a.*, b.TOTAL FROM 
			(
				SELECT 
				OFFICE OFFICE, REPORT_CRN_INITIAL, 
				CASE_COUNT, ROUND(CASE_PCT, 2) CASE_PCT
				FROM DW_CASE_RECVD_SUMMARY
				ORDER BY REPORT_TYPE_MASTER_ID
			) a
			LEFT JOIN
			(
				SELECT OFFICE, SUM(CASE_COUNT) TOTAL
				FROM DW_CASE_RECVD_SUMMARY 
				GROUP BY OFFICE
			) b
			ON a.OFFICE = b.OFFICE
			ORDER BY UPPER(a.OFFICE) ASC
		</select>
		
		<select id="getCasesReceivedSummaryHeader" resultClass="java.lang.String" >
			SELECT REPORT_CRN_INITIAL
			FROM CMS_REPORT_TYPE_MASTER WHERE STATUS= 1
			ORDER BY REPORT_TYPE_MASTER_ID
		</select>
                
		<resultMap id="officeSummaryVO" class="com.worldcheck.atlas.vo.report.OfficeSummaryVO">
			<result property="office" column="OFFICE" />
			<result property="cmpPointsForMonth1" column="cmp1" />
			<result property="wipPointsForMonth1" column="wip1" />
			<result property="ttlPointsForMonth1" column="ttl1" />
			<result property="avgPointsForMonth1" column="avg1" />
			
			<result property="cmpPointsForMonth2" column="cmp2" />
			<result property="wipPointsForMonth2" column="wip2" />
			<result property="ttlPointsForMonth2" column="ttl2" />
			<result property="avgPointsForMonth2" column="avg2" />

			<result property="cmpPointsForMonth3" column="cmp3" />
			<result property="wipPointsForMonth3" column="wip3" />
			<result property="ttlPointsForMonth3" column="ttl3" />
			<result property="avgPointsForMonth3" column="avg3" />
		</resultMap>
	  
	     <select id="getOfficeSummaryData" resultMap="officeSummaryVO"  parameterClass="java.util.HashMap">
		SELECT OFFICE ,    
		round(sum(case when (CALENDAR_MONTH = #monthFirst# and CALENDAR_YEAR = #year#) 
		then CMP_JLP else 0 end),2) as cmp1,    
	   
		round(sum(case when (CALENDAR_MONTH =  #monthFirst# and CALENDAR_YEAR = #year#) 
		then WIP_JLP else 0 end),2) as wip1,
  
		round(sum(case when (CALENDAR_MONTH = #monthFirst# and CALENDAR_YEAR = #year#) 
		then TTL_JLP else 0 end),2) as ttl1,
  
		round(nvl( sum(case when (CALENDAR_MONTH =  #monthFirst# and CALENDAR_YEAR = #year#) 
		then (decode(ANALYST_COUNT,0,0,TTL_JLP/ANALYST_COUNT)) else 0 end),0),2) as avg1,
 
		round(sum(case when (CALENDAR_MONTH =  #monthSecond# and CALENDAR_YEAR = #year#) 
		then CMP_JLP else 0 end),2) as cmp2,
    
		round(sum(case when (CALENDAR_MONTH =  #monthSecond# and CALENDAR_YEAR = #year#) 
	        then WIP_JLP else 0 end),2) as wip2,
  
		round(sum(case when (CALENDAR_MONTH =  #monthSecond# and CALENDAR_YEAR = #year#) 
		then TTL_JLP else 0 end),2) as ttl2,
  
       round(nvl(sum(case when (CALENDAR_MONTH =  #monthSecond# and CALENDAR_YEAR = #year#) 
	       then (decode(ANALYST_COUNT,0,0,TTL_JLP/ANALYST_COUNT)) else 0 end),0),2) as avg2,

		round(sum(case when (CALENDAR_MONTH = #monthThird# and CALENDAR_YEAR = #year#) 
                then CMP_JLP else 0 end),2) as cmp3,
		
		round(sum(case when (CALENDAR_MONTH =  #monthThird# and CALENDAR_YEAR = #year#) 
                then WIP_JLP else 0 end),2) as wip3,
  
		round(sum(case when (CALENDAR_MONTH =  #monthThird# and CALENDAR_YEAR = #year#) 
		then TTL_JLP else 0 end),2) as ttl3,
  
		round(nvl(sum(case when (CALENDAR_MONTH =  #monthThird# and CALENDAR_YEAR = #year#) 
       then (decode(ANALYST_COUNT,0,0,TTL_JLP/ANALYST_COUNT)) else 0 end),0),2) as avg3
  
		FROM DW_OFC_UTIL_JLP 
		WHERE CALENDAR_YEAR = #year#
		GROUP BY OFFICE
	    order by OFFICE
	  </select>
</sqlMap>