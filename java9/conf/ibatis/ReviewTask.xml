<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ReviewTask">

	<resultMap id="teamDetailsMap" class="com.worldcheck.atlas.vo.TeamDetails">
		<result column="TEAM_ID" property="teamId" />
		<result column="CRN" property="crn" />
		<result column="OFFICE_ID" property="office" />
		<result column="officeName" property="officeName" />
		<result column="REVIEWER1" property="reviewer1" />
		<result column="REVIEWER2" property="reviewer2" />
		<result column="REVIEWER3" property="reviewer3" />
		<result column="REV_INTDUEDATE1" property="dueDate1" />
		<result column="REV_INTDUEDATE2" property="dueDate2" />
		<result column="REV_FINDUEDATE" property="finalDueDate" />
		<result column="TEAM_TYPE" property="teamType" />
	</resultMap>
	
 <resultMap id="scoreSheet"   class="com.worldcheck.atlas.vo.task.review.ScoreSheetVO">
		<result property="scoreSheetID" column="scoresheet_master_id"/>
		<result property="scoreSheetName" column="scoresheet_name"/>
		<result property="officeId" column="office_id"/>
 </resultMap>
	
 <resultMap id="scoreSheetFieldMap"   class="com.worldcheck.atlas.vo.task.review.ScoreSheetVO">
		<result property="fieldId" column="scoresheet_flds_master_id"/>
		<result property="fieldName" column="field_name"/>
 </resultMap>

 <resultMap id="analystMap"   class="com.worldcheck.atlas.vo.task.review.ScoreSheetVO">
		<result property="performer" column="performer"/>
		<result property="main_Analyist" column="main_Analyist"/>
		<result property="userFullName" column="userFullName"/>
 </resultMap>

 <resultMap id="editorMap"   class="com.worldcheck.atlas.vo.task.review.ScoreSheetVO">
		<result property="userId" column="user_master_id"/>
		<result property="userName" column="login_id"/>
		<result property="userFullName" column="userFullName"/>
 </resultMap>
 
	
	<!--- Showing data by ID -->
	
 <select id="getScoreSheet" resultMap="scoreSheet" >
	  SELECT scoresheet_master_id, scoresheet_name,office_id
	  FROM 
	  cms_scoresheet_master 
	  WHERE office_id in ( SELECT office_id FROM cms_team_details WHERE team_id in($teamId$))
 </select>    
	  
 <select id="getReviewScoreSheetTemplate" resultClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetTemplateVO" >
 select * from (
 (SELECT 
		cscm.category,
		cscm.sheet_id,
		csscm.sub_category sub_category, 
		csscm.category_id category_id,
		csscm.cnt_of_errors,
		csscm.points, 
		csscm.scoresheet_subcateg_id
	FROM 
		cms_scoresheet_categ_map cscm,cms_scoresheet_subcateg_map csscm 
	WHERE cscm.sheet_id= #scoreSheetId#  AND cscm.scoresheet_categ_id = csscm.category_id
  ) a
  left join
  (
  select max(cssm.points) maxSubCategoryPoints, cssm.sub_category sub_category, cssm.category_id category_id
  from cms_scoresheet_subcateg_map cssm
  group by cssm.sub_category, cssm.category_id
   order by category_id,sub_category
  ) b on b.sub_category = a.sub_category and b.category_id = a.category_id
  ) order by scoresheet_subcateg_id
 </select>   
	  
 <select id="getReviewScoreSheetFieldMap" resultMap="scoreSheetFieldMap">
	   select scoresheet_flds_master_id, field_name from cms_scoresheet_flds_master where scoresheet_flds_master_id in( 
 select substr(','||csv||',',instr(','||csv||',',',',1,r)+1,instr(','||csv||',',',',1,r+1)-instr(','||csv||',',',',1,r)-1) scoresheet_id 
  from   (select scoresheet_flds csv from cms_scoresheet_flds_map where sheet_id=#sheetId#)       
          ,(select rownum r from dual connect by level <![CDATA[ <= ]]>  500) 
  where  instr(csv||',',',',1,r) > 0 )
</select>
	  
 <select id="getAnalyst" resultMap="analystMap" parameterClass="java.util.Map">  
  select unique(performer) performer, (select USER_FULL_NAME  from cms_user_master where login_id =(select reports_to  from cms_user_master where login_id =performer))  main_Analyist 
  , (select USER_FULL_NAME  from cms_user_master where login_id =performer) userFullName
  from cms_sub_team_re_map where crn=#crn# and team_id in ($team_ID$)
  </select>
  
  
  <select id="getTeamDetails" resultMap="teamDetailsMap" >
  select 
    cms_team_details.team_id,
  cms_team_details.crn,
  cms_team_details.office_id,
  (select cms_office_master.office from cms_office_master where office_master_id = cms_team_details.office_id) officeName, 
  cms_team_details.rev_finduedate,
  cms_team_details.rev_intduedate1,
  cms_team_details.rev_intduedate2,
  cms_team_details.reviewer1,
  cms_team_details.reviewer2,
  cms_team_details.reviewer3,
  cms_team_type.team_type
  from 
  cms_team_details, cms_team_type   
  where crn=#crn#  and cms_team_details.team_type_id= cms_team_type.team_type_id order By cms_team_details.team_type_id
  </select>
	
	<select id="getEditiors" resultMap="editorMap" >
 select user_master_id, login_id, user_full_name as userFullName from cms_user_master where office_id in 
 (select cms_scoresheet_master.office_id from cms_scoresheet_master 
 where cms_scoresheet_master.scoresheet_master_id =#sheetId#)
	</select>
	
	
<insert id="insertReviewScoreSheetDetails" parameterClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetVO">
<selectKey keyProperty="reviewSSID" resultClass="int"	type="pre">
		select CMS_REVIEW_SS_DETAILS_SEQ.nextVal from dual
	</selectKey>
  INSERT INTO CMS_REVIEW_SCORESHEET_DETAILS 
  (ID,SCORESHEET_NAME,OFFICE_ID,ANALYST,REVIEWER,QUALITY_PERCENT,UPDATED_BY,UPDATED_ON,CRN,SCORE)  
	VALUES 
	(#reviewSSID#,#scoresheet_name#,#office_id#,#analyst#,#reviewer#,#quality_percent#,#updated_by#,sysdate,#crn#,#score#) 
</insert> 	
	
<insert id="insertReviewScoreSheetItems" parameterClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetVO">

  INSERT INTO CMS_SCORESHEET_FLDS_DETAIL 
  (SHEET_ID,
  <isNotNull  property="date_of_review">
		<isNotEmpty property="date_of_review">
			DATE_OF_REVIEW,
		</isNotEmpty>
	</isNotNull>
 
  
  COMPLEXITY,REVIEW_TIME,FINAL_INTERIM,PRIMARY_TEAM,SUPPORTING_TEAM_1,SUPPORTING_TEAM_2,SUPPORTING_TEAM_3,SUPPORTING_TEAM_4,SUPPORTING_TEAM_5,SUPPORTING_TEAM_6,
  
  <isNotNull  property="report_due_date">
		<isNotEmpty property="report_due_date">
			 REPORT_DUE_DATE,
		</isNotEmpty>
	</isNotNull>
	REVIEWER_1,REVIEWER_2,REVIEWER_3,GENERAL_COMMENT,SR_ANALYST,EDITOR,
	
	<isNotNull  property="date_report_filed">
		<isNotEmpty property="date_report_filed">
			 DATE_REPORT_FILED,
		</isNotEmpty>
	</isNotNull>
	
	<isNotNull  property="complete_os_rcvd_date">
		<isNotEmpty property="complete_os_rcvd_date">
			COMPLETE_OS_RCVD_DATE,
		</isNotEmpty>
	</isNotNull>
	REVIEWERS)  

	VALUES 
		
	(#sheet_id#,
	
	 <isNotNull  property="date_of_review">
		<isNotEmpty property="date_of_review">
		TO_DATE(#date_of_review#,'DD-Mon-YYYY'),
		</isNotEmpty>
	</isNotNull>
	#complexity#,#review_time#,#final_interim#,#primary_team#,#supporting_team_1#,#supporting_team_2#,
	#supporting_team_3#,#supporting_team_4#,#supporting_team_5#,#supporting_team_6#,
	<isNotNull  property="report_due_date">
		<isNotEmpty property="report_due_date">
		TO_DATE(#report_due_date#,'DD-Mon-YYYY'),
		</isNotEmpty>
	</isNotNull>
	#reviewer_1#,#reviewer_2#,
	#reviewer_3#,#general_comment#,#sr_analyst#,#editor#,
	<isNotNull  property="date_report_filed">
		<isNotEmpty property="date_report_filed">
			 TO_DATE(#date_report_filed#,'DD-Mon-YYYY'),
		</isNotEmpty>
	</isNotNull>
	<isNotNull  property="complete_os_rcvd_date">
		<isNotEmpty property="complete_os_rcvd_date">
			TO_DATE(#complete_os_rcvd_date#,'DD-Mon-YYYY'),
		</isNotEmpty>
	</isNotNull>
	#reviewers#) 
</insert> 

<select id="checkAnalystReviewStatus" parameterClass="java.util.Map" resultClass="int">
select count(*) from cms_review_scoresheet_details where  analyst=#Analyst# and crn=#crn#
</select>
	
	
	

<insert id="insertReviewCategory" parameterClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetCategoryVO">
<selectKey keyProperty="review_ss_categ_id" resultClass="int"	type="pre">
		SELECT CMS_REV_SS_CATEG_MAP_SEQ.nextval FROM DUAL
	</selectKey>
  INSERT INTO CMS_REV_SCORESHEET_CATEG_MAP(REVIEW_SS_CATEG_ID,REVIEW_SHEET_ID,SS_CATEGORY_ID,CATEGORY,COMMENTS,UPDATED_BY,UPDATED_ON)  
	VALUES 
	(#review_ss_categ_id#,#review_sheet_id#,#ss_category_id#,#category#,#comments#,#updated_by#,sysdate) 
</insert> 
	
	
	

<insert id="insertReviewSubCategory" parameterClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetSubCatgVO">
<selectKey keyProperty="review_ss_subcateg_id" resultClass="int"	type="pre">
		SELECT CMS_REV_SS_SUBCAT_MAP_SEQ.nextval  FROM DUAL
	</selectKey>
  INSERT INTO CMS_REV_SCORESHEET_SUBCAT_MAP(REVIEW_SS_SUBCATEG_ID,REVIEW_SS_CATEGORY_ID,SS_SUB_CATEGORY_ID,SUB_CATEGORY,CNT_OF_ERRORS,POINTS,SCORE,APPLICABILITY,SELECTED,UPDATED_BY,UPDATED_ON)  
	VALUES 
	(#review_ss_subcateg_id#,#review_ss_category_id#,#ss_sub_category_id#,#sub_category#,#cnt_of_errors#,#points#,#score#,#applicability#,#select#,#updated_by#,sysdate) 
</insert> 
	
	
<select id="getReviewedScoreSheet" resultClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetVO" parameterClass="java.util.Map">
SELECT * FROM (SELECT  searchResult.*, ROWNUM rn FROM (select id as sheet_id, (select USER_FULL_NAME  from cms_user_master where login_id = analyst) analyst, office_id, (select cms_office_master.office from cms_office_master where office_master_id = office_id) officeName,
quality_percent, (select USER_FULL_NAME  from cms_user_master where login_id = reviewer) reviewer, scoresheet_name, score, updated_by  from cms_review_scoresheet_details where crn=#crn#  )searchResult WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>

	
<select id="getReviewedScoreSheetCount" resultClass="int"   parameterClass="java.util.Map">
select count(*)  from cms_review_scoresheet_details where crn=#crn# 
</select>


<select id="getReviewedSSCategoryDetails" resultClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetTemplateVO">
select * from (
 (SELECT 
		crscm.category category,
    	crscm.REVIEW_SS_CATEG_ID category_id,
		crscm.REVIEW_SHEET_ID sheet_id,
   		crscm.COMMENTS comments,
		crsscm.REVIEW_SS_SUBCATEG_ID scoresheet_subcateg_id, 
		crsscm.SUB_CATEGORY sub_category,
		crsscm.cnt_of_errors cnt_of_errors,
		crsscm.points points, 
		crsscm.SCORE scores,
   		crsscm.APPLICABILITY applicability,
   		crsscm.SELECTED  selected  
FROM 
	   CMS_REV_SCORESHEET_CATEG_MAP crscm,CMS_REV_SCORESHEET_SUBCAT_MAP crsscm 
	WHERE 
	crscm.REVIEW_SHEET_ID= #sheet_Id#  AND crscm.REVIEW_SS_CATEG_ID = crsscm.REVIEW_SS_CATEGORY_ID) a
  
  left join
  (
  select max(crsscm.points) maxSubCategoryPoints, crsscm.SUB_CATEGORY sub_category, crsscm.review_ss_category_id category_id
  from CMS_REV_SCORESHEET_SUBCAT_MAP crsscm
  group by crsscm.sub_category,  crsscm.review_ss_category_id
  order by category_id,sub_category
  ) b on b.sub_category = a.sub_category and b.category_id = a.category_id
  ) order by a.category_id,a.sub_category,applicability desc
</select>

<select id="getReviewedSSItemDetails" resultClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetVO">
select SHEET_ID,DATE_OF_REVIEW, COMPLEXITY,
  REVIEW_TIME,FINAL_INTERIM,PRIMARY_TEAM,SUPPORTING_TEAM_1,
  SUPPORTING_TEAM_2,SUPPORTING_TEAM_3,SUPPORTING_TEAM_4,SUPPORTING_TEAM_5,
  SUPPORTING_TEAM_6, 
  REPORT_DUE_DATE,
 rev1.user_full_name REVIEWER_1,
		rev2.user_full_name REVIEWER_2,
		rev3.user_full_name REVIEWER_3,
    GENERAL_COMMENT,
    sranalyst.user_full_name SR_ANALYST,
   editor.user_full_name EDITOR,
   DATE_REPORT_FILED,
   COMPLETE_OS_RCVD_DATE,
   cssfd.REVIEWERS,
   crssfd.reviewer,
   analyst.user_full_name analyst,
   crssfd.crn
  from cms_scoresheet_flds_detail cssfd,cms_review_scoresheet_details crssfd, cms_user_master rev1,cms_user_master
		rev2,cms_user_master rev3
,cms_user_master analyst,
cms_user_master sranalyst,cms_user_master editor    where 
  sheet_id=#sheet_Id#
  AND cssfd.sheet_id=crssfd.id
  AND rev1.LOGIN_ID(+) = cssfd.REVIEWER_1
		AND rev2.LOGIN_ID(+) = cssfd.REVIEWER_2
		AND rev3.LOGIN_ID(+) = cssfd.REVIEWER_3
    
    AND analyst.LOGIN_ID(+) = crssfd.analyst
     AND sranalyst.LOGIN_ID(+) = cssfd.SR_ANALYST
         AND editor.LOGIN_ID(+) = cssfd.EDITOR
</select>

<update id="updateReviewSSCatgory" parameterClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetCategoryVO">
	Update   CMS_REV_SCORESHEET_CATEG_MAP set 
    COMMENTS=#comments# ,UPDATED_BY=#updated_by#,UPDATED_ON=sysdate   
   where review_ss_categ_id = #review_ss_categ_id#
</update>

<update id="updateReviewSSSubCatgory" parameterClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetSubCatgVO">
	
  Update   CMS_REV_SCORESHEET_SUBCAT_MAP set
   CNT_OF_ERRORS=#cnt_of_errors#,
   POINTS=#points#,
   SCORE=#score#,
   APPLICABILITY=#applicability#,
   SELECTED=#select#,
   UPDATED_BY=#updated_by#,
   UPDATED_ON=sysdate
   
   where REVIEW_SS_SUBCATEG_ID = #review_ss_subcateg_id#
</update>


<update id="updateReviewSSDetails"  parameterClass="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetVO">
  Update   cms_review_scoresheet_details set
   score =#score#,
   quality_Percent=#quality_percent#,
   UPDATED_BY=#updated_by#,
   UPDATED_ON=sysdate
   where id = #sheet_id#
</update>

<!-- ======================Modified by saurabh for REVIEW SCORESHEET MIS =========================================-->

<resultMap id="scoreSheetMasterMAP" class="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetVO" groupBy="sheet_id">
		<result property="sheet_id" column="sheet_id" />			
		<result property="reviewCategory" resultMap="ReviewTask.categoryMAP" />
	</resultMap>
	
	<resultMap id="categoryMAP" class="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetCategoryVO" groupBy="ss_category_id">	
		<result property="ss_category_id" column="category_id" />
		<result property="category" column="category" />
		<result property="comments" column="comments" />
		<result property="scoreSheetSubCategory" resultMap="ReviewTask.subCategoryMAP" />
	</resultMap>
	
	<resultMap id="subCategoryMAP" class="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetSubCatgVO" groupBy="ss_sub_category_id">		
		<result property="ss_sub_category_id" column="scoresheet_subcateg_id" />
		<result property="sub_category" column="sub_category" />		
		<result property="applicability" column="applicability" />
		<result property="select" column="selected" />
		<result property="gradingPoint" resultMap="ReviewTask.gradingMAP" />
	</resultMap>
	
	<resultMap id="gradingMAP" class="com.worldcheck.atlas.vo.task.review.ReviewScoreSheetSubCatgVO" >		
		<result property="cnt_of_errors" column="cnt_of_errors" />
		<result property="score" column="score" />
		<result property="points" column="points" />
		
	</resultMap>
	 
    <select id="getReviewScoreSheetInfo" resultMap="scoreSheetMasterMAP" parameterClass="java.util.HashMap">
   SELECT 
		crscm.category category,
    	crscm.REVIEW_SS_CATEG_ID category_id,
		crscm.REVIEW_SHEET_ID sheet_id,
   		crscm.COMMENTS comments,
		crsscm.REVIEW_SS_SUBCATEG_ID scoresheet_subcateg_id, 
		crsscm.SUB_CATEGORY sub_category,
		crsscm.cnt_of_errors cnt_of_errors,
		crsscm.points points, 
		crsscm.SCORE score,
   		crsscm.APPLICABILITY applicability,
   		crsscm.SELECTED  selected  
    FROM 
			CMS_REV_SCORESHEET_CATEG_MAP crscm,CMS_REV_SCORESHEET_SUBCAT_MAP crsscm ,CMS_REVIEW_SCORESHEET_DETAILS CRSD,
			CMS_SCORESHEET_FLDS_DETAIL CSFD
	WHERE 
	crscm.REVIEW_SHEET_ID= CRSD.ID AND crscm.REVIEW_SS_CATEG_ID = crsscm.REVIEW_SS_CATEGORY_ID
        AND
			CRSD.ID= CSFD.sheet_id
		AND
       CRSD.SCORESHEET_NAME=#scoreSheetName#
		AND  
			TO_CHAR(TO_DATE(DATE_OF_REVIEW), 'MM') = $month$
		AND
			TO_CHAR(TO_DATE(DATE_OF_REVIEW), 'yyyy') = $year$ 
		ORDER BY crscm.REVIEW_SHEET_ID, crscm.category, crsscm.REVIEW_SS_SUBCATEG_ID asc

  </select>
  
  
  <select id="getReviewedSelectedItem" parameterClass="java.util.HashMap" resultClass="java.util.HashMap" remapResults="true">
 	select SHEET_ID,DATE_OF_REVIEW, COMPLEXITY, REVIEW_TIME,FINAL_INTERIM,PRIMARY_TEAM,SUPPORTING_TEAM_1,
 	SUPPORTING_TEAM_2,SUPPORTING_TEAM_3,SUPPORTING_TEAM_4,SUPPORTING_TEAM_5,
  	SUPPORTING_TEAM_6,REPORT_DUE_DATE,REVIEWER_1,REVIEWER_2,REVIEWER_3,GENERAL_COMMENT,SR_ANALYST,EDITOR,
  	DATE_REPORT_FILED,COMPLETE_OS_RCVD_DATE,REVIEWERS,crssfd.reviewer,crssfd.analyst,crssfd.crn,QUALITY_PERCENT,SCORE,

  	<!--Start: Added for BI-429 by 6032662 -->
  	(select distinct CASE
   	 WHEN CNT_OF_ERRORS <![CDATA[ <> ]]>'0' THEN
 	 	(select nvl(sum(max(points)), 0) from CMS_REV_SCORESHEET_SUBCAT_MAP where REVIEW_SS_CATEGORY_ID in
  				(select review_ss_categ_id from CMS_REV_SCORESHEET_CATEG_MAP where REVIEW_SHEET_ID=crssfd.id)
  			 	and sub_category in(select crssm.SUB_CATEGORY from 
      		 	CMS_REV_SCORESHEET_CATEG_MAP crscm, CMS_REV_SCORESHEET_SUBCAT_MAP crssm
      		 	where crssm.REVIEW_SS_CATEGORY_ID=crscm.REVIEW_SS_CATEG_ID and 
      		 	crssm.applicability = 'yes' and
      		 	REVIEW_SHEET_ID = crssfd.id) group by sub_category)
 	 WHEN CNT_OF_ERRORS = '0' THEN
  		(select nvl(sum(points), 0) from CMS_REV_SCORESHEET_SUBCAT_MAP where REVIEW_SS_CATEGORY_ID in
  		(select review_ss_categ_id from CMS_REV_SCORESHEET_CATEG_MAP where REVIEW_SHEET_ID = crssfd.id) 
  		and applicability = 'yes')
   	 END
 	from CMS_REV_SCORESHEET_SUBCAT_MAP where REVIEW_SS_CATEGORY_ID in
  	(select review_ss_categ_id from CMS_REV_SCORESHEET_CATEG_MAP where REVIEW_SHEET_ID = crssfd.id)
  	) TOTAL_POINT,
  <!--End: Added for BI-429 by 6032662 -->

	CASE WHEN 
		QUALITY_PERCENT <![CDATA[ >= ]]> 95 THEN 'OUTSTANDING'
		WHEN QUALITY_PERCENT <![CDATA[ >= ]]> 90 AND  QUALITY_PERCENT <![CDATA[ <= ]]> 94.99 THEN 'VERY GOOD'
		WHEN QUALITY_PERCENT <![CDATA[ >= ]]> 80 AND  QUALITY_PERCENT <![CDATA[ <= ]]> 89.99 THEN 'GOOD'
		WHEN QUALITY_PERCENT <![CDATA[ >= ]]> 70 AND  QUALITY_PERCENT <![CDATA[ <= ]]> 79.99 THEN 'AVERAGE'
		ELSE 'UNSATISFACTORY'
	END AS RATING
  from 
  cms_scoresheet_flds_detail cssfd,cms_review_scoresheet_details crssfd where 
  cssfd.sheet_id=crssfd.id
  AND
  crssfd.SCORESHEET_NAME = #scoreSheetName#
  AND  
  TO_CHAR(TO_DATE(DATE_OF_REVIEW), 'MM') = $month$
  AND
  TO_CHAR(TO_DATE(DATE_OF_REVIEW), 'yyyy') = $year$
  order by SHEET_ID asc
  
 </select>
 
 <delete id="deleteReviewedScoreSheet" parameterClass="java.lang.String">
	DELETE FROM cms_review_scoresheet_details WHERE id in($sheetIds$)
	</delete>
</sqlMap>