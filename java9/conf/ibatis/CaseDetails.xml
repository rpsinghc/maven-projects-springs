<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="CaseDetails">
<!--
	  by Chetan Bhandari
      This was fixed for PET ISSUE-60
	  -->
<resultMap id="resultCountryMasterVO" class="com.worldcheck.atlas.vo.masters.CountryMasterVO">
    <result property="countryCode" column="CODE"/>
    <result property="country" column="COUNTRY"/>
    <result property="countryMasterId" column="COUNTRY_MASTER_ID"/>
	<result property="englishCountry" column="IS_ENG_COUNTRY"/>

</resultMap>
	<select id="getCaseDetails" resultClass="com.worldcheck.atlas.vo.CaseDetails"
		parameterClass="java.lang.String">
		SELECT ccm.client_ref clientRef,
		ccm.CRN crn,
		ccm.REPORT_TYPE_ID reportTypeId,
		crtm.REPORT_TYPE reportType,
		ccm.OFFICE_ID officeId,
        com.OFFICE officeName,
        ccm.CASE_CREATOR_ID caseCreatorId,
		ccm.SFDC_OTN_NUMBERS sfdcOtnNumbers,
		ccm.REGIONAL_TERRITORY regionalTerritory,
        ccreator.USER_FULL_NAME caseCreatorFullName,
		TO_CHAR(ccm.REQ_RECD_DT,'dd-Mon-yyyy HH24:MI:SS') reqRecdDate1,
		ccm.SUB_REPORT_TYPE_ID subReportTypeId,
		csrtm.SUB_REPORT subReportType,
		ccm.IS_EXPRESS expressCase,
		ccm.CLIENT_INT_DUEDATE1 cInterim1,
		ccm.CLIENT_INT_DUEDATE2 cInterim2,
		ccm.FINAL_DUE_DATE finalDueDate,
		ccm.RSRCH_INT_DUEDATE1 rInterim1,
		ccm.RSRCH_INT_DUEDATE2 rInterim2,
		ccm.RSRCH_FINAL_DUE_DATE finalRDueDate,
		CONCAT(CONCAT( ccm.CLIENT_CODE , ' - '),cmm.CLIENT_NAME) clientName,
		ccm.CLIENT_CODE clientCode,
		ccm.CASE_MGR_ID caseMgrId,
        cum.USER_FULL_NAME caseManagerName,
		ccm.IS_AUTO_OFC_ASSIGN isAutoOfcAssign,
		ccm.CASE_INFO caseInfoBlock,
		ccm.CASE_STATUS_ID caseStatusId,
        ccsm.DESCRIPTION caseStatus,
        ccm.IS_RECUR_CASE isRecurCase,
        ccm.PID pid,
        ccm.IS_ISIS isISIS,
        ccm.CLIENT_INT_SENTDATE1 clientSentDate1,
        ccm.CLIENT_INT_SENTDATE2 clientSentDate2,
        ccm.CLIENT_FINAL_SENTDATE clientFinalDate,
        ccm.CLIENT_FEEDBACK clientFeedBack,
        ccm.SALES_REPRESENTATIVE salesRepresentative
		FROM
		cms_clientcase ccm,cms_client_master cmm,cms_user_master cum,cms_user_master ccreator,
		CMS_REPORT_TYPE_MASTER crtm,CMS_SUBREPORT_TYPE_MASTER csrtm,cms_office_master com,CMS_CASE_STATUS_MASTER ccsm
		WHERE cmm.CLIENT_CODE = ccm.CLIENT_CODE
		and crtm.REPORT_TYPE_MASTER_ID = ccm.REPORT_TYPE_ID
                and ccsm.CASE_STATUS_ID = ccm.CASE_STATUS_ID
                and ccreator.LOGIN_ID(+) = ccm.CASE_CREATOR_ID
                and com.OFFICE_MASTER_ID(+) = ccm.OFFICE_ID 
		and csrtm.SUBREPORT_TYPE_MASTER_ID(+) = ccm.SUB_REPORT_TYPE_ID
                and cum.LOGIN_ID(+) = ccm.CASE_MGR_ID
		and crn = #crn#
	</select>

	
	<select id="getLegacyCaseDetails" resultClass="com.worldcheck.atlas.vo.CaseDetails"
		parameterClass="java.lang.String">
		SELECT ccc.clientref clientRef,
		ccc.CRN crn,
		ccc.REPORTTYPEID reportTypeId,
		crtm.REPORT_TYPE reportType,
		ccc.OFFICEID officeId,
        com.OFFICE officeName,
		TO_CHAR(ccc.REQRECDDT,'dd-Mon-yyyy HH24:MI:SS') reqRecdDate1,
		'0' subReportTypeId,
		ccc.ISEXPRESS expressCase,
		ccc.INTCLIENTDUEDATE1 cInterim1,
		ccc.INTCLIENTDUEDATE2 cInterim2,
		ccc.FINALDUEDATE finalDueDate,
		ccc.INTRESEARCHDUEDATE1 rInterim1,
		ccc.INTRESEARCHDUEDATE2 rInterim2,
		ccc.RESEARCHFINALDUEDATE finalRDueDate,
		CONCAT(CONCAT( ccm.CLIENT_CODE , ' - '),ccm.CLIENT_NAME) clientName,
		ccm.CLIENT_CODE clientCode,
		ccc.CASEMGRID caseMgrId,
        cum.USER_FULL_NAME caseManagerName,
		'0' isAutoOfcAssign,
		ccsm.CASE_STATUS_ID caseStatusId,
        ccsm.DESCRIPTION caseStatus,
        '0' isRecurCase,
        '0' pid,
        ccc.INTSENTDATE1 clientSentDate1,
        ccc.INTSENTDATE2 clientSentDate2,
        ccc.FINALSENTDATE clientFinalDate,
        ccc.CLIENTFEEDBACK clientFeedBack
	FROM CLIENTCASE_MV ccc,
	  cms_client_master ccm,
	  cms_user_master cum,
	  cms_report_type_master crtm,
	  cms_office_master com,
	  cms_case_status_master ccsm
	WHERE ccm.client_code = ccc.clientcode
	 AND crtm.report_code = ccc.reporttypeid
	 AND ccsm.status_code = ccc.statuscode
	 AND com.office_master_id(+) = ccc.officeid 
	 AND cum.login_id(+) = ccc.casemgrid
	 AND crn = #crn#
	</select>

	<update id="updateCaseDetails" parameterClass="com.worldcheck.atlas.vo.CaseDetails">
		UPDATE
		CMS_CLIENTCASE set
		OFFICE_ID = (select
		office_master_id from
		cms_office_master where
		office=#officeId#),
		CASE_MGR_ID = #caseMgrId#,
		CLIENT_REF = #clientRef#,
		IS_EXPRESS = #expressCase#,
		FINAL_DUE_DATE = #finalDueDate#,
		CLIENT_INT_DUEDATE1 = #cInterim1#,
		CLIENT_INT_DUEDATE2 = #cInterim2#,
		RSRCH_INT_DUEDATE1= #rInterim1#,
		RSRCH_INT_DUEDATE2= #rInterim2#,
		RSRCH_FINAL_DUE_DATE= #finalRDueDate#,
		CASE_STATUS_ID = #caseStatusId#,
		SFDC_OTN_NUMBERS= #sfdcOtnNumbers#,
		REGIONAL_TERRITORY=#regionalTerritory#,
                SALES_REPRESENTATIVE = #salesRepresentative#,
		<isNotNull  property="clientSentDate1">
			<isNotEmpty property="clientSentDate1">
				CLIENT_INT_SENTDATE1  = #clientSentDate1#,
			</isNotEmpty>
		</isNotNull>
		<isNotNull  property="clientSentDate2">
			<isNotEmpty property="clientSentDate2">
				CLIENT_INT_SENTDATE2  = #clientSentDate2#,
			</isNotEmpty>
		</isNotNull>
		<isNotNull  property="clientFinalDate">
			<isNotEmpty property="clientFinalDate">
				CLIENT_FINAL_SENTDATE  = #clientFinalDate#,
			</isNotEmpty>
		</isNotNull>
		<isNotNull  property="clientFeedBack">
			<isNotEmpty property="clientFeedBack">
				CLIENT_FEEDBACK  = #clientFeedBack#,
			</isNotEmpty>
		</isNotNull>
		UPDATED_BY = #updatedBy#,
		UPDATED_ON = SYSDATE
		where CRN=#crn#
   </update>

  <update id="updateCaseFee" parameterClass="com.worldcheck.atlas.vo.CaseDetails">
	
	update CMS_Accounts set CASE_FEE = 0 where CRN = #crn#
		
  </update>
   
   <update id="updateRecCaseDetails" parameterClass="com.worldcheck.atlas.vo.CaseDetails">
		UPDATE
		CMS_RECURR_CLIENTCASE set
		OFFICE_ID = (select
		office_master_id from
		cms_office_master where
		office=#officeId#),
		CASE_MGR_ID = #caseMgrId#,
		IS_EXPRESS = #expressCase#,
		UPDATED_BY = #updatedBy#,
		UPDATED_ON = SYSDATE
		where CRN=#crn#
   </update>

    <update id="updateCaseStatus" parameterClass="com.worldcheck.atlas.vo.CaseDetails">
		update cms_clientcase
		set case_status_id = (select CASE_STATUS_ID from  CMS_CASE_STATUS_MASTER where DESCRIPTION = (#caseStatus#)),
		updated_by = #updatedBy#,
		UPDATED_ON = SYSDATE
		where crn = #crn#
   </update>

    <update id="updateClientFeedback" parameterClass="com.worldcheck.atlas.vo.CaseDetails">
		update cms_clientcase
		set CLIENT_FEEDBACK  = #clientFeedBack#,
		SFDC_OTN_NUMBERS= #sfdcOtnNumbers#,
		REGIONAL_TERRITORY=#regionalTerritory#,
		SALES_REPRESENTATIVE=#salesRepresentative#,
		updated_by = #updatedBy#,
		UPDATED_ON = SYSDATE
		where crn = #crn#
   </update>

	<select id="getCaseStatusMaster" resultClass="com.worldcheck.atlas.vo.CaseStatus">
		SELECT DESCRIPTION description,CASE_STATUS_ID caseStatusId
		FROM CMS_CASE_STATUS_MASTER
		ORDER BY DESCRIPTION
    </select>
<!--
	  by Chetan Bhandari
      This was fixed for PET ISSUE-60
	  -->
    <select id="getAllCountryMaster" resultMap="resultCountryMasterVO">
         SELECT CODE,COUNTRY,COUNTRY_MASTER_ID,IS_ENG_COUNTRY FROM CMS_COUNTRY_MASTER order by UPPER(COUNTRY)
</select>

	<select id="getOnHoldCases" resultClass="com.worldcheck.atlas.vo.task.MyOnHoldCaseVO" parameterClass="java.util.Map">
	SELECT * FROM (SELECT  searchResult.*, ROWNUM rn FROM (
	select distinct(ccm.crn) crn, ccm.case_creation_date, ccm.case_status_id,
	(select subject_name  from cms_subject where crn in(ccm.crn) AND is_primary_sub=1) as subject_name
	, (select country  from cms_country_master where country_master_id in(select country_id  from cms_subject where crn in(ccm.crn) AND is_primary_sub=1)) as country
	from CMS_CLIENTCASE ccm,
	CMS_TEAM_DETAILS ctd,
	CMS_SUB_TEAM_RE_MAP cstrm
	where ccm.CRN = ctd.crn(+)
	and ctd.crn = cstrm.crn(+)
	and (ccm.CASE_MGR_ID = #userId#
	or ctd.main_analyst = #userId# or ctd.REVIEWER1 =#userId# or
	ctd.REVIEWER2=#userId# or ctd.REVIEWER3 =#userId# or cstrm.performer=#userId#) and ccm.CASE_STATUS_ID=1 order by ccm.crn
	)searchResult WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
	</select>
	
	<select id="getCountOfOnHoldCases" resultClass="int" parameterClass="java.util.Map">
	select count(distinct(ccm.crn))
	from CMS_CLIENTCASE ccm,
	CMS_TEAM_DETAILS ctd,
	CMS_SUB_TEAM_RE_MAP cstrm
	where ccm.CRN = ctd.crn(+)
	and ctd.crn = cstrm.crn(+)
	and (ccm.CASE_MGR_ID = #userId#
	or ctd.main_analyst = #userId# or ctd.REVIEWER1 =#userId# or
	ctd.REVIEWER2=#userId# or ctd.REVIEWER3 =#userId# or cstrm.performer=#userId#) and ccm.CASE_STATUS_ID=1 
	</select>
	
	<!--  Added by ankit soral -->
	<select id="getCrn" resultClass="java.lang.String" parameterClass="java.lang.Long">
	select crn from cms_clientcase where pid=#pid#
	</select>
	<!-- Query Ends -->
	

<select id= "getRecurranceCaseDetails" parameterClass = "java.lang.String" resultClass = "com.worldcheck.atlas.vo.CaseDetails">
select crcc.RECUR_CLIENTCASE_ID recurrNumber,
crcc.CRN crn,
ccm.client_code ||'-'||ccm.CLIENT_NAME clientName,
crcc.CLIENT_REF clientRef,
crtm.report_type reportType,
csrtm.sub_report subReportType,
com.OFFICE_CODE officeName,
cum.login_id caseManagerName,
crcc.IS_EXPRESS expressCase,
crcc.FINAL_DUE_DAYS finalDueDays,
crcc.INT_CLIENT_DUEDAYS1 cInterim1Days,
crcc.INT_CLIENT_DUEDAYS2 cInterim2Days,
crcc.RECURR_PATTERN recurrencePattern,
crcc.RECURR_RANGE recurrenceRange,
crcc.RECURR_ENDDATE recurrenceEndDate,
crcc.NOOFRECURRENCES noOfRecurrences,
crcc.CASE_FEE caseFee,
crcc.CURRENCY_CODE caseCurrency
from cms_recurr_clientcase crcc join cms_client_master ccm
on crcc.client_code = ccm.client_code
join cms_report_type_master crtm
on crcc.report_type_id = crtm.report_type_master_id 
 left join cms_subreport_type_master csrtm
on crcc.sub_report_type_id = csrtm.subreport_type_master_id
join cms_office_master com
on crcc.office_id = com.office_master_id
join cms_user_master cum
on crcc.CASE_MGR_ID = cum.LOGIN_ID
where crcc.crn = #crn#


</select>


<update id="updateRecurranceCaseDetails" parameterClass="com.worldcheck.atlas.vo.CaseDetails" >
UPDATE CMS_RECURR_CLIENTCASE 
SET case_mgr_id = (SELECT login_id FROM cms_user_master WHERE LOGIN_ID = #caseManagerName#), 
OFFICE_ID = (select office_master_id from cms_office_master where OFFICE_CODE = #officeName#), 
<isNotNull  property="cInterim1Days">
	<isNotEmpty property="cInterim1Days">
		INT_CLIENT_DUEDAYS1  = #cInterim1Days#,
	</isNotEmpty>
	<isEmpty property="cInterim1Days">
		INT_CLIENT_DUEDAYS1  = 0,
	</isEmpty>
	
</isNotNull>
<isNotNull  property="cInterim2Days">
	<isNotEmpty property="cInterim2Days">
		INT_CLIENT_DUEDAYS2  = #cInterim2Days#,
	</isNotEmpty>
	<isEmpty property="cInterim2Days">
		INT_CLIENT_DUEDAYS2  = 0,
	</isEmpty>
	
</isNotNull>

IS_EXPRESS = #expressCase#, 
CASE_FEE = #caseFee#, 
CURRENCY_CODE = #caseCurrency#, 
FINAL_DUE_DAYS = #finalDueDays#

where crn = #crn#
and RECUR_CLIENTCASE_ID = #recurrNumber#

</update>


<update id="updateResearchDueDates" parameterClass="com.worldcheck.atlas.vo.CaseDetails" >
UPDATE
		CMS_CLIENTCASE set
<isNotNull  property="rInterim1">
	<isNotEmpty property="rInterim1">
		RSRCH_INT_DUEDATE1  = #rInterim1#,
	</isNotEmpty>
</isNotNull>
<isNotNull  property="rInterim2">
	<isNotEmpty property="rInterim2">
		RSRCH_INT_DUEDATE2  = #rInterim2#,
	</isNotEmpty>
</isNotNull>
<isNotNull  property="finalRDueDate">
	<isNotEmpty property="finalRDueDate">
		RSRCH_FINAL_DUE_DATE  = #finalRDueDate#,
	</isNotEmpty>
</isNotNull>
UPDATED_BY = #updatedBy#,
		UPDATED_ON = SYSDATE
		where CRN=#crn#
</update>

<update id="updateSavvionCaseDetails" parameterClass="com.worldcheck.atlas.vo.CaseDetails">
		UPDATE
		CMS_CLIENTCASE set
		OFFICE_ID = (select
		office_master_id from
		cms_office_master where
		office=#officeId#),
		CASE_MGR_ID = #caseMgrId#,
		CLIENT_REF = #clientRef#,
		IS_EXPRESS = #expressCase#,
		FINAL_DUE_DATE = #finalDueDate#,
		CLIENT_INT_DUEDATE1 = #cInterim1#,
		CLIENT_INT_DUEDATE2 = #cInterim2#,
		RSRCH_INT_DUEDATE1= #rInterim1#,
		RSRCH_INT_DUEDATE2= #rInterim2#,
		RSRCH_FINAL_DUE_DATE= #finalRDueDate#,
		CASE_STATUS_ID = (select CASE_STATUS_ID  from CMS_CASE_STATUS_MASTER where DESCRIPTION = #caseStatus#),
		UPDATED_BY = #updatedBy#,
		UPDATED_ON = SYSDATE
		where CRN=#crn#
   </update>
   
   <update id="updateCaseInfo" parameterClass="com.worldcheck.atlas.vo.CaseDetails">
   		UPDATE
		CMS_CLIENTCASE set
		CASE_INFO = #caseInfo#
		where CRN=#crn#
   </update>

   <select id="getCaseStatus" resultClass="com.worldcheck.atlas.vo.CaseDetails"
		parameterClass="java.lang.String">
		SELECT ccm.CRN crn,
		ccm.CASE_STATUS_ID caseStatusId,
        ccsm.DESCRIPTION caseStatus
		FROM cms_clientcase ccm,CMS_CASE_STATUS_MASTER ccsm
		WHERE ccsm.CASE_STATUS_ID = ccm.CASE_STATUS_ID
			and crn = #crn#
	</select>

	<select id="getCaseDetailsForPid" resultClass="com.worldcheck.atlas.vo.CaseDetails"
			parameterClass="java.lang.String">
			SELECT ccm.CRN crn,
			ccm.CASE_MGR_ID caseMgrId
			FROM cms_clientcase ccm
			WHERE PID = #pid#
	</select>
	
	<select id="getResearchHeadDetails" resultClass="java.lang.String"
			parameterClass="java.lang.String">
			SELECT RESEARCH_HEAD
				FROM CMS_TEAM_DETAILS 
				WHERE CRN = #crn#
				AND RESEARCH_HEAD IS NOT NULL
	</select>
	<select id="getTeamManagerDetails" resultClass="java.lang.String"
			parameterClass="java.lang.String">
			SELECT MANAGER_ID
				FROM CMS_TEAM_DETAILS 
				WHERE CRN = #crn#
				AND MANAGER_ID IS NOT NULL
	</select>
	
	
	<resultMap id="casePIDResultMap" class="java.util.HashMap">   
	<result property="key" column="CRN"/> 
	 <result property="value" column="PID"/>
</resultMap>
<select id="getPIDsForBulkCRN" resultMap="casePIDResultMap" parameterClass="java.util.List" remapResults="true">
		 SELECT to_char(PID) PID,CRN
	FROM CMS_CLIENTCASE
	WHERE CRN IN 
				<iterate open="(" close=")" conjunction=",">
					#crn[]#
				</iterate>
</select> 
	
<resultMap id="emailCaseDeatils" class="com.worldcheck.atlas.vo.EmailTemplateVO" groupBy="crn">
	<result property="crn" column="CRN"/> 
	<result property="caseManager" column="user_full_name"/> 
	<result property="interim1CDD" column="client_int_duedate1"/> 
	<result property="interim2CDD" column="client_int_duedate2"/> 
	<result property="finalCDD" column="final_due_date"/> 
	<result property="clientReferenceNumber" column="client_ref"/> 
	<result property="emailBody" column="email_body"/> 
	<result property="emailTO" column="email_to"/> 
	<result property="emailCC" column="email_cc"/> 
	<result property="emailBCC" column="email_bcc"/> 
	<result property="defaultMailingList" column="default_mailing_list"/> 
	<result property="subjectDetailsList" resultMap="CaseDetails.emailSubjectList"/> 
</resultMap>

<resultMap id="emailSubjectList" class="com.worldcheck.atlas.vo.SubjectDetails">
	<result property="subjectName" column="subject_name"/> 
	<result property="entityName" column="entity_name"/> 
	<result property="countryName" column="country"/> 
</resultMap>

<select id="getMailBody" resultMap="emailCaseDeatils" parameterClass="java.util.Map">
	select cc.crn,
	cum.user_full_name,
	cc.client_int_duedate1 ,
	cc.client_int_duedate2,
	cc.final_due_date,
	cc.client_ref,
	cs.subject_name,
	cem.entity_name,
	ccm.country,
	ctm.email_body,
	cced.email_to,
	cced.email_cc,
	cced.email_bcc,
	ctm.default_mailing_list
	from cms_clientcase cc,
	cms_user_master cum,
	cms_template_master ctm,
	cms_client_email_details cced,
	cms_subject cs,
	cms_entitytype_master cem,
	cms_country_master ccm
	where
	cc.crn = cs.crn
	AND cem.ENTITY_TYPE_ID = cs.ENTITY_TYPE_ID
	AND cc.case_mgr_id = cum.login_id
	AND ctm.email_template_id = cced.email_template_id
	AND ccm.country_master_id = cs.country_id
	AND cc.crn=#crn#
	AND cced.client_code = #clientCode#
	<isEqual prepend="AND" property="isAtlas" compareValue="1">
	 cced.is_atlas = to_number(#isAtlas#)
	</isEqual>
	<isEqual prepend="AND" property="isIsis" compareValue="1">
	 cced.is_isis = to_number(#isIsis#)
	 AND cced.is_bulk = to_number(#isBulk#)
	</isEqual>

</select>

<insert id="insertMailLogs" parameterClass="com.worldcheck.atlas.vo.EmailTemplateVO">
	INSERT INTO
	CMS_CASE_CREATION_EMAIL_LOG(EMAIL_SENT_ID,CRN,CLIENT_CODE,EMAIL_TO,EMAIL_CC,EMAIL_BCC,EMAIL_BODY,IS_SENT)
	VALUES (CMS_CASE_CREATION_EMAIL_SEQ.nextVal,#crn#,#clientCode#,#emailTO#,#emailCC#,#emailBCC#,#finalEmailBody#,to_number(#isEmailSent#))
</insert>
	
</sqlMap>