<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
 "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="TeamPerformance">

 <resultMap id="userNamesResultMap" class="com.worldcheck.atlas.vo.report.TeamPerformance">
		
		<result property="userLoginId" column="LOGIN_ID"/>
		<result property="userFullName" column="userFullName"/>
</resultMap>

<select id="getUsersForTeamPerformance"  resultMap="userNamesResultMap" parameterClass="java.lang.String">
	SELECT distinct(CUM.LOGIN_ID) LOGIN_ID,
	CUM.USER_FULL_NAME userFullName
	FROM CMS_USER_MASTER CUM
	WHERE LEVEL>1
	START WITH upper(LOGIN_ID) =upper(#userId#) CONNECT BY PRIOR upper(LOGIN_ID) = upper(REPORTS_TO)
   order by LOGIN_ID
</select>


<insert id="saveTemplate" parameterClass="com.worldcheck.atlas.vo.report.TeamPerformance">
	<selectKey resultClass="int" type="pre" keyProperty="templateId">
		select CMS_TEAMPERF_TEMP_SEQ.NEXTVAL AS VALUE FROM DUAL
   </selectKey>
		insert into CMS_TEAM_PERFORMANCE_TEMPLATE (
			TEMPLATE_ID,
			TEMPLATE_NAME,
			TEMPLATE_TYPE,
			TEMPLATE_VALUE,
			TEMPLATE_CREATOR,
			TEMPLATE_CREATION_DATE
	)values (
			#templateId#,
			#templateName#,
			#templateType#,
			#templateValue#,
			#userLoginId#,
			sysdate
	)
</insert>

 <resultMap id="templateNamesResultMap" class="com.worldcheck.atlas.vo.report.TeamPerformance">
		
		<result property="commaSepTemplateIdAndType" column="COMMA_SEP_ID_TYPE"/>
		<result property="templateName" column="TEMPLATE_NAME"/>
</resultMap>

<select id="getTemplateForUsers"  resultMap="templateNamesResultMap" parameterClass="java.lang.String">
	 SELECT TEMPLATE_ID|| ','|| TEMPLATE_TYPE as COMMA_SEP_ID_TYPE  ,TEMPLATE_NAME 
	 FROM CMS_TEAM_PERFORMANCE_TEMPLATE WHERE TEMPLATE_CREATOR=#userLoginId#
	  order by upper(TEMPLATE_NAME)
</select>

<select id="checkUserTemplateExists" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		SELECT count(*) FROM CMS_TEAM_PERFORMANCE_TEMPLATE 
        WHERE TEMPLATE_CREATOR=#userId#
        AND upper(TEMPLATE_NAME)=upper(#templateName#)
	</select> 

<delete id="deleteTemplate" parameterClass="java.lang.String">
	DELETE FROM CMS_TEAM_PERFORMANCE_TEMPLATE WHERE TEMPLATE_ID = #templateId#
</delete> 


<select id="getTeamPerformanceResultForOfficeTemplate"  remapResults="true" resultClass="java.util.LinkedHashMap" parameterClass="java.util.HashMap">
		SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (SELECT SUPERVISOR,ANALYST, USERNAME,to_char(to_date(month ,'MM'),'Month') MONTH,SUM(TOTAL_POINTS)TOTAL_POINTS,SUM(TOTAL_REPORTS)TOTAL_REPORTS,
       <iterate property="queryStringList" conjunction=",">
				$queryStringList[]$
		</iterate>        
        FROM CMS_TEAM_PERFORMANCE_TEMPLATE tpt,DW_DB_TEAM_PERFORMANCE tps
        WHERE TEMPLATE_ID =#templateId# 
        AND tps.OFFICE =DBMS_LOB.SUBSTR(TEMPLATE_VALUE, 20000,1) AND YEAR=#year# AND MONTH =#month#
        group by username,month,SUPERVISOR ,ANALYST order by upper(ANALYST)) a WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>
		
		

<select id="getTeamPerformanceResultForUserTemplate"  remapResults="true" resultClass="java.util.LinkedHashMap"  parameterClass="java.util.HashMap">
	 SELECT * FROM (SELECT  a.*, ROWNUM rn FROM ( SELECT SUPERVISOR,ANALYST,USERNAME, to_char(to_date(month ,'MM'),'Month') MONTH,
      SUM(TOTAL_POINTS)TOTAL_POINTS,SUM(TOTAL_REPORTS)TOTAL_REPORTS,
	   <iterate property="queryStringList" conjunction=",">
				$queryStringList[]$
		</iterate> 
	  FROM DW_DB_TEAM_PERFORMANCE ddtp, 
	  (
		  SELECT TRIM( SUBSTR ( txt , INSTR (txt, ',', 1, level ) +1, INSTR (txt, ',',1, level+1) - INSTR (txt, ',', 1, level) -1))
			AS USER_NAME
			FROM (  select ','||template_value  as txt from cms_team_performance_template where template_id = #templateId#)
			CONNECT BY level &lt;= 
			LENGTH(txt)-LENGTH(REPLACE(txt,',',''))-1		  
	  )CMS_TEMPLATE_USERS
	  WHERE ddtp.username = DBMS_LOB.SUBSTR(CMS_TEMPLATE_USERS.USER_NAME, 20000,1) 
	  AND YEAR=#year# AND MONTH =#month#  group by username,month,SUPERVISOR ,ANALYST order by upper(ANALYST)) a WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>
<select id="getReportForOfficeTemplateForExcelDownload"  remapResults="true" resultClass="java.util.LinkedHashMap" parameterClass="java.util.HashMap">
		SELECT SUPERVISOR,ANALYST, USERNAME,to_char(to_date(month ,'MM'),'Month') MONTH,SUM(TOTAL_POINTS)TOTAL_POINTS,SUM(TOTAL_REPORTS)TOTAL_REPORTS,
       <iterate property="queryStringList" conjunction=",">
				$queryStringList[]$
		</iterate>        
        FROM CMS_TEAM_PERFORMANCE_TEMPLATE tpt,DW_DB_TEAM_PERFORMANCE tps
        WHERE TEMPLATE_ID =#templateId# 
	AND tps.OFFICE =DBMS_LOB.SUBSTR(TEMPLATE_VALUE, 20000,1) AND YEAR=#year# AND MONTH =#month#
        group by username,month,SUPERVISOR ,ANALYST order by upper(ANALYST)
</select>

		
		
<select id="getReportForUserTemplateForExcelDownload"  remapResults="true" resultClass="java.util.LinkedHashMap"  parameterClass="java.util.HashMap">
	 SELECT SUPERVISOR,ANALYST,USERNAME,to_char(to_date(month ,'MM'),'Month') MONTH,
      SUM(TOTAL_POINTS)TOTAL_POINTS,SUM(TOTAL_REPORTS)TOTAL_REPORTS,
	   <iterate property="queryStringList" conjunction=",">
				$queryStringList[]$
		</iterate> 
	  FROM DW_DB_TEAM_PERFORMANCE ddtp, 
	  (
		  SELECT TRIM( SUBSTR ( txt , INSTR (txt, ',', 1, level ) +1, INSTR (txt, ',',1, level+1) - INSTR (txt, ',', 1, level) -1))
			AS USER_NAME
			FROM (  select ','||template_value  as txt from cms_team_performance_template where template_id = #templateId#)
			CONNECT BY level &lt;= 
			LENGTH(txt)-LENGTH(REPLACE(txt,',',''))-1		  
	  )CMS_TEMPLATE_USERS
	  WHERE ddtp.username = DBMS_LOB.SUBSTR(CMS_TEMPLATE_USERS.USER_NAME, 20000,1) 
	  AND YEAR=#year# AND MONTH =#month#  group by username,month,SUPERVISOR ,ANALYST order by upper(ANALYST)
</select>



<resultMap id="teamPerformanceDetailResultMap" class="com.worldcheck.atlas.vo.report.TeamPerformanceDetail">
		

		<result property="userLoginId" column="Analyst"/>
		<result property="team" column="TEAM"/>
		<result property="teamJLP" column="TOTAL_POINTS"/>
		<result property="teamReportCount" column="TOTAL_REPORTS"/>
		
</resultMap>

<select id="getTeamPerformanceDetailResult"  resultMap="teamPerformanceDetailResultMap" parameterClass="java.util.Map">
	select Analyst,TEAM,TOTAL_POINTS,TOTAL_REPORTS  
	FROM DW_DB_TEAM_PERFORMANCE WHERE YEAR=#year# AND MONTH =#month#
	and Analyst IN 
			<iterate open="(" close=")" conjunction="," property="teamPerformanceUserNameList">
			#teamPerformanceUserNameList[]#
			</iterate>	
	  order by upper(ANALYST),team
</select>

<resultMap id="reportTypeMap" class="com.worldcheck.atlas.vo.masters.ReportTypeMasterVO">
		<result property="initialsUseCRN" column="REPORT_CRN_INITIAL"/>
		<result property="reportType" column="REPORT_CRN_INITIAL2"/>	
</resultMap>

<select id="getAllReportTypes"  resultMap="reportTypeMap">
	select  'SAMPLE' ||REPORT_CRN_INITIAL as REPORT_CRN_INITIAL ,REPORT_CRN_INITIAL as REPORT_CRN_INITIAL2
    from CMS_REPORT_TYPE_MASTER where status=1
    order by REPORT_TYPE_MASTER_ID
</select>

<select id="getResultCountForUserTemplate"  resultClass="java.lang.Integer"  parameterClass="java.util.HashMap">
	   select count(*)from(
		  SELECT ANALYST
		  FROM DW_DB_TEAM_PERFORMANCE ddtp, 
		  (
			  SELECT TRIM( SUBSTR ( txt , INSTR (txt, ',', 1, level ) +1, INSTR (txt, ',',1, level+1) - INSTR (txt, ',', 1, level) -1))
				AS USER_NAME
				FROM (  select ','||template_value  as txt from cms_team_performance_template where template_id = #templateId#)
				CONNECT BY level &lt;= 
				LENGTH(txt)-LENGTH(REPLACE(txt,',',''))-1		  
		  )CMS_TEMPLATE_USERS
		  WHERE ddtp.username = DBMS_LOB.SUBSTR(CMS_TEMPLATE_USERS.USER_NAME, 20000,1) 
		  AND YEAR=#year# AND MONTH =#month#  group by username,month,SUPERVISOR ,ANALYST
	  )
</select>
<select id="getResultCountForOfficeTemplate"  resultClass="java.lang.Integer" parameterClass="java.util.HashMap">
		 select count(*)from(SELECT ANALYST
		FROM CMS_TEAM_PERFORMANCE_TEMPLATE tpt,DW_DB_TEAM_PERFORMANCE tps
        WHERE TEMPLATE_ID =#templateId# 
        AND tps.OFFICE =DBMS_LOB.SUBSTR(TEMPLATE_VALUE, 20000,1) AND YEAR=#year# AND MONTH =#month#
        group by username,month,SUPERVISOR ,ANALYST )
</select>

</sqlMap>