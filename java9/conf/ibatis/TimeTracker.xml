<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="TimeTracker">

		<insert id="startTT" parameterClass="com.worldcheck.atlas.vo.timetracker.TimeTrackerVO">
			<selectKey resultClass="int" type="pre" keyProperty="trackerId">
					SELECT CMS_TIMETRACKER_SEQ.nextval AS VALUE FROM DUAL
		    </selectKey>
		   INSERT INTO CMS_TIMETRACKER( TRACKER_ID,CRN,USER_ID,START_TIME,TASK_NAME,REPORT_TYPE,TASK_PID,PROCESS_CYCLE,TASK_STATUS,UPDATED_BY,UPDATED_ON)
          	VALUES (#trackerId#,#crn#,#userName#,systimestamp,#taskName#,
                  	(select crtm.REPORT_TYPE from CMS_CLIENTCASE ccc,CMS_REPORT_TYPE_MASTER crtm 
                      	where ccc.CRN = #crn# and ccc.REPORT_TYPE_ID=crtm.REPORT_TYPE_MASTER_ID),
                #taskPid#,#processCycle#,#taskStatus#,#updatedBy#,SYSDATE) 						
		</insert>
		
		<update id="stopTT" parameterClass="com.worldcheck.atlas.vo.timetracker.TimeTrackerVO">
			UPDATE CMS_TIMETRACKER 
			  SET END_TIME = systimestamp,
			  UPDATED_BY = #updatedBy#,
			  UPDATED_ON = SYSDATE
			  WHERE USER_ID =#userName# and CRN = #crn# and TASK_NAME = #taskName# 
			  and TASK_PID = #taskPid# and END_TIME is null
	   </update>
		
	   <select id="getOnTrackerInfo" resultClass="com.worldcheck.atlas.vo.timetracker.TimeTrackerVO" parameterClass="java.lang.String">
	   		select TRACKER_ID trackerId, USER_ID userName,CRN crn,TASK_NAME taskName,TASK_PID taskPid,PROCESS_CYCLE processCycle 
	   		from CMS_TIMETRACKER 
	   		where USER_ID = #userId# and END_TIME is null order by START_TIME desc
	   </select>
	   
	   <select id="checkTTOnForTask"  parameterClass = "java.util.Map" resultClass="java.lang.Integer">
		   select count(*) from CMS_TIMETRACKER 
		   where END_TIME is null and CRN = #crn# and TASK_NAME = #taskName# and USER_ID != #userId#
	   </select>
	   
	   <update id="stopTTForUser" parameterClass="java.lang.String">
	   		UPDATE CMS_TIMETRACKER 
			  SET END_TIME = systimestamp,
			  UPDATED_BY = #userId#,
			  UPDATED_ON = SYSDATE
			  WHERE USER_ID =#userId# and END_TIME is null
	   </update>
	   
	   <update id="stopAllTTForCase" parameterClass="java.util.HashMap">
	   		UPDATE CMS_TIMETRACKER 
			  SET END_TIME = systimestamp,
			  UPDATED_BY = #userId#,
			  UPDATED_ON = SYSDATE
			  WHERE CRN =#crn# and END_TIME is null
	   </update>
		
	   <select id="getTrackerInfoForCase" resultClass="com.worldcheck.atlas.vo.timetracker.TimeTrackerVO" parameterClass="java.lang.String">
	   		select TRACKER_ID trackerId, USER_ID userName,CRN crn,TASK_NAME taskName,TASK_PID taskPid,PROCESS_CYCLE processCycle 
	   		from CMS_TIMETRACKER 
	   		where CRN = #crn# and END_TIME is null
	   </select>
		
	   <select id="checkTTForUserTask" parameterClass="com.worldcheck.atlas.vo.timetracker.TimeTrackerVO" resultClass="java.lang.Integer">
	   		select count(*) from CMS_TIMETRACKER 
			  WHERE USER_ID =#userName# and END_TIME is null and TASK_NAME = #taskName#
	   </select>
		
</sqlMap>