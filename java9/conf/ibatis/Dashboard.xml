<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
 "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Dashboard">

 <resultMap id="topClientResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO">
		<result property="clientName" column="CLIENT_CODE"/>	
		<result property="numberOfCases" column="CASE_COUNT"/>
		<result property="revenueStr" column="REVENUE"/>
</resultMap>

<select id="getTopClientMetrics"  resultMap="topClientResult" parameterClass="java.util.HashMap">
	SELECT CLIENT_CODE ,CASE_COUNT ,REVENUE FROM DW_TOP20_CLIENT where year=#year# AND MONTH = #month#  ORDER BY REVENUE DESC
</select>


<resultMap id="profitReportResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="reportCrnInitial" column="REPORT_CRN_INITIAL"/>
   <result property="profit" column="PROFIT"/>

</resultMap>

<select id="getProfitReport"  resultMap="profitReportResult" parameterClass="java.util.HashMap">
	SELECT REPORT_CRN_INITIAL,PROFIT FROM DW_STATS_PER_REPORT WHERE YEAR =#year# AND MONTH = #month# ORDER BY REPORT_TYPE_MASTER_ID
</select>


<resultMap id="expenditureReportResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="reportCrnInitial" column="REPORT_CRN_INITIAL"/>
   <result property="expenditure" column="EXPENDITURE"/>

</resultMap>

<select id="getExpenditureReport"  resultMap="expenditureReportResult" parameterClass="java.util.HashMap">
	SELECT REPORT_CRN_INITIAL,EXPENDITURE FROM DW_STATS_PER_REPORT WHERE YEAR =#year# AND MONTH = #month# ORDER BY  REPORT_TYPE_MASTER_ID 
</select>

<resultMap id="revenueReportResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="reportCrnInitial" column="REPORT_CRN_INITIAL"/>
   <result property="revenue" column="REVENUE"/>

</resultMap>

<select id="getRevenueReport"  resultMap="revenueReportResult" parameterClass="java.util.HashMap">
	SELECT REPORT_CRN_INITIAL,REVENUE FROM DW_STATS_PER_REPORT WHERE YEAR =#year# AND MONTH = #month# ORDER BY REPORT_TYPE_MASTER_ID 
</select>


<resultMap id="OfficeRevenueReportResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="office" column="OFFICE"/>
   <result property="revenue" column="CMP_REVENUE"/>
   <result property="wipRevenue" column="WIP_REVENUE"/>

</resultMap>

<select id="getOfficeRevenueReport"  resultMap="OfficeRevenueReportResult" parameterClass="java.util.HashMap">
	select office,CMP_REVENUE,WIP_REVENUE from DW_DB_OFC_REV where CALENDAR_YEAR=#year# and CALENDAR_MONTH=#month#
</select>

<resultMap id="OfficeJLPReportResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="office" column="OFFICE"/>
   <result property="completedJLP" column="CMP_JLP"/>
   <result property="inProgressJLP" column="WIP_JLP"/>
</resultMap>

<select id="getOfficeJLPReport"  resultMap="OfficeJLPReportResult" parameterClass="java.util.HashMap">
     select com.office , nvl(cmp_jlp,0)cmp_jlp , nvl(wip_jlp,0)wip_jlp
        from cms_office_master com
        left join ( 
	select  
	office,round((sum(cmp_jlp)/ANALYST_COUNT),2) cmp_jlp,round((sum(wip_jlp)/ANALYST_COUNT),2) as wip_jlp
	from dw_db_team_ofc_jlp
	where calendar_year=#year# and calendar_month =#month#
	group by office ,ANALYST_COUNT
        )  recordTable

        on recordTable.office = com.office
        where com.status=1
        order by com.office
</select>

<resultMap id="MyTeamLeaveReportResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="dateinStringFormat" column="FROM_DATE1"/>
	<result property="toDate" column="TO_DATE1"/>
	<result property="userName" column="userFullName"/>
   <result property="leaveType" column="LEAVETYPE"/>

</resultMap>

<select id="getTeamLeaveReport"  resultMap="MyTeamLeaveReportResult" parameterClass="java.util.HashMap">
	SELECT SELFTEAM.userFullName,
	to_char(cul.FROM_DATE,'dd-mm-yyyy') FROM_DATE1,
to_char(cul.TO_DATE,'dd-mm-yyyy') TO_DATE1,
	cltm.DESCRIPTION AS LEAVETYPE
	FROM CMS_USER_LEAVE cul,
	(
		SELECT distinct(CUM.LOGIN_ID) username,
		CUM.USER_FULL_NAME userFullName
		FROM CMS_USER_MASTER CUM
		WHERE LEVEL>=1
		START WITH upper(LOGIN_ID) =upper(#userId#) CONNECT BY NOCYCLE PRIOR upper(LOGIN_ID) = upper(REPORTS_TO)
	) SELFTEAM , CMS_LEAVE_TYPE_MASTER cltm 
	where SELFTEAM.username=cul.USER_ID
	AND cul.LEAVE_TYPE =cltm.LEAVE_TYPE_MASTER_ID
	AND(
	  TO_CHAR(FROM_DATE, 'yyyy')=#year# OR TO_CHAR(TO_DATE, 'yyyy')=#year#
	)
	AND(
	  TO_NUMBER(TO_CHAR(FROM_DATE, 'MM'))=#month# OR TO_NUMBER(TO_CHAR(TO_DATE, 'MM'))=#month#
	)
	ORDER BY FROM_DATE DESC

</select>

<resultMap id="PublicHolidayResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="office" column="OFFICE"/>
	<result property="dateinStringFormat" column="DATED_ON"/>
   <result property="publicHoliday" column="HOLIDAY_DESC"/>
</resultMap>

<select id="getPublicHolidayReport"  resultMap="PublicHolidayResult" parameterClass="java.util.HashMap">
	SELECT OFFICE,TO_CHAR(TO_DATE(DATED_ON,'DD Mon RRRR'),'DD Mon RRRR') as DATED_ON,HOLIDAY_DESC
	FROM CMS_HOLIDAY_MASTER chm
	LEFT JOIN CMS_OFFICE_MASTER com ON com.OFFICE_MASTER_ID =chm.OFFICE_ID
	WHERE TO_CHAR(DATED_ON, 'YYYY')=#year#
	AND TO_NUMBER(TO_CHAR(DATED_ON, 'MM'))=#month#
	ORDER BY OFFICE,DATED_ON

</select>

<resultMap id="CaseOverDueResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="crn" column="crn"/>
	<result property="i1DueDate" column="interim1DueDate"/>
   <result property="i2DueDate" column="interim2DueDate"/>
   <result property="finalDueDate" column="finalDate"/>
</resultMap>

<select id="getCaseOverDue"  resultMap="CaseOverDueResult" >
	select CRN crn, 
	wm_concat(TO_CHAR(TEAM_INT_DUE_DATE1,'DD-MM-YYYY')) interim1DueDate,
	wm_concat(TO_CHAR(TEAM_INT_DUE_DATE2,'DD-MM-YYYY')) interim2DueDate, 
	wm_concat(TO_CHAR(TEAM_FINAL_DUE_DATE,'DD-MM-YYYY')) finalDate
	from  dw_overdue_team_lvl
	GROUP BY CRN, PRIMARY_SUBJECT_NAME
</select>

<select id="getUserOfficeId" parameterClass="java.lang.String" resultClass="java.lang.Integer">
		select office_id  as office
		from cms_user_master
		where login_id=#userId#
</select>

<resultMap id="CaseOverDueR2R9Result" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
	<result property="crn" column="crn"/>
	<result property="i1DueDate" column="interim1DueDate"/>
   <result property="i2DueDate" column="interim2DueDate"/>
   <result property="finalDueDate" column="finalDate"/>
</resultMap>

<select id="getCaseOverDueR2R9"  resultMap="CaseOverDueR2R9Result" parameterClass="java.util.HashMap">
	select distinct crn,  
	TO_CHAR(CLIENT_INT_DUE_DATE1, 'DD-MM-YYYY') interim1DueDate,
	nvl(TO_CHAR(CLIENT_INT_DUE_DATE2, 'DD-MM-YYYY'),'') interim2DueDate, 
	TO_CHAR(CLIENT_FINAL_DUE_DATE, 'DD-MM-YYYY') finalDate
	from dw_overdue_case_lvl
	ORDER BY CRN
</select>


<resultMap id="TeamJLPReportResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
    <result property="userName" column="ANALYST"/>
   <result property="completedJLP" column="CMP_JLP"/>
   <result property="inProgressJLP" column="WIP_JLP"/>
</resultMap>

<select id="getTeamJLPReport"  resultMap="TeamJLPReportResult" parameterClass="java.util.HashMap">
	select analyst,
	round((cmp_jlp/team_analyst.ANALYST_COUNT),2)CMP_JLP ,
	round((WIP_JLP/team_analyst.ANALYST_COUNT),2) WIP_JLP
	from dw_db_team_ofc_jlp tJlp,
	cms_user_master cum , 
	(select count(login_id) analyst_count
	          from cms_user_master CUM, CMS_USER_ROLE_MAP CURP
	          where REPORTS_TO= #userId# and CUM.user_master_id = CURP.USER_ID
	          and CURP.role_id = 'R11'
	    ) team_analyst 
	where  cum.LOGIN_ID= tJlp.ANALYST and cum.REPORTS_TO=#userId# 
	 and calendar_year=#year# and calendar_month =#month#
</select>

<resultMap id="OfficeCasesWipCmpResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
    <result property="office" column="OFFICE"/>

</resultMap>

<select id="getOfficeCasesWipCmpReport"  remapResults="true" resultClass="java.util.LinkedHashMap" parameterClass="java.util.HashMap">
	SELECT OFFICE,
	<iterate property="queryStringList" conjunction=",">
				$queryStringList[]$
	    	</iterate>
	from DW_DB_OFC_CASES_WIP_CMP
    where year = #year# and month =#month#
	GROUP BY OFFICE
</select>

<resultMap id="TotalCasesCreatedCmResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
    <result property="clientName" column="CLIENT_NAME"/>
   <result property="weekDayFirst" column="FIRSTDAY"/>
   <result property="weekDaySecond" column="SECONDDAY"/>
   <result property="weekDayThird" column="THIRDDAY"/>
   <result property="weekDayFourth" column="FOURTHTDAY"/>
   <result property="weekDayFifth" column="FIFTHDAY"/>

</resultMap>

<select id="getTotalCasesCMReport"  resultMap="TotalCasesCreatedCmResult" parameterClass="java.util.HashMap">
	SELECT ccm.CLIENT_NAME,
	sum(case when (to_date(REQ_RECD_DT, 'DD-MON-YY') = to_date(sysdate, 'DD-MON-YY')) then 1 else 0 end) as FIFTHDAY,
	sum(case when (to_date(REQ_RECD_DT, 'DD-MON-YY') = to_date(sysdate, 'DD-MON-YY')-1) then 1 else 0 end) as FOURTHTDAY,
	sum(case when (to_date(REQ_RECD_DT, 'DD-MON-YY') = to_date(sysdate, 'DD-MON-YY')-2) then 1 else 0 end) as THIRDDAY,
	sum(case when (to_date(REQ_RECD_DT, 'DD-MON-YY') = to_date(sysdate, 'DD-MON-YY')-3) then 1 else 0 end) as SECONDDAY,
	sum(case when (to_date(REQ_RECD_DT, 'DD-MON-YY') = to_date(sysdate, 'DD-MON-YY')-4) then 1 else 0 end) as FIRSTDAY

	FROM CMS_CLIENTCASE cc,
	CMS_CLIENT_MASTER ccm 
	where CASE_MGR_ID =#userId# and cc.is_isis=#fromISIS# and  ccm.CLIENT_CODE =cc.CLIENT_CODE
        and trunc(REQ_RECD_DT) <![CDATA[ <= ]]>trunc(sysdate) and trunc(REQ_RECD_DT) <![CDATA[ >= ]]>trunc(sysdate)-4
	group by ccm.CLIENT_NAME  
	order by ccm.CLIENT_NAME  

</select>

<resultMap id="TCasesCountResult" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO" >
    <result property="reportCrnInitial" column="REPORT_CRN_INITIAL"/>
    <result property="numberOfCases" column="casecount"/>
  </resultMap>

<select id="getTotalCasesCountCM"  resultMap="TCasesCountResult" parameterClass="java.util.HashMap">
	           select crtm.REPORT_CRN_INITIAL, NVL(casecount ,0) as casecount
                from CMS_REPORT_TYPE_MASTER crtm,
                (
                    SELECT REPORT_TYPE_ID,COUNT(*) as casecount 
		FROM CMS_CLIENTCASE cc
		LEFT JOIN  CMS_CLIENT_MASTER ccm ON ccm.CLIENT_CODE =cc.CLIENT_CODE
                  
		WHERE ccm.CLIENT_NAME=#clientName#
		and CASE_MGR_ID=#caseMgrId#
		and to_date(REQ_RECD_DT, 'DD-MON-YY') =to_date(#requestRecvdDate#, 'DD-MON-YY')
		and IS_ISIS=#fromISIS#
                  GROUP BY cc.CLIENT_CODE,REPORT_TYPE_ID                          
                ) queryResult 
                where queryResult.REPORT_TYPE_ID (+)= crtm.REPORT_TYPE_MASTER_ID
              order by crtm.REPORT_TYPE_MASTER_ID

</select>
<resultMap id="reportTypeMap" class="com.worldcheck.atlas.vo.masters.ReportTypeMasterVO">
		<result property="initialsUseCRN" column="REPORT_CRN_INITIAL"/>
		<result property="reportType" column="REPORT_CRN_INITIAL2"/>	
</resultMap>

<select id="getAllReportTypes"  resultMap="reportTypeMap">
	select  'SAMPLE' ||REPORT_CRN_INITIAL as REPORT_CRN_INITIAL ,REPORT_CRN_INITIAL as REPORT_CRN_INITIAL2
    from CMS_REPORT_TYPE_MASTER WHERE STATUS=1
    order by REPORT_TYPE_MASTER_ID
</select>

<resultMap id="casesDueCountMap" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO">
		<result property="casesDueTodayCount" column="DUETODAY"/>
		<result property="casesDueTmrwCount" column="DUETMRW"/>	
</resultMap>

<select id="getCasesDueForR2R9"  resultMap="casesDueCountMap">	 	 
 SELECT 
  nvl(sum(case when trunc(DUE_DATE) = trunc(sysdate) then 1 else 0 end),0)as DUETODAY,
 nvl( sum(case when trunc(DUE_DATE) != trunc(sysdate) then 1 else 0 end),0 )as DUETMRW
  from (
 SELECT 
CAST (CC.CRN  AS VARCHAR2(128 CHAR)) AS CRN,    
cast(CASE WHEN CLIENT_INT_SENTDATE1 IS NULL AND( TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1))) AND UPPER(PROCESSCYCLE)=UPPER('Interim1') then 1 
 WHEN CLIENT_INT_SENTDATE2 IS NULL AND (TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1)))AND UPPER(PROCESSCYCLE)=UPPER('Interim2')  then 2
 WHEN CLIENT_FINAL_SENTDATE IS NULL AND (TRUNC(FINAL_DUE_DATE)<![CDATA[ <= ]]> TRUNC(next_weekday) AND  TRUNC(FINAL_DUE_DATE)<![CDATA[ > ]]>TRUNC((sysdate-1))) AND UPPER(PROCESSCYCLE)=UPPER('Final')then 3 
 else 0
 end as NUMBER(2) ) AS OVERDUE_STAGE, 
 CASE WHEN CLIENT_INT_SENTDATE1 IS NULL AND( TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then TRUNC(CLIENT_INT_DUEDATE1) 
 WHEN CLIENT_INT_SENTDATE2 IS NULL AND (TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1)))  then  TRUNC(CLIENT_INT_DUEDATE2)
 WHEN CLIENT_FINAL_SENTDATE IS NULL AND (TRUNC(FINAL_DUE_DATE)<![CDATA[ <= ]]> TRUNC(next_weekday)AND  TRUNC(FINAL_DUE_DATE)<![CDATA[ > ]]>TRUNC((sysdate-1))) then TRUNC(FINAL_DUE_DATE) end AS DUE_DATE,
 CAST(PROCESSCYCLE AS VARCHAR2(512 CHAR)) CURRENT_PROCESSCYCLE
FROM CMS_CLIENTCASE CC, CASECREATION ,CMS_OFFICE_MASTER COM,CMS_TEAM_DETAILS CTD,CMS_USER_MASTER CUM
,
 (
	SELECT sysdate AS CURRENT_DATE,
    CASE
      WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Sunday','Friday','Saturday')
         THEN next_day(sysdate,'Monday')
      ELSE sysdate+1
    END AS next_weekday,
    
    CASE
      WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Monday','Friday','Saturday')
          THEN next_day(sysdate      -7,'Friday')    
     ELSE sysdate-1
    END AS prev_weekday
    
     FROM dual
 )
	WHERE CC.CRN=CTD.CRN(+)
     and CC.case_status_id in (1,2,3)
    AND CTD.MAIN_ANALYST=CUM.LOGIN_ID(+)
    AND (TEAM_TYPE_ID=1 or TEAM_TYPE_ID is null)
    AND CTD.OFFICE_ID=COM.OFFICE_MASTER_ID(+)
AND CC.CRN=CASECREATION.CRN
AND(CASE WHEN CLIENT_INT_SENTDATE1 IS NULL AND( TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ > ]]>TRUNC((sysdate-1)))then 1 
 WHEN CLIENT_INT_SENTDATE2 IS NULL AND (TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1)))  then 1
 WHEN CLIENT_FINAL_SENTDATE IS NULL AND (TRUNC(FINAL_DUE_DATE)<![CDATA[ <= ]]> TRUNC(next_weekday) AND  TRUNC(FINAL_DUE_DATE)<![CDATA[ > ]]>TRUNC((sysdate-1))) then 1 end)=1 
 )
</select>

<select id="getCasesDueForOthers"  resultMap="casesDueCountMap">	 
	  SELECT 
		 nvl(sum(case when trunc(DUE_DATE) = trunc(sysdate) then 1 else 0 end),0 ) as DUETODAY,
		 nvl(sum(case when trunc(DUE_DATE) != trunc(sysdate) then 1 else 0 end),0 ) as DUETMRW
		from (
		  select distinct CC.CRN AS CRN,
		 CASE WHEN INT1RESEARCHCOMPDT IS NULL AND( TRUNC(REV_INTDUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then TRUNC(REV_INTDUEDATE1) 
		 WHEN INT2RESEARCHCOMPDT IS NULL AND (TRUNC(REV_INTDUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1))) then  TRUNC(REV_INTDUEDATE2)
		 WHEN FINALRESEARCHCOMPDT IS NULL AND (TRUNC(REV_FINDUEDATE)<![CDATA[ <= ]]> TRUNC(next_weekday)AND
		 TRUNC(REV_FINDUEDATE)<![CDATA[ > ]]>TRUNC((sysdate-1)))then TRUNC(REV_FINDUEDATE) end AS DUE_DATE

		FROM CMS_CLIENTCASE CC,CMS_OFFICE_MASTER COM,CMS_TEAM_DETAILS CTD,cms_team_type cttm,
		 (
		 SELECT sysdate AS CURRENT_DATE,
		CASE
		  WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Sunday','Friday','Saturday')
			 THEN next_day(sysdate,'Monday')
		  ELSE sysdate+1
		END AS next_weekday,
		
		CASE
		  WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Monday','Friday','Saturday')
			  THEN next_day(sysdate      -7,'Friday')    
		 ELSE sysdate-1
		END AS prev_weekday
		
		 FROM dual
	 )
		WHERE CC.CRN=CTD.CRN
		 and CC.case_status_id in (2,3,1)
		AND CTD.OFFICE_ID=COM.OFFICE_MASTER_ID(+)
		And cttm.TEAM_TYPE_ID = CTD.TEAM_TYPE_ID
		AND(CASE WHEN INT1RESEARCHCOMPDT IS NULL AND( TRUNC(REV_INTDUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then 1 
		 WHEN INT2RESEARCHCOMPDT IS NULL AND (TRUNC(REV_INTDUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1)))then 1
		 WHEN FINALRESEARCHCOMPDT IS NULL AND (TRUNC(REV_FINDUEDATE)<![CDATA[ <= ]]> TRUNC(next_weekday) AND  TRUNC(REV_FINDUEDATE)<![CDATA[ > ]]>TRUNC((sysdate-1)))then 1 end)=1
		 )
</select>



<resultMap id="casesDueDetailsMap" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO">
		<result property="crn" column="crn"/>
		<result property="office" column="office"/>	
		<result property="teamID" column="TEAMID"/>	
		<result property="teamType" column="TeamType"/>	
		<result property="pid" column="PARENT_PID"/>	
		<result property="overdueStage" column="OVERDUE_STAGE"/>	


</resultMap>

<select id="getCasesDueTodayTmrwDetailsForR2R9"  resultMap="casesDueDetailsMap" parameterClass="java.util.HashMap" >	 
select OFFICE,CRN,TeamType,TEAMID,PARENT_PID,OVERDUE_STAGE from (	
 SELECT 
  CAST(COM.OFFICE AS VARCHAR2(4000 CHAR)) AS OFFICE,   
    CAST (CC.CRN  AS VARCHAR2(128 CHAR)) AS CRN,
     ctd.TEAM_ID as TEAMID,
	 'Primary' as TeamType,
    cc.pid as PARENT_PID,
    CASE WHEN CLIENT_INT_SENTDATE1 IS NULL AND( TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1))) AND UPPER(PROCESSCYCLE)=UPPER('Interim1') then 'Interim1' 
     WHEN CLIENT_INT_SENTDATE2 IS NULL AND (TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1)))AND UPPER(PROCESSCYCLE)=UPPER('Interim2')  then 'Interim2'
     WHEN CLIENT_FINAL_SENTDATE IS NULL AND (TRUNC(FINAL_DUE_DATE)<![CDATA[ <= ]]> TRUNC(next_weekday) AND  TRUNC(FINAL_DUE_DATE)<![CDATA[ > ]]>TRUNC((sysdate-1))) AND UPPER(PROCESSCYCLE)=UPPER('Final')then 'Final' else 'No cycle' end  AS OVERDUE_STAGE,

     CASE WHEN CLIENT_INT_SENTDATE1 IS NULL AND( TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then TRUNC(CLIENT_INT_DUEDATE1) 
     WHEN CLIENT_INT_SENTDATE2 IS NULL AND (TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1))) then  TRUNC(CLIENT_INT_DUEDATE2)
     WHEN CLIENT_FINAL_SENTDATE IS NULL AND (TRUNC(FINAL_DUE_DATE)<![CDATA[ <= ]]> TRUNC(next_weekday)AND  TRUNC(FINAL_DUE_DATE)<![CDATA[ > ]]>TRUNC((sysdate-1)))then TRUNC(FINAL_DUE_DATE) end AS DUE_DATE

    FROM CMS_CLIENTCASE CC, CASECREATION,CMS_OFFICE_MASTER COM,CMS_TEAM_DETAILS CTD,CMS_USER_MASTER CUM,
 (
	SELECT sysdate AS CURRENT_DATE,
    CASE
      WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Sunday','Friday','Saturday')
         THEN next_day(sysdate,'Monday')
      ELSE sysdate+1
    END AS next_weekday,
    
    CASE
      WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Monday','Friday','Saturday')
          THEN next_day(sysdate      -7,'Friday')    
     ELSE sysdate-1
    END AS prev_weekday
    
     FROM dual 
 
 )
    WHERE CC.CRN=CTD.CRN(+)
     and CC.case_status_id in (1,2,3)
    AND CTD.MAIN_ANALYST=CUM.LOGIN_ID(+)
    AND (TEAM_TYPE_ID=1 or TEAM_TYPE_ID is null)
    AND CTD.OFFICE_ID=COM.OFFICE_MASTER_ID(+)
AND CC.CRN=CASECREATION.CRN
    AND(CASE WHEN CLIENT_INT_SENTDATE1 IS NULL AND( TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ <= ]]>  TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then 1 
     WHEN CLIENT_INT_SENTDATE2 IS NULL AND (TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ <= ]]>  TRUNC(next_weekday) AND TRUNC(CLIENT_INT_DUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1))) then 1
     WHEN CLIENT_FINAL_SENTDATE IS NULL AND (TRUNC(FINAL_DUE_DATE)<![CDATA[ <= ]]> TRUNC(next_weekday) AND  TRUNC(FINAL_DUE_DATE)<![CDATA[ > ]]>TRUNC((sysdate-1))) then 1 end)=1
	)
	<isEqual   property="dateParam" compareValue="today">
		where trunc(DUE_DATE) = trunc(sysdate)
	</isEqual> 
	<isNotEqual property="dateParam" compareValue="today">
		where trunc(DUE_DATE) <![CDATA[ != ]]> trunc(sysdate)
	</isNotEqual> 
	
</select>

<resultMap id="casesDueDetailsMapOther" class="com.worldcheck.atlas.vo.dashboard.DashBoardReportVO">
		<result property="crn" column="crn"/>
		<result property="office" column="Analyst"/>	
		<result property="teamType" column="TEAM_TYPE"/>	
		<result property="teamID" column="TEAM_ID"/>	
		<result property="pid" column="pid"/>	
		<result property="overdueStage" column="OVERDUE_STAGE"/>	


</resultMap>

<select id="getCasesDueTodayTmrwDetailsForOthers"  resultMap="casesDueDetailsMapOther" parameterClass="java.util.HashMap" >	 
select crn, Analyst,TEAM_TYPE,TEAM_ID,pid,OVERDUE_STAGE
from (
  SELECT 
  CAST(COM.OFFICE AS VARCHAR2(4000 CHAR)) AS OFFICE,
    CAST (CC.CRN  AS VARCHAR2(128 CHAR)) AS CRN,
CAST(REV_INTDUEDATE1 AS DATE) AS RESEARCH_INT_DUE_DATE1,
CAST(REV_INTDUEDATE2 AS DATE) AS RESEARCH_INT_DUE_DATE2,
CAST(REV_FINDUEDATE AS DATE) AS RESEARCH_FINAL_DUE_DATE,


cttm.TEAM_TYPE,  CTD.TEAM_ID,
cc.pid,
CASE WHEN INT1RESEARCHCOMPDT IS NULL AND( TRUNC(REV_INTDUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then 'Interim1' 
 WHEN INT2RESEARCHCOMPDT IS NULL AND (TRUNC(REV_INTDUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1)))  then 'Interim2' 
 WHEN FINALRESEARCHCOMPDT IS NULL AND (TRUNC(REV_FINDUEDATE)<![CDATA[ <= ]]> TRUNC(next_weekday) AND  TRUNC(REV_FINDUEDATE)<![CDATA[ > ]]>TRUNC((sysdate-1)))then 'Final'  end  AS OVERDUE_STAGE,
 
 CASE WHEN INT1RESEARCHCOMPDT IS NULL AND( TRUNC(REV_INTDUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then TRUNC(REV_INTDUEDATE1) 
 WHEN INT2RESEARCHCOMPDT IS NULL AND (TRUNC(REV_INTDUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1))) then  TRUNC(REV_INTDUEDATE2)
 WHEN FINALRESEARCHCOMPDT IS NULL AND (TRUNC(REV_FINDUEDATE)<![CDATA[ <= ]]> TRUNC(next_weekday)AND  TRUNC(REV_FINDUEDATE)<![CDATA[ > ]]>TRUNC((sysdate-1)))then TRUNC(REV_FINDUEDATE) end AS DUE_DATE,
CASE WHEN CTD.TEAM_TYPE_ID IN (1,2) THEN MAIN_ANALYST
WHEN CTD.TEAM_TYPE_ID IN (3,4) THEN MANAGER_ID END AS ANALYST

FROM CMS_CLIENTCASE CC,CMS_OFFICE_MASTER COM,CMS_TEAM_DETAILS CTD,cms_team_type cttm,
 (
	SELECT sysdate AS CURRENT_DATE,
    CASE
      WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Sunday','Friday','Saturday')
         THEN next_day(sysdate,'Monday')
      ELSE sysdate+1
    END AS next_weekday,
    
    CASE
      WHEN trim(TO_CHAR(sysdate,'Day')) IN ('Monday','Friday','Saturday')
          THEN next_day(sysdate      -7,'Friday')    
     ELSE sysdate-1
    END AS prev_weekday
    
     FROM dual
 )
WHERE CC.CRN=CTD.CRN
 and CC.case_status_id in (2,3,1)
AND CTD.OFFICE_ID=COM.OFFICE_MASTER_ID(+)
And cttm.TEAM_TYPE_ID = CTD.TEAM_TYPE_ID
AND(CASE WHEN INT1RESEARCHCOMPDT IS NULL AND( TRUNC(REV_INTDUEDATE1)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE1)<![CDATA[ > ]]> TRUNC((sysdate-1)))  then 1 
 WHEN INT2RESEARCHCOMPDT IS NULL AND (TRUNC(REV_INTDUEDATE2)<![CDATA[ <= ]]> TRUNC(next_weekday) AND TRUNC(REV_INTDUEDATE2)<![CDATA[ > ]]>TRUNC((sysdate-1)))then 1
 WHEN FINALRESEARCHCOMPDT IS NULL AND (TRUNC(REV_FINDUEDATE)<![CDATA[ <= ]]> TRUNC(next_weekday) AND  TRUNC(REV_FINDUEDATE)<![CDATA[ > ]]>TRUNC((sysdate-1)))then 1 end)=1
 
 )
 
	 <isEqual   property="dateParam" compareValue="today">
		where trunc(DUE_DATE) = trunc(sysdate)
	</isEqual> 
	<isNotEqual property="dateParam" compareValue="today">
		where trunc(DUE_DATE) <![CDATA[ != ]]> trunc(sysdate)
	</isNotEqual> 
 
 
</select>
</sqlMap>