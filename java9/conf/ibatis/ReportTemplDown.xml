<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">
  
<sqlMap namespace="ReportTemplDown">

<resultMap id="resultClientMasterVO" class="com.worldcheck.atlas.vo.masters.ClientMasterVO">
    <result property="clientCode" column="CLIENT_CODE"/>
    <result property="clientName" column="CLIENT_NAME"/>
    <result property="codeName" column="codeName"/>
</resultMap>

<select id = "searchReportTemplDown"  
	parameterClass="com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO" 
	resultClass="com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO">
		SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (SELECT  CRDM.REPORT_DOWNLOAD_ID rptDownId,
				DECODE(IS_GENERAL, '1','GENERAL',CRDM.CLIENT_CODE) clientCode,
		        DECODE(IS_GENERAL, '1','',CRDM.CLIENT_NAME) clientName,
		        CRDM.COMMENTS "comment",
		         CRDM.COMMENTS rptComment,
		        CRDM.FILE_NAME fileName,
		        TO_CHAR(CRDM.UPLOAD_TIME,'DD-Mon-YYYY HH24:MI:SS') uploadDateAndTime,
		        CRDM.IS_GENERAL isGeneral,
		        CRDM.UPLOADED_BY uploladedBy,
		        CRTM.REPORT_TYPE reportType		        
		FROM CMS_REPORT_DOWNLOAD_MASTER CRDM,
		    CMS_CLIENT_MASTER CCM, 
		    CMS_REPORT_TYPE_MASTER CRTM		    
		WHERE CRDM.CLIENT_CODE = CCM.CLIENT_CODE
		AND   CRDM.REPORT_ID = CRTM.REPORT_TYPE_MASTER_ID
		AND CRDM.HISTORY_STATUS = 0
		AND CRTM.STATUS = 1 
		AND CCM.STATUS = 1 
		<isNotNull prepend="AND" property="clientCode">
	 			<isNotEmpty property="clientCode">
		   CRDM.CLIENT_CODE = #clientCode#
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="clientName">
	 			<isNotEmpty property="clientName">
		   UPPER(CRDM.CLIENT_NAME) LIKE '%'||UPPER(#clientName#)||'%'
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="reportType">
	 			<isNotEmpty property="reportType">
		   CRTM.REPORT_CODE = #reportType#
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="comment">
	 			<isNotEmpty property="comment">
		   UPPER(CRDM.COMMENTS)  LIKE  '%'||UPPER(#comment#)||'%'
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="updateStartDate">
	 			<isNotEmpty property="updateStartDate">
		   TO_DATE(TO_CHAR(CRDM.UPLOAD_TIME,'DD-Mon-YYYY')) >= TO_DATE(#updateStartDate#,'DD-Mon-YYYY' )
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="updateEndDate">
	 			<isNotEmpty property="updateEndDate">
		    TO_DATE(TO_CHAR(CRDM.UPLOAD_TIME,'DD-Mon-YYYY')) <![CDATA[ <= ]]> TO_DATE(#updateEndDate#,'DD-Mon-YYYY')
		</isNotEmpty>
      		</isNotNull>
		 ORDER BY UPPER($sortColumnName$) $sortType$) a WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>



<select id = "searchReportTemplDownCount"  
	parameterClass="com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO" 
	resultClass="java.lang.Integer">
		SELECT  COUNT(CRDM.REPORT_DOWNLOAD_ID) 		        
		FROM CMS_REPORT_DOWNLOAD_MASTER CRDM,
		    CMS_CLIENT_MASTER CCM, 
		    CMS_REPORT_TYPE_MASTER CRTM		    
		WHERE CRDM.CLIENT_CODE = CCM.CLIENT_CODE
		AND   CRDM.REPORT_ID = CRTM.REPORT_TYPE_MASTER_ID
		AND CRDM.HISTORY_STATUS = 0
		AND CRTM.STATUS = 1 
		AND CCM.STATUS = 1 
		<isNotNull prepend="AND" property="clientCode">
	 			<isNotEmpty property="clientCode">
		   CRDM.CLIENT_CODE = #clientCode#
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="clientName">
	 			<isNotEmpty property="clientName">
		   UPPER(CRDM.CLIENT_NAME) LIKE '%'||UPPER(#clientName#)||'%'
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="reportType">
	 			<isNotEmpty property="reportType">
		   CRTM.REPORT_CODE = #reportType#
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="comment">
	 			<isNotEmpty property="comment">
		   UPPER(CRDM.COMMENTS)  LIKE  '%'||UPPER(#comment#)||'%'
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="updateStartDate">
	 			<isNotEmpty property="updateStartDate">
		   TO_DATE(TO_CHAR(CRDM.UPLOAD_TIME,'DD-Mon-YYYY')) >= TO_DATE(#updateStartDate#,'DD-Mon-YYYY' )
		</isNotEmpty>
      		</isNotNull>
		<isNotNull prepend="AND" property="updateEndDate">
	 			<isNotEmpty property="updateEndDate">
		    TO_DATE(TO_CHAR(CRDM.UPLOAD_TIME,'DD-Mon-YYYY'))<![CDATA[ <= ]]> TO_DATE(#updateEndDate#,'DD-Mon-YYYY')
		</isNotEmpty>
      		</isNotNull>
		ORDER BY CRDM.UPLOAD_TIME DESC
</select>

<insert id="insertReportTempDown" parameterClass="com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO" >
	<selectKey resultClass="int" type="pre" keyProperty="rptDownId"  > 
     	SELECT CMS_REPORTDOWNLOADMASTER_SEQ.NEXTVAL AS VALUE FROM DUAL
  	</selectKey>
	INSERT INTO CMS_REPORT_DOWNLOAD_MASTER(REPORT_DOWNLOAD_ID,
		CLIENT_NAME,
		CLIENT_CODE,
		REPORT_ID,
		UPLOADED_BY,
		COMMENTS,
		FILE_NAME,
		UPLOAD_TIME,IS_GENERAL) VALUES(
		#rptDownId#,
		(SELECT CLIENT_NAME FROM CMS_CLIENT_MASTER WHERE CLIENT_CODE = #clientCode#),
		#clientCode#,
		(SELECT CRTM.REPORT_TYPE_MASTER_ID FROM CMS_REPORT_TYPE_MASTER CRTM WHERE CRTM.REPORT_TYPE = #reportType# ), 
		#uploladedBy#,
		#comment#,
		#fileName#,
		SYSDATE,
		#isGeneral#	
	)
</insert>

<select id="getInsertedData" parameterClass="int" resultClass="com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO">
 		SELECT CRDM.REPORT_DOWNLOAD_ID "rptDownId",
 				CRDM.CLIENT_CODE "clientCode",
		        CRDM.CLIENT_NAME "clientName",
		        CRDM.COMMENTS "comment",
		        CRDM.FILE_NAME "fileName",
		  		 TO_CHAR(CRDM.UPLOAD_TIME,'DD-Mon-YYYY HH24:MI:SS') "uploadDateAndTime",
		  		 CRDM.IS_GENERAL "isGeneral",
		        CRDM.UPLOADED_BY "uploladedBy",
		        CRTM.REPORT_TYPE "reportType"		        
		FROM CMS_REPORT_DOWNLOAD_MASTER CRDM,		    
		    CMS_REPORT_TYPE_MASTER CRTM		    
		WHERE    CRDM.REPORT_ID = CRTM.REPORT_TYPE_MASTER_ID 
		AND CRDM.REPORT_DOWNLOAD_ID = #id#
</select>

<select id="getHistoryDataOfClient" parameterClass="string" resultClass="com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO">
 		SELECT CRDM.REPORT_DOWNLOAD_ID "rptDownId",
 				CRDM.CLIENT_CODE "clientCode",
		        CRDM.CLIENT_NAME "clientName",
		        CRDM.COMMENTS "comment",
		        CRDM.FILE_NAME "fileName",
		  		 TO_CHAR(CRDM.UPLOAD_TIME,'DD-Mon-YYYY HH24:MI:SS') "uploadDateAndTime",
		  		 CRDM.IS_GENERAL "isGeneral",
		        CRDM.UPLOADED_BY "uploladedBy",
		        CRTM.REPORT_TYPE "reportType"		        
		FROM CMS_REPORT_DOWNLOAD_MASTER CRDM,		    
		    CMS_REPORT_TYPE_MASTER CRTM		    
		WHERE    CRDM.REPORT_ID = CRTM.REPORT_TYPE_MASTER_ID 
		AND CRDM.CLIENT_CODE = #clientCode#
		AND CRDM.HISTORY_STATUS = 1
</select>


<update id = "updateHistoryStatus" parameterClass="java.util.HashMap"   >
		UPDATE CMS_REPORT_DOWNLOAD_MASTER 
		SET HISTORY_STATUS = 1,
		UPLOADED_BY = #uploladedBy#,
		UPLOAD_TIME = SYSDATE
		WHERE REPORT_DOWNLOAD_ID = #id#

</update>

<update id = "updateRecord" parameterClass="com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO">
		UPDATE CMS_REPORT_DOWNLOAD_MASTER 
		SET UPLOADED_BY = #uploladedBy#,
			COMMENTS = #comment#,
			HISTORY_STATUS = 0,
			UPLOAD_TIME = SYSDATE,
			IS_GENERAL = #isGeneral#			
		WHERE REPORT_DOWNLOAD_ID = #rptDownId#

</update>

<select id ="getGeneralClients" resultMap="resultClientMasterVO">
		SELECT CCM.CLIENT_CODE,CCM.CLIENT_NAME,CCM.CLIENT_CODE||'-'||CCM.CLIENT_NAME codeName
		FROM CMS_CLIENT_MASTER CCM 
		WHERE STATUS = 1 
		AND CCM.CLIENT_CODE NOT IN(SELECT DISTINCT(CRDM.CLIENT_CODE)  FROM CMS_REPORT_DOWNLOAD_MASTER CRDM
		WHERE IS_GENERAL = 0)
		ORDER BY CLIENT_CODE
</select>


<select id="getFilesForCaseDetail" resultClass = "com.worldcheck.atlas.vo.masters.ReportTemplateMasterVO" 
	parameterClass = "java.util.HashMap">
	SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (
	SELECT CLIENT_CODE clientCode,
	(SELECT REPORT_TYPE FROM cms_report_type_master WHERE REPORT_TYPE_MASTER_ID = REPORT_ID) reportType,
	FILE_NAME fileName,
	UPLOADED_BY uploladedBy ,
	COMMENTS "comment"	
	FROM
	CMS_REPORT_DOWNLOAD_MASTER
	WHERE HISTORY_STATUS = 0
	<isNotNull prepend="AND" property="clientCode">
		<isNotEmpty property="clientCode">
			CLIENT_CODE = #clientCode#
	 	 </isNotEmpty>
	</isNotNull>
	<isNotNull prepend="AND" property="reportType">
		<isNotEmpty property="reportType">

			REPORT_ID = (SELECT REPORT_TYPE_MASTER_ID FROM cms_report_type_master WHERE
			REPORT_TYPE = #reportType#)
		</isNotEmpty>
	</isNotNull>
	
	) a WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>



<select id="getFilesForCaseDetailCount" resultClass = "java.lang.Integer" 
	parameterClass = "java.util.HashMap">
	
	SELECT count(CLIENT_CODE) 
	FROM
	CMS_REPORT_DOWNLOAD_MASTER
	WHERE HISTORY_STATUS = 0
	<isNotNull prepend="AND" property="clientCode">
		<isNotEmpty property="clientCode">
			CLIENT_CODE = #clientCode#
	 	 </isNotEmpty>
	</isNotNull>
	<isNotNull prepend="AND" property="reportType">
		<isNotEmpty property="reportType">

			REPORT_ID = (SELECT REPORT_TYPE_MASTER_ID FROM cms_report_type_master WHERE
			REPORT_TYPE = #reportType#)
		</isNotEmpty>
	</isNotNull>
	
	
</select>


</sqlMap>
