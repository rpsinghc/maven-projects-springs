<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="SupportApp">
	
	<select id="getCRNInfo" resultClass="com.worldcheck.atlas.vo.masters.SupportAppVO">

		select cc.crn crn, cc.final_due_date clientDueDate, cc.client_final_sentdate clientSentDate, csm.DESCRIPTION case_status  
		from cms_clientcase cc left join CMS_CASE_STATUS_MASTER csm 
		on cc.CASE_STATUS_ID = csm.CASE_STATUS_ID
		where cc.crn = #crn#

	    </select>

	   

		<update id="updateDatesWC" parameterClass="com.worldcheck.atlas.vo.masters.SupportAppVO">
		UPDATE
		cms_clientcase SET
		CLIENT_FINAL_SENTDATE = TO_CHAR(TO_DATE(#clientSentDate#,'DD-Mon-YYYY'), 'DD-MON-YY'),
		FINAL_DUE_DATE = TO_CHAR(TO_DATE(#clientDueDate#,'DD-Mon-YYYY'), 'DD-MON-YY')
		WHERE
		CRN = #crn#
		
	</update>



	<update id="updateDatesSAV" parameterClass="com.worldcheck.atlas.vo.masters.SupportAppVO">
		UPDATE
		savviondb.CASECREATION SET
		CLIENTSENTDATE = TO_CHAR(TO_DATE(#clientSentDate#,'DD-Mon-YYYY'), 'DD-Mon-YYYY'),
		CFINAL = TO_CHAR(TO_DATE(#clientDueDate#,'DD-Mon-YYYY'), 'DD-Mon-YYYY')
		WHERE
		CRN = #crn#
		
	</update>
	
	<select id="fetchUserPWD" parameterClass="java.lang.String" resultClass="java.lang.String">

		select attr_value from savviondb.userattr uat
		where uat.user_id = (select user_id from SAVVIONDB.umuser where user_name = #userId#)
		and attr_name = 'password'

	    </select>

	    <select id="getMonthlyREDataExport" parameterClass="com.worldcheck.atlas.vo.masters.SupportAppVO" resultClass="com.worldcheck.atlas.vo.masters.SupportAppVO">


		select CC.crn case_reference_no , 
		cc.client_code client_code, 
		ccm.client_name client_name, 
		CC.client_final_sentdate client_final_sent_date, 
		SUB.SUBJECT_NAME subject_name,  
		CEM.ENTITY_NAME subject_type,  
		CM.COUNTRY subject_country, 
		crm.name research_element, 
		CSM.description case_status, 
		cstrm.performer analyst, 
		ctt.team_type team_type, 
		com.office office, 
		cstrm.jlpoints jlppoints 
		from CMS_CLIENTCASE CC,CMS_SUBJECT SUB,cms_case_status_master CSM,CMS_ENTITYTYPE_MASTER CEM,cms_country_master CM  
		,cms_sub_team_re_map cstrm, cms_re_master crm,CMS_TEAM_TYPE ctt,CMS_TEAM_DETAILS ctd, cms_office_master com,cms_user_master cum, 
		cms_client_master ccm 
		WHERE cc.crn= sub.crn 
		and cc.client_code = ccm.client_code 
		and cc.crn=cstrm.crn   
		and cstrm.team_id= ctd.team_id   
		and CC.case_status_id=CSM.case_status_id  
		AND  CEM.ENTITY_TYPE_ID=SUB.ENTITY_TYPE_ID  
		AND SUB.country_id=CM.COUNTRY_MASTER_ID   
		and cstrm.re_id= crm.re_master_id  
		and ctd.team_type_id =ctt.team_type_id  
		and cum.login_id=cstrm.performer  
		and cc.crn=ctd.crn    
		and cum.office_id=com.office_master_id  
		and sub.subject_id=cstrm.subject_id  
		and ctd.team_id=cstrm.team_id  
		and to_date(CC.client_final_sentdate,'DD-MON-YY') between TO_DATE(#startSentDate#,'DD-MON-YY') and TO_DATE(#endSentDate#,'DD-MON-YY') 
		order by cc.crn,SUB.SUBJECT_NAME

	    </select>
	
		 <select id="getMonthlyCaseHistoryDataExport" parameterClass="com.worldcheck.atlas.vo.masters.SupportAppVO" resultClass="com.worldcheck.atlas.vo.masters.SupportAppVO">
		 
			select cc.CRN case_reference_no, cc.REQ_RECD_DT caseReceivedDate, cc.client_final_sentdate client_final_sent_date,
			csm.DESCRIPTION CASE_STATUS, cch.TASKNAME taskName, chd.FIELDNAME action, 
			chd.OLDINFO oldInfo, chd.NEWINFO newInfo,
			case when cch.PERFORMER IN ('FinanceQueue','OCRSUser')
			then cch.PERFORMER
			else
			cum.USER_FULL_NAME
			END AS performer
			, chd.MODTIME serverTime
			from cms_clientcase cc
			left join CMS_CASE_STATUS_MASTER csm on cc.case_status_id = csm.case_status_id 
			left join CMS_CASE_HISTORY cch on cc.crn = cch.crn
			left join CMS_CASE_HISTORY_DETAILS chd on cch.CASE_HISTORY_ID = chd.CASE_HISTORY_ID
			left join CMS_USER_MASTER cum on cch.PERFORMER = cum.LOGIN_ID
			where to_date(cc.REQ_RECD_DT,'DD-MON-YY') between TO_DATE(#startCaseReceivedDate#,'DD-MON-YY') and TO_DATE(#endCaseReceivedDate#,'DD-MON-YY')
			<isNotEqual prepend="AND" property="client_code" compareValue="All">
			  cc.CLIENT_CODE = #client_code#
			 </isNotEqual>
			order by cc.CRN
			
		 </select>
	
	 
	
</sqlMap>


