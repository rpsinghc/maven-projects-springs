<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="AdminConsole">

	<resultMap id="leave" class="com.worldcheck.atlas.vo.leave.LeaveVO">
		<result property="userLeaveId" column="USER_LEAVE_ID" />
		<result property="userName" column="USER_ID" />
		<result property="backup2" column="backup2" />
		<result property="backup1" column="backup1" />
		<result property="leaveType" column="leaveType" />
		<result property="fromDate" column="fromDate" />
		<result property="toDate" column="toDate" />
		<result property="userFullName" column="userFullName" />
	</resultMap>
	
	<resultMap id="resultVendorMasterVO" class="com.worldcheck.atlas.vo.masters.VendorMasterVO">
     <result property="vendorName" column="VENDOR_NAME"/>
	</resultMap>


	<!--- Showing data by ID -->
	
	
	<select id="getUserOnLeave" resultClass="java.lang.String" parameterClass="java.util.HashMap">
		SELECT distinct(cum.user_full_name)
		FROM CMS_USER_LEAVE cul,cms_user_master cum
		WHERE FROM_DATE <![CDATA[ <= ]]> TO_CHAR(SYSDATE,'dd-Mon-YYYY')
		AND TO_DATE <![CDATA[ >= ]]> TO_CHAR(SYSDATE,'dd-Mon-YYYY')
		and cum.login_id = cul.user_id
		AND user_id in <iterate property="userName" open="(" close=")" conjunction=",">
      #userName[]#
     </iterate>
	</select>

	<select id="getLeaves" resultMap="leave" parameterClass="java.util.HashMap">
		SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (select cul.USER_LEAVE_ID,to_char(cul.FROM_DATE,'dd-mm-yyyy') fromDate ,
		to_char(cul.TO_DATE,'dd-mm-yyyy') toDate,cul.USER_ID ,cum.USER_FULL_NAME userFullName,
		decode(cltm.DESCRIPTION,'Half Day Leave - Afternoon Session','Afternoon','Half Day Leave - Morning Session','Morning',
		'Full Day Leave','Full Day','Busy') 
		leaveType,cum1.USER_FULL_NAME backup1,cum2.USER_FULL_NAME backup2
		from CMS_USER_LEAVE cul,CMS_USER_MASTER cum,CMS_LEAVE_TYPE_MASTER cltm,cms_user_master cum1,cms_user_master cum2
		where cul.USER_ID = cum.LOGIN_ID
		and cul.LEAVE_TYPE = cltm.LEAVE_TYPE_MASTER_ID
		and cum1.login_id(+)=cul.BACKUP1
		and cum2.login_id(+)=cul.BACKUP2
		 and cum.status = 1
		<isNotNull prepend="AND" property="userId">
				<isNotEmpty property="userId">
					CUL.USER_ID = (#userId#)
				</isNotEmpty>
			</isNotNull>
			<isNotNull prepend="AND" property="startDate">
				<isNotEmpty property="startDate">
				(	   cul.from_date between to_date(#startDate#,    'dd-mm-yyyy') and to_date(#endDate#,    'dd-mm-yyyy')      
       				OR cul.to_date between to_date(#startDate#,    'dd-mm-yyyy') and to_date(#endDate#,    'dd-mm-yyyy')        
      				OR ( cul.from_date <![CDATA[ < ]]> to_date(#startDate#,    'dd-mm-yyyy') 
      				and to_date(#endDate#,    'dd-mm-yyyy') <![CDATA[ < ]]> cul.to_date )
				   )
				</isNotEmpty>
			</isNotNull>
			<isNotNull prepend="AND" property="reportsTo">
				<isNotEmpty property="reportsTo">
					 (CUM.REPORTS_TO = #reportsTo# OR CUL.USER_ID = #reportsTo#)
				</isNotEmpty>
			</isNotNull>
			<isEqual property="sort" compareValue="fromDate">
				  order by cul.FROM_DATE $dir$ 
			</isEqual>  
			<isEqual property="sort" compareValue="toDate">
				  order by cul.TO_DATE $dir$ 
			</isEqual>  
			<isNotEqual property="sort" compareValue="fromDate">
				<isNotEqual property="sort" compareValue="toDate">
				  	ORDER By upper($sort$) $dir$
				  </isNotEqual>
		    </isNotEqual> 
		   ) a WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
	</select>
	
	
	<select id="getLeavesCount" resultClass="java.lang.Integer" parameterClass="java.util.HashMap">
		select count(*)
		from CMS_USER_LEAVE cul,CMS_USER_MASTER cum,CMS_LEAVE_TYPE_MASTER cltm,cms_user_master cum1,cms_user_master cum2
		where cul.USER_ID = cum.LOGIN_ID
		and cul.LEAVE_TYPE = cltm.LEAVE_TYPE_MASTER_ID
		and cum1.login_id(+)=cul.BACKUP1
		and cum2.login_id(+)=cul.BACKUP2
		and cum.status = 1
		<isNotNull prepend="AND" property="userId">
				<isNotEmpty property="userId">
					CUL.USER_ID = (#userId#)
				</isNotEmpty>
			</isNotNull>
			<isNotNull prepend="AND" property="startDate">
				<isNotEmpty property="startDate">
				(	   cul.from_date between to_date(#startDate#,    'dd-mm-yyyy') and to_date(#endDate#,    'dd-mm-yyyy')      
       				OR cul.to_date between to_date(#startDate#,    'dd-mm-yyyy') and to_date(#endDate#,    'dd-mm-yyyy')        
      				OR ( cul.from_date <![CDATA[ < ]]> to_date(#startDate#,    'dd-mm-yyyy') 
      				and to_date(#endDate#,    'dd-mm-yyyy') <![CDATA[ < ]]> cul.to_date )
				   )
				</isNotEmpty>
			</isNotNull>
			<isNotNull prepend="AND" property="reportsTo">
				<isNotEmpty property="reportsTo">
					 (CUM.REPORTS_TO = #reportsTo# OR CUL.USER_ID = #reportsTo#)
				</isNotEmpty>
			</isNotNull>
		order by cul.USER_ID , cul.FROM_DATE,cul.TO_DATE
	</select>

	<delete id="deleteLeave" parameterClass="java.lang.String">

		delete from CMS_USER_LEAVE where USER_LEAVE_ID in ($leaveIds$)

	</delete>

	<insert id="insertLeave" parameterClass="com.worldcheck.atlas.vo.leave.LeaveVO">

		<selectKey resultClass="int" type="pre" keyProperty="userLeaveId">
			SELECT CMS_USERLEAVE_SEQ.NEXTVAL AS VALUE FROM DUAL
  </selectKey>
		insert into CMS_USER_LEAVE (USER_LEAVE_ID,USER_ID,
		FROM_DATE,TO_DATE,LEAVE_TYPE,BACKUP1, BACKUP2, UPDATED_BY,UPDATED_ON)
		values
		(#userLeaveId#,#userName#,to_date(#fromDate#,'dd-mm-yyyy'),to_date(#toDate#,'dd-mm-yyyy'),#leaveType#, #backup1#, #backup2#,#updatedBy#,sysdate)

	</insert>
	
	
	<update id="updateLeave" parameterClass="com.worldcheck.atlas.vo.leave.LeaveVO">     
     update CMS_USER_LEAVE set
       FROM_DATE = to_date(#fromDate#,'dd-mm-yyyy'),
       TO_DATE = to_date(#toDate#,'dd-mm-yyyy'),
       UPDATED_BY = #updatedBy#,
       UPDATED_ON = sysdate,
       LEAVE_TYPE = (select LEAVE_TYPE_MASTER_ID from CMS_LEAVE_TYPE_MASTER WHERE DESCRIPTION = DECODE(#leaveType#,'Morning','Half Day Leave - Morning Session',
       'Afternoon','Half Day Leave - Afternoon Session','Full Day','Full Day Leave',#leaveType#))
     where
      USER_LEAVE_ID = #userLeaveId#
   </update>
   
   <select id="getPasswordHistory" resultClass="java.lang.String" parameterClass="java.lang.String">
  	 select PWD_HIStory from cms_passwordhistory where user_id = #userName#
   </select>
   
   <insert id="insertCRNExpenditure" parameterClass="com.worldcheck.atlas.vo.noncrnexpenditure.NonCRNExpenditureVO">

		<selectKey resultClass="int" type="pre" keyProperty="nonCrnExpenditureId">
			SELECT CMS_NONCRN_EXPENDITURE_SEQ.NEXTVAL AS VALUE FROM DUAL
  </selectKey>
		insert into CMS_NONCRN_EXPENDITURE (NONCRN_EXPENDITURE_ID,VENDOR_NAME,
		COUNTRY_ID,COMMISIONING_DATE,CURRENCY_CODE,EXPENDITURE_AMOUNT,PAYMENT_CYCLE,NO_OF_CYCLES,COMMENTS,UPDATED_BY,UPDATED_ON)
		values
		(#nonCrnExpenditureId#,#vendorName#,#country#,#commissioningDate#,#currency#,#amount#,#paymentCycle#,decode(#noOfCycles#,null,1,#noOfCycles#),#comments#,#userName#,sysdate)
	</insert>
	
	
	<select id="getCountryVendorMaster" resultMap="resultVendorMasterVO" parameterClass="java.lang.String">
        select VENDOR_NAME
		from CMS_NONCRNVENDOR_CNTRY_MAP cvcm
		where cvcm.COUNTRY_ID = #countryId# 
		order by VENDOR_NAME
</select>



<select id="getCRNData" resultClass="com.worldcheck.atlas.vo.massvendordataentry.MassVendorUploadVO" parameterClass="java.util.List">
       SELECT CRN,SUBJECT_NAME nameSearched,Country country
		FROM CMS_SUBJECT CS,CMS_COUNTRY_MASTER CCM
		WHERE CS.COUNTRY_ID = CCM.COUNTRY_MASTER_ID
        AND CRN IN <iterate open="(" close=")" conjunction=",">
      #crnNumbers[]#
     </iterate>
</select>

<select id="getCRNCount" resultClass="java.lang.Integer" parameterClass="java.lang.String">
        select count(*)
		from CMS_CLIENTCASE
		where CRN =  #crn# 
</select>


<select id="getVendorInvoiceId" resultClass="java.lang.Integer" parameterClass="java.util.HashMap">
        SELECT VNDOR_INVOICE_ID
		FROM CMS_VENDORINV_MAP cvim,CMS_VENDOR_INVOICE cvi
		WHERE cvim.VNDOR_INVOICE_ID = cvi.VENDOR_INVOICE_ID
		AND cvim.SUBJECT_NAME =  #Name Searched# 
		AND cvi.CRN =  #CRN# 
		AND cvi.VENDOR_ID = (SELECT VENDOR_MASTER_ID FROM CMS_VENDOR_MASTER WHERE VENDOR_NAME = #Vendor Name#)
</select>


<insert id="insertMassVendorData" parameterClass="java.util.HashMap">
		<selectKey resultClass="int" type="pre" keyProperty="vendorInvoiceId">
			SELECT CMS_VENDORINVOICE_SEQ.NEXTVAL AS VALUE FROM DUAL
	    </selectKey>
		INSERT into CMS_VENDOR_INVOICE (VENDOR_INVOICE_ID,VENDOR_MANAGER_MSG,COMMISIONING_DATE,COST,CRN,CURRENCY_CODE,INVOICE_NO,UPDATED_BY,UPDATED_ON,
		VENDOR_ID,MANAGER,STATUS_CODE,CREATED_BY,CREATED_ON,VENDOR_TYPE_ID,COUNTRY_ID)
		VALUES
		(#vendorInvoiceId#,#Vendor Manager Message#,#Commissioning Date#,#Amount#,#CRN#,#Currency#,#Invoice Number#,#updatedBy#,sysdate,
		(select VENDOR_MASTER_ID from CMS_VENDOR_MASTER where VENDOR_NAME = #Vendor Name#),#updatedBy#,#statusCode#,#updatedBy#,sysdate,
		(select VENDOR_TYPE_ID from CMS_VENDOR_MASTER where VENDOR_NAME = #Vendor Name#),(SELECT COUNTRY_MASTER_ID FROM CMS_COUNTRY_MASTER WHERE COUNTRY = #Country#))
</insert>
	
	
	
<update id="updateMassVendorData" parameterClass="java.util.HashMap">    
		UPDATE CMS_VENDOR_INVOICE SET
	       VENDOR_MANAGER_MSG = #Vendor Manager Message#,
	       COMMISIONING_DATE = #Commissioning Date#,
	       CRN=#CRN#,
	       COST=#Amount#,
	       COUNTRY_ID=(SELECT COUNTRY_MASTER_ID FROM CMS_COUNTRY_MASTER WHERE COUNTRY = #Country#),
	       CURRENCY_CODE=#Currency#,
	       INVOICE_NO=#Invoice Number#,
	       VENDOR_ID=(select VENDOR_MASTER_ID from CMS_VENDOR_MASTER where VENDOR_NAME = #Vendor Name#),
	       VENDOR_TYPE_ID = (select VENDOR_TYPE_ID from CMS_VENDOR_MASTER where VENDOR_NAME = #Vendor Name#),
	       MANAGER=#updatedBy#,
	       UPDATED_BY = #updatedBy#,
	       UPDATED_ON = sysdate
       WHERE
      	   VENDOR_INVOICE_ID in (SELECT VNDOR_INVOICE_ID
		FROM CMS_VENDORINV_MAP cvim,CMS_VENDOR_INVOICE cvi
		WHERE cvim.VNDOR_INVOICE_ID = cvi.VENDOR_INVOICE_ID
		AND cvim.SUBJECT_NAME =  #Name Searched# 
		AND cvi.VENDOR_ID = (SELECT VENDOR_MASTER_ID FROM CMS_VENDOR_MASTER WHERE VENDOR_NAME = #Vendor Name#))
	</update>
	
	<insert id="insertMassVendorMapData" parameterClass="java.util.HashMap">
		<selectKey resultClass="int" type="pre" keyProperty="vendorInvId">
			SELECT CMS_VENDORINVMAP_SEQ.NEXTVAL AS VALUE FROM DUAL
	    </selectKey>
		INSERT into CMS_VENDORINV_MAP (VENDORINV_ID,VNDOR_INVOICE_ID,SUBJECT_ID,SUBJECT_NAME,UPDATED_BY,UPDATED_ON)
		VALUES
			(#vendorInvId#,#vendorInvoiceId#,(select SUBJECT_ID from CMS_SUBJECT where upper(SUBJECT_NAME) = upper(#Name Searched#) AND upper(CRN) = upper(#CRN#) and 
			                                   country_id = (select country_master_id from cms_country_master where upper(COUNTRY) = upper(#Country#)))
			,#Name Searched#,#updatedBy#,sysdate)
</insert>


<select id="getSubCount" resultClass="Integer" parameterClass="java.util.HashMap">

select count(*) from CMS_SUBJECT where upper(SUBJECT_NAME) = upper(#Name Searched#) AND upper(CRN) = upper(#CRN#) and 
			                                   country_id = (select country_master_id from cms_country_master where upper(COUNTRY) = upper(#Country#))
	
</select>
	
<select id="getCRNPidData" resultClass="com.worldcheck.atlas.vo.massvendordataentry.MassVendorUploadVO" parameterClass="java.util.List">
       SELECT CRN,PID
		FROM CMS_CLIENTCASE ccc
		WHERE ccc.CRN IN <iterate open="(" close=")" conjunction=",">
      #crnNumbers[]#
     </iterate>
</select>
	
</sqlMap>
