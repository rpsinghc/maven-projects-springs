<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Invoice">


<resultMap id="accounts"   class="com.worldcheck.atlas.vo.task.invoice.AccountsVO">
	<result property="crn" 	column="CRN"/>
	<result property="accountID" column="ACCOUNT_ID"/>
	<result property="clientCode" column="CLIENT_CODE"/>
	<result property="otherInst" column="OTHER_INSTRUCTION"/>
	<result property="currencyCode" column="CURRENCY_CODE"/>
	<result property="isisUser" column="ISIS_USER"/>
	<result property="caseFee" column="CASE_FEE"/>
	<result property="cancelledCharges" column="WITH_CHARGES"/>
	<result property="credit" column="CREDIT"/>
	<result property="multipleYearBonus" column="MULTIPLE_YEAR_BONUS"/>
	<result property="disbursment" column="DISBURSEMENT"/>
	<result property="toCapetown" column="TO_CAPETOWN"/>
	<result property="handledBY" column="HANDLED_BY"/>
	<result property="billingMethod" column="BILLING_METHOD"/>
	<result property="regNo" column="REGISTER_NO"/>
	<result property="regDate" column="REGISTER_DATE"/>
	<result property="spclBillingInst" column="SPCL_BILLING_INSTRUCTION"/>
	<result property="updateBy" column="UPDATED_BY"/>
	<result property="updateOn" column="UPDATED_ON"/>
</resultMap>


<resultMap id="relatedCRN"   class="com.worldcheck.atlas.vo.task.invoice.AccountsVO">
<result property="crn" 	column="CRN"/>
</resultMap>
	
	<resultMap id="updateCaseFee"   class="com.worldcheck.atlas.vo.task.invoice.AccountsVO">
	<result property="crn" 	column="CRN"/>
	<result property="caseFee" column="CASE_FEE"/>
	</resultMap>
	
	
	
<resultMap id="accountlinkcase"   class="com.worldcheck.atlas.vo.task.invoice.AccountsLinkcasesVO">
		<result property="accountsLinkCaseID" column="accounts_link_case_id"/>
		<result property="linkedCRN" column="linked_crn"/>
		<result property="currency_code" column="currency_code"/>
		<result property="caseFee" column="case_fee"/>
		<result property="caseFee_USD" column="casefee_USD"/>
		<result property="case_status_id" column="case_status_id"/>
		<result property="caseStatus" column="description"/>
		<result property="withCharges" column="with_charges"/>
</resultMap>

		
<resultMap id="invoice"   class="com.worldcheck.atlas.vo.task.invoice.InvoiceVO">
<result property="clientCode" 	column="client_code"/>
<result property="invoiceTo" 	column="invoice_to"/>
<result property="invoiceAddress" 	column="invoice_address"/>
<result property="isisUser" 	column="ISIS_USER"/>
<result property="invoiceInstruction" 	column="invoice_instruction"/>
<result property="pid" 	column="pid"/>
<result property="caseStatusId" 	column="case_status_id"/>
</resultMap>

<resultMap id="capetownInfo"   class="com.worldcheck.atlas.vo.task.invoice.CapetownInfoVO">
<result property="ctDate" 	column="ct_date"/>
<result property="invoiceCurrencyCode" 	column="currency_code"/>
<result property="invoiceDate" 	column="invoice_date"/>
<result property="capetownID"  	column="capetownid"/>
<result property="invoiceNO"  	column="INVOICE_NUMBER"/>
<result property="invoiceAmount"  	column="INVOICE_AMOUNT"/>
<result property="discount"  	column="DISCOUNT"/>
</resultMap>
	<!--- Showing data by ID -->
	
	<!-- Modified By Vishal for CR-96 Currency Conversion MV Removed -->
<select id="getAccountLinkCase" parameterClass="java.util.Map" resultMap="accountlinkcase" >
<!-- SELECT *
FROM
  (SELECT searchResult.*,
    ROWNUM rn
  FROM
    (SELECT accounts_link_case_id,
      ca.currency_code,
      linked_crn,

 CAST(TO_CHAR(
      NVL(ca.case_fee,0),'9,999,999,999,999,990.99'
      ) AS VARCHAR2(28 CHAR)
      ) AS case_fee,

      CAST(TO_CHAR(
      NVL((ca.case_fee/
      (SELECT exchange_rate
      FROM cms_currencyrate_master crm
      WHERE crm.currency_code = ca.currency_code
      AND crm.effective_date  =
        (SELECT MAX(crm2.effective_date)
        FROM cms_currencyrate_master crm2
        WHERE ca.currency_code = crm2.currency_code
        )
      )),0),'9,999,999,999,999,990.99'
      ) AS VARCHAR2(28 CHAR)
      ) AS casefee_usd,
      cc.case_status_id,
      description,
      NVL(ca.with_charges,'No') with_charges
    FROM cms_accounts_linkcases cal,
      cms_accounts ca,
      cms_clientcase cc,
      cms_case_status_master ccsm
    WHERE cal.crn        =#crn#
    AND ca.crn           = cal.linked_crn
    AND cc.crn           = cal.linked_crn
    AND cc.case_status_id= ccsm.case_status_id
    ORDER BY accounts_link_case_id
    ) searchResult
  WHERE (case_status_id!=4
  AND with_charges      ='No')
  OR (case_status_id    =4
  AND with_charges      ='Yes')
  AND ROWNUM            <![CDATA[ <= ]]> #limit#
  )
WHERE rn <![CDATA[ >= ]]> #start#  -->

<!-- Added By Vishal on 06112013 -->

SELECT *
FROM
  (SELECT searchResult.*,
    ROWNUM rn
  FROM
    (
    select a.* from (
    SELECT accounts_link_case_id,
      ca.currency_code,
      linked_crn,

 CAST(TO_CHAR(
      NVL(ca.case_fee,0),'9,999,999,999,999,990.99'
      ) AS VARCHAR2(28 CHAR)
      ) AS case_fee,

      CAST(TO_CHAR(
      NVL((ca.case_fee/
      (SELECT exchange_rate
      FROM cms_currencyrate_master crm
      WHERE crm.currency_code = ca.currency_code
      AND crm.effective_date  =
        (SELECT MAX(crm2.effective_date)
        FROM cms_currencyrate_master crm2
        WHERE ca.currency_code = crm2.currency_code
        )
      )),0),'9,999,999,999,999,990.99'
      ) AS VARCHAR2(28 CHAR)
      ) AS casefee_usd,
      cc.case_status_id,
      description,
      NVL(ca.with_charges,'No') with_charges
    FROM cms_accounts_linkcases cal,
      cms_accounts ca,
      cms_clientcase cc,
      cms_case_status_master ccsm
    WHERE cal.crn        =#crn#
    AND ca.crn           = cal.linked_crn
    AND cc.crn           = cal.linked_crn
    AND cc.case_status_id= ccsm.case_status_id
    ORDER BY accounts_link_case_id
    )a
    
    UNION ALL 
    select b.* from
   ( SELECT accounts_link_case_id,
      ca.currency_code,
      cal.crn as linked_crn,

 CAST(TO_CHAR(
      NVL(ca.case_fee,0),'9,999,999,999,999,990.99'
      ) AS VARCHAR2(28 CHAR)
      ) AS case_fee,

      CAST(TO_CHAR(
      NVL((ca.case_fee/
      (SELECT exchange_rate
      FROM cms_currencyrate_master crm
      WHERE crm.currency_code = ca.currency_code
      AND crm.effective_date  =
        (SELECT MAX(crm2.effective_date)
        FROM cms_currencyrate_master crm2
        WHERE ca.currency_code = crm2.currency_code
        )
      )),0),'9,999,999,999,999,990.99'
      ) AS VARCHAR2(28 CHAR)
      ) AS casefee_usd,
      cc.case_status_id,
      description,
      NVL(ca.with_charges,'No') with_charges
    FROM cms_accounts_linkcases cal,
      cms_accounts ca,
      cms_clientcase cc,
      cms_case_status_master ccsm
    WHERE cal.linked_crn        =#crn#
    AND ca.crn           = cal.crn
    AND cc.crn           = cal.crn
    AND cc.case_status_id= ccsm.case_status_id
    ORDER BY accounts_link_case_id
    )b
    
    ) searchResult
  WHERE (case_status_id!=4
  AND with_charges      ='No')
  OR (case_status_id    =4
  AND with_charges      ='Yes')
  

  AND ROWNUM            <![CDATA[ <= ]]> #limit#
  )
WHERE rn <![CDATA[ >= ]]> #start#

<!-- End By Vishal -->
</select>   
	  
<select id="getTotalCountLinkedCRN"  resultClass="int" >
SELECT count(*) FROM cms_accounts_linkcases WHERE crn=#crn# or linked_crn = #crn# 
</select>  
	  
<select id="getInvoice" resultMap="invoice" >	  
select 
cms_clientcase.client_code,
cms_clientcase.pid, 
cms_clientcase.isis_User,
cms_client_master.invoice_to, 
cms_client_master.invoice_address,
cms_client_master.invoice_instruction,
cms_clientcase.case_status_id
from 
cms_clientcase, cms_client_master
where 
cms_clientcase.crn=#crn# 
AND 
cms_client_master.client_code= cms_clientcase.client_code
</select>

  
<select id="getReportTypeCount" resultClass="int" >	  
select 
count(*)
from 
cms_clientcase cc,
cms_report_type_master crtm, cms_subreport_type_master cstm
where 
crtm.report_type_master_id= cstm.report_type_id
and cstm.subreport_type_master_id in (select subreport_type_master_id from cms_subreport_type_master where SUB_CRN_INITIAL in ('PRE','SSP') and status =1)
and cc.sub_report_type_id= cstm.subreport_type_master_id
and cc.crn=#crn#</select>

<select id="getCapetownInfo" resultMap="capetownInfo">	  
SELECT
cms_tocapetown_info.ct_date,
cms_tocapetown_info.currency_code,
cms_tocapetown_info.invoice_date,
cms_tocapetown_info.id as capetownid,
cms_tocapetown_info.INVOICE_NUMBER,
cms_tocapetown_info.INVOICE_AMOUNT,
cms_tocapetown_info.DISCOUNT
 
FROM cms_tocapetown_info 
WHERE 
cms_tocapetown_info.crn=#crn#
</select>

<select id="getRelatedCRN" resultMap="relatedCRN" >	  
select crn from cms_clientcase where bulk_order_id in (select bulk_order_id FROM cms_clientcase where crn=#crn#)
</select>


<select id="getAccountDetail" resultMap="accounts" >	  
select crn, account_id, billing_method, case_fee,with_charges,client_code, 
currency_code,credit,MULTIPLE_YEAR_BONUS, disbursement, handled_by, isis_user ||','|| isis_user_email_id  as isis_user, other_instruction, 
register_date, register_no, to_capetown, spcl_billing_instruction,UPDATED_BY,UPDATED_ON
from cms_accounts where crn=#crn#
</select>



<insert id="insertInvoiceDetails" parameterClass="com.worldcheck.atlas.vo.task.invoice.AccountsVO">
<selectKey keyProperty="invoiceID" resultClass="int"	type="pre">
		SELECT CMS_ACCOUNTS_SEQ.nextval AS VALUE FROM DUAL
	</selectKey>
 INSERT INTO CMS_ACCOUNTS(CRN,account_ID,CLIENT_CODE,OTHER_INSTRUCTION,CURRENCY_CODE,WITH_CHARGES,ISIS_USER,CASE_FEE,CREDIT,MULTIPLE_YEAR_BONUS,DISBURSEMENT,TO_CAPETOWN,HANDLED_BY,BILLING_METHOD,REGISTER_NO,
	REGISTER_DATE,SPCL_BILLING_INSTRUCTION,UPDATED_BY,BUDGET,ISBUDGETDUEDATECONFIRMED,TAXCODE,UPDATED_ON)  
	VALUES 
	(#crn#,#invoiceID#,#clientCode#,#otherInst#,
	
	<isNull property="currencyCode">
   'USD',
  </isNull>
  <isNotNull property="currencyCode">
   <isEmpty property="currencyCode"> 
   'USD',
   </isEmpty>
    </isNotNull>
	<isNotNull property="currencyCode">
   <isNotEmpty property="currencyCode"> 
   #currencyCode#,
   </isNotEmpty>
  </isNotNull>
  <isNull property="cancelledCharges">
   'No',
  </isNull>
<isNotNull property="cancelledCharges">
     #cancelledCharges#,
   </isNotNull>
	#isisUser#,#caseFee#,#credit#,#multipleYearBonus#,#disbursment#,#toCapetown#,#handledBY# ,#billingMethod#
,#regNo#,TO_DATE(#regDate#,'MM/DD/YYYY'),#spclBillingInst#,#updateBy#,#budget#,#isBudgetDueDateConfirmed#,#taxCode#,sysdate)  
</insert>


 
<update id="updateInvoiceDetails" parameterClass="com.worldcheck.atlas.vo.task.invoice.AccountsVO">

  Update   CMS_ACCOUNTS set 
  CLIENT_CODE = #clientCode#,
  OTHER_INSTRUCTION = #otherInst#,
  CURRENCY_CODE = #currencyCode#,
  CASE_FEE = #caseFee#,
  DISBURSEMENT = #disbursment#,
  CREDIT=#credit#,
  MULTIPLE_YEAR_BONUS=#multipleYearBonus#,
  TO_CAPETOWN = #toCapetown#,
  HANDLED_BY = #handledBY#,
  BILLING_METHOD = #billingMethod#,
  REGISTER_NO = #regNo#,
  REGISTER_DATE = TO_DATE(#regDate#,'MM/DD/YYYY'),
  WITH_CHARGES = #cancelledCharges#,
  SPCL_BILLING_INSTRUCTION = #spclBillingInst#,

  <isNotNull property="budget">
   <isNotEmpty property="budget"> 
    BUDGET=#budget#,
   </isNotEmpty>
  </isNotNull>
  <isNotNull property="isBudgetDueDateConfirmed">
   <isNotEmpty property="isBudgetDueDateConfirmed">
   <!-- Start BI-293 added by 6035037 -->
  <isNull property="budgetConfirmedFlag">
     ISBUDGETDUEDATECONFIRMED=#isBudgetDueDateConfirmed#,
   </isNull>
   <!-- End BI-293 added by 6035037 -->
   </isNotEmpty>
  </isNotNull>
  <isNotNull property="taxCode">
   <isNotEmpty property="taxCode">
    TAXCODE=#taxCode#,
   </isNotEmpty>
  </isNotNull>

  UPDATED_BY = #updateBy#,
  UPDATED_ON = sysdate
	WHERE 
  account_ID=#accountID# 
</update>

 <update id="updateCapetownDetails" parameterClass="com.worldcheck.atlas.vo.task.invoice.InvoiceVO">

  UPDATE   CMS_TOCAPETOWN_INFO SET 
	 CT_DATE=TO_DATE(#ctDate#,'MM/DD/YYYY'),
	 CURRENCY_CODE=#invoiceCurrencyCode#,
	 INVOICE_DATE=TO_DATE(#invoiceDate#,'MM/DD/YYYY'),
	 INVOICE_NUMBER=#invoiceNO#,
	 INVOICE_AMOUNT=#invoiceAmount#,
	 DISCOUNT=#discount#,
	 CRN=#crn#,
	 UPDATED_BY=#updateBy#,
     UPDATED_ON=sysdate
	WHERE 
  	ID=#capetownID# 
</update>

<update id="updateClientDetail" parameterClass="com.worldcheck.atlas.vo.task.invoice.InvoiceVO">

  UPDATE  CMS_CLIENT_MASTER CM SET 
	invoice_to = #invoiceTo#, 
    invoice_address = #invoiceAddress#,
    invoice_instruction = #invoiceInstruction# 
	WHERE 
  	 CM.client_code = #clientCode#
  
</update>

<!-- Query Modified by Vishal for CR-96 Issue on 21-Feb-14-->
 <update id="updateRegNo" parameterClass="java.util.Map">
Update cms_Accounts ca set  
register_no=#regNo#
<!--, register_date= sysdate -->
where crn in( SELECT linked_crn FROM cms_accounts_linkcases where crn = #crn#) or ca.crn = #crn#
</update>

<!-- Query Modified by Vishal for CR-96 Issue on 21-Feb-14-->
<update id="updateRegNoParent" parameterClass="java.util.Map">
Update cms_Accounts ca set  
register_no=#regNo#
<!-- , register_date= sysdate -->
where crn = #crn#
</update>
 
 <select id="getParentInvoiceNo" resultClass="String" parameterClass="String">
 	select register_no from cms_accounts where crn=#linkCRN#
 </select>

<!-- Query Modified by Vishal for CR-96 Issue on 21-Feb-14-->
<update id="updateParentCRNRegNo" parameterClass="java.util.Map">
Update cms_Accounts ca set  
register_no=#regNo#
<!--, register_date= sysdate -->
where ca.crn = #crn#
</update>

 <insert id="insertCapeTownDetails" parameterClass="com.worldcheck.atlas.vo.task.invoice.InvoiceVO">
	<selectKey keyProperty="capetownID" resultClass="int"	type="pre">
		SELECT CMS_TOCAPETOWNINFO_SEQ.nextval AS VALUE FROM DUAL
	</selectKey>
   INSERT INTO  CMS_TOCAPETOWN_INFO(id,crn,ct_date,currency_code,invoice_date,INVOICE_NUMBER,INVOICE_AMOUNT,UPDATED_BY,UPDATED_ON,DISCOUNT)
   values (#capetownID#, #crn#,TO_DATE(#ctDate#,'MM/DD/YYYY'),#invoiceCurrencyCode#,TO_DATE(#invoiceDate#,'MM/DD/YYYY'),
   #invoiceNO#,#invoiceAmount#,#updateBy#,sysdate,#discount#) 
</insert>

<select id="getMaxRegisterNO" resultClass="java.lang.Integer" >	  
 SELECT CMS_REGISTER_NO_SEQ.nextval from dual
</select>

<delete id="unlinkCRN" parameterClass="java.util.Map">
         delete from cms_accounts_linkcases where  
         
         <isNotNull  property="caseList">
					<isNotEmpty property="caseList">
						accounts_link_case_id  IN
						<iterate property="caseList" open="(" close=")" conjunction=",">
							#caseList[]#
						</iterate>
					</isNotEmpty>
				</isNotNull>
         
</delete> 


<delete id="unlinkChildCRN" parameterClass="java.util.Map">
         delete from cms_accounts_linkcases where  
         <isNotNull  property="unlinkedCrnList">
			<isNotEmpty property="unlinkedCrnList">
				LINKED_CRN  IN
				<iterate property="unlinkedCrnList" open="(" close=")" conjunction=",">
					#unlinkedCrnList[]#
				</iterate>
			</isNotEmpty>
	</isNotNull>
         
</delete> 

<!-- and ca.CURRENCY_CODE = ca1.CURRENCY_CODE 
and ca.CURRENCY_CODE is not null and ca1.CURRENCY_CODE is not null -->

<select id="getUnlinkedCRN" parameterClass="java.util.Map" resultClass="com.worldcheck.atlas.vo.task.invoice.CRNInfoVO">
SELECT * FROM (SELECT  searchResult.*, ROWNUM rn FROM (

SELECT ccc.crn, ccc.bulk_order_id,ccc.client_ref, ccc.case_status_id, ccc.isis_user, ccc.pid, ccc.req_recd_dt, 
ccc.CASE_CREATION_DATE as caseCreationDate,ccsm.description caseStatus, cs.subject_name primarySubjectName,
com.office  country, ccc.client_code, ca.currency_code,nvl(ca.with_charges,'No') withcharges,ccc.FINAL_DUE_DATE as caseFinalDueDate
 FROM cms_clientcase ccc, CMS_CASE_STATUS_MASTER ccsm, cms_subject cs, CMS_OFFICE_MASTER com, 
 cms_clientcase ccc1,CMS_ACCOUNTS ca, CMS_ACCOUNTS ca1 
WHERE ccsm.case_status_id = ccc.case_status_id  AND cs.is_primary_sub=1 and cs.crn=ccc.crn 
and com.OFFICE_MASTER_ID = ccc.office_id and  (ccc.case_status_id     !=4 or ca.WITH_CHARGES='Yes')and ccc1.crn = #crn# and 
ccc.crn not in(SELECT linked_crn FROM cms_accounts_linkcases ) AND ccc.crn not in(SELECT crn FROM cms_accounts_linkcases )
 AND ccc.crn not in(#crn#) 
<isEmpty prepend="AND"  property="crnList">
ccc1.CLIENT_CODE = ccc.CLIENT_CODE
</isEmpty>
 and ca1.crn = ccc1.crn and ca.crn=ccc.crn 
and ca.CURRENCY_CODE = ca1.CURRENCY_CODE 
AND ccc.sub_report_type_id not in(select subreport_type_master_id from cms_subreport_type_master where SUB_CRN_INITIAL in ('PRE','SSP') and status =1)
and ca.CURRENCY_CODE is not null and ca1.CURRENCY_CODE is not null

			<isNotNull prepend="AND" property="searchDate">
					<isNotEmpty property="searchDate">
						TRUNC(ccc.req_recd_dt) = TO_DATE(#searchDate#,'YYYY-MM-DD')
					</isNotEmpty>
				</isNotNull>
				
				<isNotNull prepend="AND"  property="crnList">
					<isNotEmpty property="crnList">
						
						<iterate property="crnList" conjunction="OR" open="(" close=")" >
							 upper(ccc.CRN) LIKE '%' || trim(upper(#crnList[]#)) || '%' 
						</iterate>
					</isNotEmpty>
				</isNotNull>

order by crn

 )searchResult WHERE 
(case_status_id!=4 and withcharges='No') or (case_status_id=4 and withcharges='Yes') and  ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>  


<select id="getUnlinkedCRNParent" parameterClass="java.util.Map" resultClass="com.worldcheck.atlas.vo.task.invoice.CRNInfoVO">
SELECT * FROM (SELECT  searchResult.*, ROWNUM rn FROM (

SELECT ccc.crn, ccc.bulk_order_id,ccc.client_ref, ccc.case_status_id, ccc.isis_user, ccc.pid, ccc.req_recd_dt, 
ccc.CASE_CREATION_DATE as caseCreationDate,ccsm.description caseStatus, cs.subject_name primarySubjectName,
com.office  country, ccc.client_code, ca.currency_code,nvl(ca.with_charges,'No') withcharges,ccc.FINAL_DUE_DATE as caseFinalDueDate
 FROM cms_clientcase ccc, CMS_CASE_STATUS_MASTER ccsm, cms_subject cs, CMS_OFFICE_MASTER com, 
 cms_clientcase ccc1,CMS_ACCOUNTS ca, CMS_ACCOUNTS ca1 
WHERE ccsm.case_status_id = ccc.case_status_id  AND cs.is_primary_sub=1 and cs.crn=ccc.crn 
and com.OFFICE_MASTER_ID = ccc.office_id and  (ccc.case_status_id     !=4 or ca.WITH_CHARGES='Yes')and ccc1.crn = #crn# and 
ccc.crn not in(SELECT linked_crn FROM cms_accounts_linkcases )
 AND ccc.crn not in(#crn#) 
<isEmpty prepend="AND"  property="crnList">
ccc1.CLIENT_CODE = ccc.CLIENT_CODE
</isEmpty>
 and ca1.crn = ccc1.crn and ca.crn=ccc.crn 
and ca.CURRENCY_CODE = ca1.CURRENCY_CODE 
and ca.CURRENCY_CODE is not null and ca1.CURRENCY_CODE is not null

				<isNotNull prepend="AND"  property="crnList">
					<isNotEmpty property="crnList">
						
						<iterate property="crnList" conjunction="OR" open="(" close=")" >
							 upper(ccc.CRN) LIKE '%' || trim(upper(#crnList[]#)) || '%' 
						</iterate>
					</isNotEmpty>
				</isNotNull>

order by crn

 )searchResult WHERE 
(case_status_id!=4 and withcharges='No') or (case_status_id=4 and withcharges='Yes') and ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>  

<select id="getPrepaymentSummary" parameterClass="java.util.Map" resultClass="com.worldcheck.atlas.vo.task.invoice.PrepaymentSummaryVO">
SELECT * FROM (SELECT  searchResult.*, ROWNUM rn FROM (
SELECT DISTINCT cc.crn                                                                                                                        ,
  cc.CASE_CREATION_DATE AS caseCreationDate                                                                                                   ,
  ca.currency_code                                                                                                                            ,
   CAST(TO_CHAR(dcc.CASE_FEE,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS CASE_FEE                                                                                                                               ,
  CAST(TO_CHAR(dcc.credit,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS  credit                                                                                                                                ,
  CAST(TO_CHAR(dcc.multiple_year_bonus,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS  multiple_year_bonus                                                                                                                    ,
  CAST(TO_CHAR((dcc.CASE_FEE+ dcc.credit+dcc.multiple_year_bonus),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Prepayment_Credit,
  CAST(TO_CHAR(calculate.total_spent,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS total_spent,
  CAST(TO_CHAR((dcc.CASE_FEE+ dcc.credit+dcc.multiple_year_bonus-calculate.total_spent),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Balance,
  CAST(TO_CHAR((dcc.CASEFEE_USD+ dcc.credit_USD+dcc.multiple_year_bonus_USD),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Prepayment_Credit_USD,
  CAST(TO_CHAR(calculate.total_spent_USD,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS total_spent_USD,
  CAST(TO_CHAR((dcc.CASEFEE_USD+ dcc.credit_USD+dcc.multiple_year_bonus_USD-calculate.total_spent_USD),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Balance_USD 
   FROM cms_clientcase cc                ,
  CMS_ACCOUNTS_LINKCASES cal             ,
  cms_report_type_master crtm            ,
  cms_subreport_type_master cstm         ,
  cms_accounts ca                        ,
  (SELECT CRN, nvl(CASE_FEE,0) as CASE_FEE ,nvl(CREDIT,0) as CREDIT,nvl(MULTIPLE_YEAR_BONUS,0) as MULTIPLE_YEAR_BONUS,ED ,SUBQUR.currency_code , EXCHANGE_RATE ,nvl((case_fee/exchange_rate),0) as casefee_usd,nvl((CREDIT/exchange_rate),0) as CREDIT_usd,nvl((MULTIPLE_YEAR_BONUS/exchange_rate),0) as MULTIPLE_YEAR_BONUS_USD ,REQ_RECD_DT
   FROM cms_currencyrate_master CRM,
   (
   select CMacc.CRN,CASE_FEE,CREDIT,MULTIPLE_YEAR_BONUS,innerq.currency_code , ED ,REQ_RECD_DT
   from CMS_ACCOUNTS CMacc,
    ( select cms_currMst.currency_code ,max(effective_date) as ed ,  cms_cc.crn, REQ_RECD_DT
     from cms_currencyrate_master cms_currMst , cms_accounts cmsAcc  ,cms_clientcase cms_cc
     where
    <!-- cms_cc.REQ_RECD_DT >= cms_currMst.effective_date 
     and -->
     cmsAcc.currency_code =cms_currMst.currency_code
     and cmsAcc.crn = cms_cc.crn
     group by cms_cc.crn , cms_currMst.currency_code , REQ_RECD_DT
     )innerq
     where CMacc.crn = innerq.crn
    
   ) SUBQUR
   WHERE  SUBQUR.currency_code=CRM.currency_code
   AND SUBQUR.ed = CRM.EFFECTIVE_DATE) dcc             ,
  (
  <!-- SELECT calchild.crn                   ,
    SUM(dccchild.case_fee) AS total_spent,
    SUM(dccchild.casefee_usd) total_spent_USD
     FROM cms_accounts_linkcases calchild,
    dw_currency_conversion dccchild
    WHERE calchild.linked_crn= dccchild.crn
 GROUP BY calchild.crn -->

 
  select a.crn,NVL(SUM(a.total_spent),0) as total_spent ,NVL(SUM(a.total_spent_USD),0) as total_spent_USD  from (SELECT cal.crn, SUM( ca.case_fee)  AS total_spent,
  SUM (ca.case_fee/crm.exchange_rate) AS total_spent_USD
FROM cms_accounts ca ,
  cms_currencyrate_master crm ,
  cms_accounts_linkcases cal
WHERE ca.crn         = cal.linked_crn
AND ca.currency_code = crm.currency_code
GROUP BY cal.crn,
 ca.currency_code,
  crm.effective_date
HAVING crm.effective_date IN
  (SELECT MAX(effective_date)
  FROM cms_currencyrate_master
  WHERE currency_code = ca.currency_code
  )
  ) a
  
  group by a.crn
  ) calculate
  WHERE 
  calculate.crn=cc.crn 
  and  cc.crn                     = cal.crn
AND ca.crn                         = cc.crn
AND dcc.crn                        =cc.crn
AND crtm.report_type_master_id     = cstm.report_type_id
AND cstm.subreport_type_master_id IN (select subreport_type_master_id from cms_subreport_type_master where SUB_CRN_INITIAL in ('PRE','SSP') and status =1)
AND cc.sub_report_type_id          = cstm.subreport_type_master_id

				<isNotNull prepend="AND"  property="crnList">
					<isNotEmpty property="crnList">
						<iterate property="crnList" conjunction="OR" open="(" close=")" >
							 upper(cc.CRN) LIKE '%' || trim(upper(#crnList[]#)) || '%' 
						</iterate>
					</isNotEmpty>
				</isNotNull>
        
order by crn

 )searchResult WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
</select>   


<select id="getPrepaymentSummaryCRN" resultClass="com.worldcheck.atlas.vo.task.invoice.PrepaymentSummaryVO">
SELECT DISTINCT cc.crn                                                                                                                        ,
  cc.CASE_CREATION_DATE AS caseCreationDate                                                                                                   ,
  ca.currency_code                                                                                                                            ,
   CAST(TO_CHAR(dcc.CASE_FEE,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS CASE_FEE                                                                                                                               ,
  CAST(TO_CHAR(dcc.credit,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS  credit                                                                                                                                ,
  CAST(TO_CHAR(dcc.multiple_year_bonus,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS  multiple_year_bonus                                                                                                                    ,
  CAST(TO_CHAR((dcc.CASE_FEE+ dcc.credit+dcc.multiple_year_bonus),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Prepayment_Credit,
  CAST(TO_CHAR(calculate.total_spent,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS total_spent,
  CAST(TO_CHAR((dcc.CASE_FEE+ dcc.credit+dcc.multiple_year_bonus-calculate.total_spent),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Balance,
  CAST(TO_CHAR((dcc.CASEFEE_USD+ dcc.credit_USD+dcc.multiple_year_bonus_USD),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Prepayment_Credit_USD,
  CAST(TO_CHAR(calculate.total_spent_USD,'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS total_spent_USD,
  CAST(TO_CHAR((dcc.CASEFEE_USD+ dcc.credit_USD+dcc.multiple_year_bonus_USD-calculate.total_spent_USD),'9,999,999,999,999,990.99') AS VARCHAR2(28 CHAR)) AS Total_Balance_USD 
  FROM cms_clientcase cc                ,
  CMS_ACCOUNTS_LINKCASES cal             ,
  cms_accounts ca                        ,
  (SELECT CRN, nvl(CASE_FEE,0) as CASE_FEE ,nvl(CREDIT,0) as CREDIT,nvl(MULTIPLE_YEAR_BONUS,0) as MULTIPLE_YEAR_BONUS,ED ,SUBQUR.currency_code , EXCHANGE_RATE ,nvl((case_fee/exchange_rate),0) as casefee_usd,nvl((CREDIT/exchange_rate),0) as CREDIT_usd,nvl((MULTIPLE_YEAR_BONUS/exchange_rate),0) as MULTIPLE_YEAR_BONUS_USD ,REQ_RECD_DT
   FROM cms_currencyrate_master CRM,
   (
   select CMacc.CRN,CASE_FEE,CREDIT,MULTIPLE_YEAR_BONUS,innerq.currency_code , ED ,REQ_RECD_DT
   from CMS_ACCOUNTS CMacc,
    ( select cms_currMst.currency_code ,max(effective_date) as ed ,  cms_cc.crn, REQ_RECD_DT
     from cms_currencyrate_master cms_currMst , cms_accounts cmsAcc  ,cms_clientcase cms_cc
     where
   <!--  cms_cc.REQ_RECD_DT >= cms_currMst.effective_date 
     and -->
     cmsAcc.currency_code =cms_currMst.currency_code
     and cmsAcc.crn = cms_cc.crn
     AND cmsAcc.CRN=#crn# 
    
     group by cms_cc.crn , cms_currMst.currency_code , REQ_RECD_DT
     )innerq
     where CMacc.crn = innerq.crn
    
   ) SUBQUR
   WHERE  SUBQUR.currency_code=CRM.currency_code
   AND SUBQUR.ed = CRM.EFFECTIVE_DATE) dcc             ,
  (
  
  <!-- SELECT calchild.crn                   ,
    SUM(dccchild.case_fee) AS total_spent,
    SUM(dccchild.casefee_usd) total_spent_USD
     FROM cms_accounts_linkcases calchild,
    dw_currency_conversion dccchild
    WHERE calchild.linked_crn= dccchild.crn
 GROUP BY calchild.crn -->

 select a.crn,SUM(a.total_spent) as total_spent ,SUM(a.total_spent_USD) as total_spent_USD  from (SELECT cal.crn, SUM( ca.case_fee)  AS total_spent,
  SUM (ca.case_fee/crm.exchange_rate) AS total_spent_USD
FROM cms_accounts ca ,
  cms_currencyrate_master crm ,
  cms_accounts_linkcases cal
WHERE ca.crn         = cal.linked_crn
AND ca.currency_code = crm.currency_code
GROUP BY cal.crn,
 ca.currency_code,
  crm.effective_date
HAVING crm.effective_date IN
  (SELECT MAX(effective_date)
  FROM cms_currencyrate_master
  WHERE currency_code = ca.currency_code
  )
  ) a
  
  group by a.crn
  ) calculate
  WHERE 
  calculate.crn=cc.crn 
  and  cc.crn                     = cal.crn
AND ca.crn                         = cc.crn
AND dcc.crn                        =cc.crn
AND cc.CRN=#crn#    
order by crn
</select>  
 

<select id="getParentCRN" resultClass="com.worldcheck.atlas.vo.task.invoice.CRNInfoVO">
SELECT ccm.crn as linkedCRN, ccm.bulk_order_id,client_ref, ccm.case_status_id, ccm.isis_user, pid, req_recd_dt, CASE_CREATION_DATE as caseCreationDate,description as caseStatus,
(select subject_name  from cms_subject where crn in(ccm.crn) AND is_primary_sub=1) as primarySubjectName,
(select country  from cms_country_master where country_master_id in(ccm.office_id)) as country ,nvl(case_fee,0),nvl(with_charges,'No')
 FROM cms_clientcase  ccm, CMS_CASE_STATUS_MASTER ccsm,cms_accounts ca
WHERE ccsm.case_status_id =ccm.case_status_id and ca.crn=ccm.crn and 
ccm.crn in(SELECT crn FROM cms_accounts_linkcases where linked_crn =  #crn#)
</select>


<select id="getTotalCountUnlinkedCRN" parameterClass="java.util.Map" resultClass="int">
SELECT count(*) FROM cms_clientcase ccc, CMS_CASE_STATUS_MASTER ccsm, cms_subject cs, CMS_OFFICE_MASTER com, 
 cms_clientcase ccc1,CMS_ACCOUNTS ca, CMS_ACCOUNTS ca1 
WHERE ccsm.case_status_id = ccc.case_status_id  AND cs.is_primary_sub=1 and cs.crn=ccc.crn 
and com.OFFICE_MASTER_ID = ccc.office_id and ccc.case_status_id !=4 and ccc1.crn = #crn# and 
ccc.crn not in(SELECT linked_crn FROM cms_accounts_linkcases ) AND ccc.crn not in(SELECT crn FROM cms_accounts_linkcases ) AND ccc.crn not in(#crn#) 
<isEmpty prepend="AND"  property="crnList">
ccc1.CLIENT_CODE = ccc.CLIENT_CODE
</isEmpty>
 and ca1.crn = ccc1.crn and ca.crn=ccc.crn 
and ca.CURRENCY_CODE = ca1.CURRENCY_CODE 
and ca.CURRENCY_CODE is not null and ca1.CURRENCY_CODE is not null
			<isNotNull prepend="AND" property="searchDate">
					<isNotEmpty property="searchDate">
						TRUNC(ccc.req_recd_dt) = TO_DATE(#searchDate#,'YYYY-MM-DD')
					</isNotEmpty>
				</isNotNull>
				
				<isNotNull prepend="AND"  property="crnList">
					<isNotEmpty property="crnList">
						
						<iterate property="crnList" conjunction="OR" open="(" close=")" >
							 upper(ccc.CRN) LIKE '%' || trim(upper(#crnList[]#)) || '%' 
						</iterate>
					</isNotEmpty>
				</isNotNull>
</select>   

<select id="getTotalCountUnlinkedCRNParent" parameterClass="java.util.Map" resultClass="int">
SELECT count(*) FROM cms_clientcase ccc, CMS_CASE_STATUS_MASTER ccsm, cms_subject cs, CMS_OFFICE_MASTER com, 
 cms_clientcase ccc1,CMS_ACCOUNTS ca, CMS_ACCOUNTS ca1 
WHERE ccsm.case_status_id = ccc.case_status_id  AND cs.is_primary_sub=1 and cs.crn=ccc.crn 
and com.OFFICE_MASTER_ID = ccc.office_id and ccc.case_status_id !=4 and ccc1.crn = #crn# and 
ccc.crn not in(SELECT linked_crn FROM cms_accounts_linkcases ) AND ccc.crn not in(#crn#) 
<isEmpty prepend="AND"  property="crnList">
ccc1.CLIENT_CODE = ccc.CLIENT_CODE
</isEmpty> and ca1.crn = ccc1.crn and ca.crn=ccc.crn 
and ca.CURRENCY_CODE = ca1.CURRENCY_CODE 
and ca.CURRENCY_CODE is not null and ca1.CURRENCY_CODE is not null
				<isNotNull prepend="AND"  property="crnList">
					<isNotEmpty property="crnList">
						
						<iterate property="crnList" conjunction="OR" open="(" close=")" >
							 upper(ccc.CRN) LIKE '%' || trim(upper(#crnList[]#)) || '%' 
						</iterate>
					</isNotEmpty>
				</isNotNull>
</select>   

<select id="isChildCRN" resultClass="int">
select count(*) from cms_accounts_linkcases where linked_crn=#crn#
</select>


<insert id="insertLinkedCRN" parameterClass="com.worldcheck.atlas.vo.task.invoice.AccountsLinkcasesVO">
  INSERT INTO CMS_ACCOUNTS_LINKCASES(accounts_link_case_id,crn,linked_crn ,UPDATED_BY,UPDATED_ON)  
	VALUES 
	(CMS_ACCOUNTS_LINKCASES_SEQ.nextval,#crn#,#linkedCRN#,#updateBy#,sysdate) 
</insert> 


<insert id="insertLinkedCRNParent" parameterClass="com.worldcheck.atlas.vo.task.invoice.AccountsLinkcasesVO">
  INSERT INTO CMS_ACCOUNTS_LINKCASES(accounts_link_case_id,crn,linked_crn ,UPDATED_BY,UPDATED_ON)  
	VALUES 
	(CMS_ACCOUNTS_LINKCASES_SEQ.nextval,#linkedCRN#,#crn#,#updateBy#,sysdate) 
</insert> 
	<update id="updateAccountsForChildCrn" parameterClass="com.worldcheck.atlas.vo.task.invoice.AccountsVO">
	update cms_Accounts  SET 
	<isNotNull  property="regDate">
		<isNotEmpty property="regDate">
			register_date=TO_DATE(#regDate# ,'MM/DD/YYYY')
		</isNotEmpty>
	<isEmpty property="regDate">
			register_date=#regDate#
		</isEmpty>
	</isNotNull>
	<isNull  property="regDate">
			register_date=#regDate#
	</isNull>
	where 1=2 and  crn in(select linked_crn from cms_accounts_linkcases where crn=#crn#)
	</update>

<select id="getAccountInfoForLegacy" resultClass="com.worldcheck.atlas.vo.task.invoice.CapetownInfoVO">	  
SELECT 
UNIQUE(CRN) crn, 
invoiceno invoiceNO, 
casefee caseFee, 
currencycode invoiceCurrencyCode, 
disbursement disbursment, 
invamount invoiceAmount, 
invoicedate invoiceDate
FROM 
CLIENTINVOICE @LEGACY
WHERE CRN = #crn#
</select>

<update id="updateRegDateNumberOnUnLinking" parameterClass="java.util.Map">
	update CMS_ACCOUNTS
	set REGISTER_NO='' , 
	REGISTER_DATE=''
	where
	  <isNotNull  property="unlinkedCrnList">
			<isNotEmpty property="unlinkedCrnList">
				crn  IN
				<iterate property="unlinkedCrnList" open="(" close=")" conjunction=",">
					#unlinkedCrnList[]#
				</iterate>
			</isNotEmpty>
	</isNotNull>
</update>

	<select id="isISISCase" resultClass="java.lang.Integer" parameterClass="java.lang.String">
		select ccc.IS_ISIS from CMS_CLIENTCASE ccc where ccc.CRN = #crn# 
	</select>
<update id="updateCaseFee" parameterClass="com.worldcheck.atlas.vo.task.invoice.AccountsVO">
			<!--Start: Added for BI-293 by 6032662
			UPDATE CMS_ACCOUNTS SET CASE_FEE=#caseFee#,ISBUDGETDUEDATECONFIRMED =0 WHERE CRN = #crn#-->
			UPDATE CMS_ACCOUNTS CA SET 
			<isEmpty  property="subjectDeleteFlag">
				  <isNull property="subjectDeleteFlag">
					CASE_FEE=#caseFee#,
				   </isNull>
			 </isEmpty >
			 <isNotEmpty property="subjectDeleteFlag">
				 <isNotNull property="subjectDeleteFlag">
					CA.CASE_FEE =(select sum(subject_FEE) from CMS_SUbject where crn=#crn#),
				  </isNotNull>
			 </isNotEmpty>
			
			ISBUDGETDUEDATECONFIRMED =
			(SELECT CASE CASE_STATUS_ID
			WHEN 1 THEN 0
			WHEN 2 THEN 0
			WHEN 3 THEN 0
			ELSE 1
			END
			FROM CMS_CLIENTCASE WHERE CRN=CA.CRN)
			WHERE CRN = #crn#
			<!-- End: Added for BI-293 by 6032662-->
		</update>
		<update id="updateEDDOCaseFee" parameterClass="com.worldcheck.atlas.vo.task.invoice.AccountsVO">
			<!--Start: Added for BI-293 by 6027780-->
			UPDATE CMS_ACCOUNTS CA SET  
					CASE_FEE=#caseFee#,	
					<isNotEmpty property="isBudgetDueDateConfirmed">
						<isNotNull property="isBudgetDueDateConfirmed">
							ISBUDGETDUEDATECONFIRMED=#isBudgetDueDateConfirmed#
						</isNotNull>
				 	</isNotEmpty>
			WHERE CA.CRN = #crn#
			<!-- End: Added for BI-293 by 6032662-->
		</update>

</sqlMap>