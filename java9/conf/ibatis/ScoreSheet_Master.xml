<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
	
<sqlMap namespace="ScoreSheet_Master"> 

    <resultMap id="resultGrid"   class="com.worldcheck.atlas.vo.masters.ScoreSheetMasterVO">
		<result property="scoresheetMasterId" column="SCORESHEET_MASTER_ID"/>
		<result property="office" column="office"/>
		<result property="scoreSheetName" column="scoreSheetName"/>								
   </resultMap>


   <select id="getScoreSheetGridList" resultMap="resultGrid" parameterClass="com.worldcheck.atlas.vo.masters.ScoreSheetMasterVO"> 
    SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (
    
    SELECT 
		    SCORESHEET_MASTER_ID ,
		    OFFICE,
		    scoresheet_name scoreSheetName
    FROM 
    		CMS_SCORESHEET_MASTER,
    		CMS_OFFICE_MASTER 
    WHERE
    	CMS_SCORESHEET_MASTER.OFFICE_ID=CMS_OFFICE_MASTER.OFFICE_MASTER_ID
    And 
    	CMS_OFFICE_MASTER.STATUS=1
    	<isNotNull property="office">
			<isNotEmpty prepend="AND" property="office">
			OFFICE_ID=#office#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="scoreSheetName">
			<isNotEmpty prepend="AND" property="scoreSheetName">
			UPPER(SCORESHEET_NAME) LIKE UPPER('%'||#scoreSheetName#||'%')
			</isNotEmpty>
		</isNotNull>		
    ORDER BY  upper($sortColumnName$) $sortType$ ,UPPER(SCORESHEET_NAME)  ) a WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
   </select> 
   
   <select id="getScoreSheetCount" resultClass="int" parameterClass="com.worldcheck.atlas.vo.masters.ScoreSheetMasterVO"> 
    SELECT 
		    COUNT(*) 
    FROM 
    		CMS_SCORESHEET_MASTER,
    		CMS_OFFICE_MASTER 
    WHERE
    CMS_SCORESHEET_MASTER.OFFICE_ID=CMS_OFFICE_MASTER.OFFICE_MASTER_ID
    And 
    	CMS_OFFICE_MASTER.STATUS=1
    	<isNotNull property="office">
			<isNotEmpty prepend="AND" property="office">
			OFFICE_ID=#office#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="scoreSheetName">
			<isNotEmpty prepend="AND" property="scoreSheetName">
			UPPER(SCORESHEET_NAME) LIKE UPPER('%'||#scoreSheetName#||'%')
			</isNotEmpty>
		</isNotNull>    
   </select>
   
    <select id="searchExistScoreSheetName"  resultClass="java.lang.Integer" parameterClass = "java.lang.String">
	   SELECT  
	   			COUNT(SCORESHEET_NAME) 
	   FROM 
	   			CMS_SCORESHEET_MASTER 
	   WHERE  
	   			UPPER(SCORESHEET_NAME)=UPPER(TRIM(#scoreSheetName#))  
     </select>
     
     <insert id="insertScoreSheetMaster"  parameterClass="com.worldcheck.atlas.vo.masters.ScoreSheetMasterVO">
      <selectKey resultClass="int" type="pre" keyProperty="scoresheetMasterId">
   				SELECT CMS_SCORESHEETMASTER_SEQ.NEXTVAL AS VALUE FROM DUAL
  	  </selectKey>
     INSERT INTO 
     		CMS_SCORESHEET_MASTER (
				SCORESHEET_MASTER_ID,
				OFFICE_ID,
				IS_GRADING_SYS,
				SCORESHEET_NAME,
				UPDATED_BY,
				UPDATED_ON
		  )
	VALUES(
				#scoresheetMasterId#,
				#office#,
				#gradingSystem#,
				#scoreSheetName#,
				#updatedBy#,
				sysdate
		  )
     </insert>  
     
     <insert id="insertSelectedReviewField"  parameterClass="com.worldcheck.atlas.vo.masters.ScoreSheetMasterVO">
      <selectKey resultClass="int" type="pre" keyProperty="reviewFieldMasterId">
   				SELECT CMS_SSFIELD_MAP_SEQ.NEXTVAL AS VALUE FROM DUAL
  	  </selectKey>
     INSERT INTO CMS_SCORESHEET_FLDS_MAP(
		        SCORESHEET_FLDS_MAP_ID,
		        SHEET_ID,
		        SCORESHEET_FLDS,
		        UPDATED_BY,
		        UPDATED_ON)
	VALUES(
		        #reviewFieldMasterId#,
		        #scoresheetMasterId#,
		        #selectedReviewField#,
		        #updatedBy#,
		        sysdate
		      )
    </insert>
    
    
    <insert id="insertCategory"  parameterClass="com.worldcheck.atlas.vo.masters.ScoreSheetCategoryVO">
      <selectKey resultClass="int" type="pre" keyProperty="categoryMasterId">
   				SELECT CMS_SSCATEG_MAP_SEQ.NEXTVAL AS VALUE FROM DUAL
  	  </selectKey>
	     INSERT INTO CMS_SCORESHEET_CATEG_MAP (
					SCORESHEET_CATEG_ID,
					SHEET_ID,
					CATEGORY,
					UPDATED_BY,
					UPDATED_ON)
		VALUES(
			       #categoryMasterId#,
			       #scoresheetMasterId#,
			       #categoryName#,
			       #updatedBy#,
			       sysdate
			)
		
    </insert> 
    
    <insert id="insertSubCategory"  parameterClass="java.util.Map">
      <selectKey resultClass="int" type="pre" keyProperty="scoreSheetSubCategoryId">
   				SELECT CMS_SSSUBCATEG_MAP_SEQ.NEXTVAL AS VALUE FROM DUAL
  	  </selectKey>
	     INSERT INTO CMS_SCORESHEET_SUBCATEG_MAP (
				SCORESHEET_SUBCATEG_ID,
				SHEET_ID,
				CATEGORY_ID,
				SUB_CATEGORY,
				CNT_OF_ERRORS,
				POINTS,
				UPDATED_BY,
				UPDATED_ON)
		values(
				#scoreSheetSubCategoryId#,
				#scoresheetMasterId#,
				#scoreSheetCategoryId#,
				#scoreSheetSubCategoryName#,
				#countOfError#,
				#point#,
				#updatedBy#,
				sysdate		
			   )
		
    </insert> 
     
     
     <resultMap id="scoreSheetMasterMAP" class="com.worldcheck.atlas.vo.masters.ScoreSheetMasterVO" groupBy="scoresheetMasterId">
		<result property="scoresheetMasterId" column="SCORESHEET_MASTER_ID" />		
		<result property="scoreSheetName" column="SCORESHEET_NAME" />
		<result property="office" column="OFFICE_ID" />
		<result property="gradingSystem" column="IS_GRADING_SYS" />
		<result property="selectedReviewField" column="SCORESHEET_FLDS" />		
		<result property="categoryList" resultMap="ScoreSheet_Master.categoryMAP" />
	</resultMap>
	
	<resultMap id="categoryMAP" class="com.worldcheck.atlas.vo.masters.ScoreSheetCategoryVO" groupBy="categoryMasterId">	
		<result property="scoresheetMasterId" column="SCORESHEET_MASTER_ID" />
		<result property="categoryMasterId" column="SCORESHEET_CATEG_ID" />
		<result property="categoryName" column="CATEGORY" />
		<result property="scoreSheetSubCategory" resultMap="ScoreSheet_Master.subCategoryMAP" />
	</resultMap>
	
	<resultMap id="subCategoryMAP" class="com.worldcheck.atlas.vo.masters.ScoreSheetSubCategoryVO" groupBy="scoreSheetSubCategoryName">		
		<result property="scoresheetMasterId" column="SCORESHEET_MASTER_ID" />
		<result property="categoryMasterId" column="SCORESHEET_CATEG_ID" />
		<result property="scoreSheetSubCategoryId" column="SCORESHEET_SUBCATEG_ID" />
		<result property="scoreSheetSubCategoryName" column="SUB_CATEGORY" />		
		<result property="gradingPoint" resultMap="ScoreSheet_Master.gradingMAP" />
	</resultMap>
	
	<resultMap id="gradingMAP" class="com.worldcheck.atlas.vo.masters.GradingPoint" >		
		<result property="countOfError" column="CNT_OF_ERRORS" />
		<result property="point" column="POINTS" />
		
	</resultMap>
	 
    <select id="getScoreSheetInfo" resultMap="scoreSheetMasterMAP" parameterClass="java.lang.String">
    SELECT 
			SM.SCORESHEET_MASTER_ID,
			SC.SCORESHEET_CATEG_ID,
			SSC.SCORESHEET_SUBCATEG_ID,
			SM.SCORESHEET_NAME,
			SM.OFFICE_ID,
			SM.IS_GRADING_SYS,			
			SC.CATEGORY,
			SSC.SUB_CATEGORY,
			SSC.CNT_OF_ERRORS,
			SSC.POINTS,
			SF.SCORESHEET_FLDS
	FROM
			CMS_SCORESHEET_MASTER SM,
			CMS_SCORESHEET_CATEG_MAP SC,
			CMS_SCORESHEET_SUBCATEG_MAP SSC,
			CMS_SCORESHEET_FLDS_MAP SF
	WHERE
			SM.SCORESHEET_MASTER_ID = SC.SHEET_ID
			AND
			SC.SCORESHEET_CATEG_ID = SSC.CATEGORY_ID
			AND
			SM.SCORESHEET_MASTER_ID= SF.SHEET_ID
			AND 
			SM.SCORESHEET_MASTER_ID=#scoresheetMasterId# 
			ORDER BY 
            SC.SCORESHEET_CATEG_ID,
			SSC.SCORESHEET_SUBCATEG_ID
  </select>  
	
	<delete id="deleteScoreSheet" parameterClass="java.util.List">
	 		DELETE FROM CMS_SCORESHEET_MASTER SM WHERE SM.SCORESHEET_MASTER_ID IN
	 		<iterate open="(" close=")" conjunction=",">
			#scoreSheetIdList[]#
			</iterate>	 		       
	</delete>
		
</sqlMap>