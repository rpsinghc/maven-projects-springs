<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="CurrencyMaster">

	<resultMap id="resultCurrencyMasterVO" class="com.worldcheck.atlas.vo.masters.CurrencyMasterVO">
    <result property="currencyCode" column="currencyCode"/>
    <result property="currency" column="CURRENCY"/>
    <!--  <result property="currencyShortForm" column="SHORT_FORM"/>-->
    </resultMap>
    
	
	<!--- Showing data by ID -->
	
	 <select id="searchCurrency" parameterClass="com.worldcheck.atlas.vo.masters.CurrencyMasterVO" resultMap="resultCurrencyMasterVO" >
	 	SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (SELECT CURRENCY_CODE currencyCode,CURRENCY  FROM  CMS_CURRENCY_MASTER 
	 	WHERE STATUS = #currencyStatus# 
			<isNotNull prepend="AND" property="currency">
	 			<isNotEmpty property="currency">
           			UPPER(CURRENCY) LIKE '%'|| UPPER(TRIM(#currency#))||'%'
           		</isNotEmpty>
      		</isNotNull>
      	order by upper($sortColumnName$) $sortType$) a WHERE ROWNUM <![CDATA[ <= ]]> #limit#) WHERE rn <![CDATA[ >= ]]> #start#
	</select>
	
	<select id="searchCurrencyCount" parameterClass="com.worldcheck.atlas.vo.masters.CurrencyMasterVO" resultClass = "java.lang.Integer">
	 	SELECT COUNT(CURRENCY_CODE) FROM  CMS_CURRENCY_MASTER 
		WHERE STATUS = #currencyStatus#
			<isNotNull prepend="AND" property="currency">
	 			<isNotEmpty property="currency">
           			UPPER(CURRENCY) LIKE '%'|| UPPER(TRIM(#currency#))||'%'
           		</isNotEmpty>
      		</isNotNull>
      		
	</select>
	    
	
	<select id="selectAll"  resultMap="resultCurrencyMasterVO" >
	 	SELECT CURRENCY_CODE,CURRENCY FROM  CMS_CURRENCY_MASTER order by UPPER(CURRENCY_CODE)	  
	 </select>   
	

	
	<insert id="addNewCurrency" parameterClass="com.worldcheck.atlas.vo.masters.CurrencyMasterVO"> 
    		INSERT INTO CMS_CURRENCY_MASTER(CURRENCY_CODE,CURRENCY,STATUS,UPDATED_BY,UPDATED_ON)  
    		VALUES (#currencyCode#,#currency#,#currencyStatus#,#updateBy#,SYSDATE) 
	</insert>

	<update id="updateCurrency" parameterClass="com.worldcheck.atlas.vo.masters.CurrencyMasterVO">
		UPDATE CMS_CURRENCY_MASTER 
			SET CURRENCY = #currency# ,
			STATUS=#currencyStatus#,UPDATED_BY=#updateBy#,	UPDATED_ON = SYSDATE 
		WHERE CURRENCY_CODE = #currencyCode#
	</update>
	
	<update id="deactivateCurrency" parameterClass="java.util.HashMap">
		UPDATE CMS_CURRENCY_MASTER 
			SET STATUS= 0 ,
			UPDATED_BY=#updateBy#,	UPDATED_ON = SYSDATE
		WHERE CURRENCY_CODE = #currencyCode#
	</update>
	
	<update id="activateCurrency" parameterClass="java.util.HashMap">
		UPDATE CMS_CURRENCY_MASTER 
			SET STATUS= 1 ,
			UPDATED_BY=#updateBy#,	UPDATED_ON = SYSDATE
		WHERE CURRENCY_CODE = #currencyCode#
	</update>
	
	<select id="searchExistCurrency"  resultClass="java.lang.Integer" parameterClass = "String">
	 	SELECT COUNT(CURRENCY) 
	 	FROM  CMS_CURRENCY_MASTER 
	 	WHERE
	 	  	UPPER(CURRENCY) LIKE UPPER(TRIM(#currency#))
     </select> 
     <!-- 
     <select id="searchExistCurrencyShortForm"  resultClass="java.lang.Integer" parameterClass = "String">
	 	SELECT COUNT(SHORT_FORM) 
	 	FROM  CMS_CURRENCY_MASTER 
	 	WHERE
	 	  	UPPER(SHORT_FORM) LIKE  UPPER(TRIM(#currencyShortForm#))
      </select> 
       -->
      <select id="searchExistCurrencyCode"  resultClass="java.lang.Integer" parameterClass = "String">
	 	SELECT COUNT(CURRENCY_CODE) 
	 	FROM  CMS_CURRENCY_MASTER 
	 	WHERE
	 	  	UPPER(CURRENCY_CODE) LIKE  UPPER(TRIM(#CURRENCY_CODE#))
      </select>
       
      <select id="seacrhCurrencyByCode"  resultClass="com.worldcheck.atlas.vo.masters.CurrencyMasterVO" parameterClass = "String">
	 	SELECT CURRENCY_CODE currencyCode,
	 	CURRENCY currency,
	 	STATUS currencyStatus
	 	FROM  CMS_CURRENCY_MASTER 
	 	WHERE
	 	  	CURRENCY_CODE = #currencyCode#
      </select> 
      
      <select id="associatedCurrency"  resultClass="com.worldcheck.atlas.vo.masters.CurrencyMasterVO"
	parameterClass="com.worldcheck.atlas.vo.masters.CurrencyMasterVO">
		SELECT * FROM 
		(SELECT COUNT(CRN)acCount FROM CMS_CLIENTCASE
			WHERE CASE_STATUS_ID IN	(1,3)
			AND CRN IN (SELECT CRN FROM CMS_ACCOUNTS WHERE CURRENCY_CODE = #currencyCode#)),
		(SELECT COUNT(CRN) tocptownCount FROM CMS_CLIENTCASE
			WHERE  CASE_STATUS_ID IN (1,3)
			AND  CRN IN (SELECT CRN FROM CMS_TOCAPETOWN_INFO WHERE CURRENCY_CODE = #currencyCode#)),
		(SELECT COUNT(CRN)vendorCount FROM CMS_CLIENTCASE
			WHERE  CASE_STATUS_ID IN (1,3)
			AND  CRN IN (SELECT CRN FROM CMS_VENDOR_INVOICE WHERE CURRENCY_CODE = #currencyCode#)),
		(SELECT COUNT(NONCRN_EXPENDITURE_ID) noncrnCount FROM CMS_NONCRN_EXPENDITURE
			WHERE   CURRENCY_CODE = #currencyCode#),
		(SELECT COUNT(DISTINCT CRN)recCaseCount FROM CMS_RECURR_CLIENTCASE
		   WHERE CURRENCY_CODE = #currencyCode#
		   AND RECURR_ENDDATE > SYSDATE)
	</select> 
	
 <!--Added By Juheen.For CR-2(query to ExportToExcel in Currency Master.) -->
 
<select id ="export_ToXls" parameterClass="java.lang.String" remapResults="true" resultClass="java.util.LinkedHashMap">
 SELECT *
    FROM
  (SELECT DISTINCT A.currency_code currencyCode ,
    TO_CHAR(A.effective_date,'dd-Mon-YYYY') startDate                  ,
    CASE WHEN   A.currency_code='USD'
    THEN '1.0000'
    ELSE DECODE(crm_1.exchange_rate,NULL,'NA',TO_CHAR(crm_1.exchange_rate,999999.9999))
    END AS exchangeRate
   
     FROM CMS_CURRENCYRATE_MASTER crm_1                                              ,
    (SELECT MAX(DISTINCT(crm_1.effective_date)) effective_date,
    
      A.currency_code
       FROM CMS_CURRENCYRATE_MASTER crm_1,
      (SELECT currency_code FROM CMS_CURRENCY_MASTER WHERE STATUS = 1
      )A
   GROUP BY A.currency_code,
    TRUNC(crm_1.effective_date)
    )A
    WHERE crm_1.currency_code(+)= A.currency_code
  AND crm_1.effective_date(+)   = A.effective_date
 ORDER BY a.effective_date ,a.currency_code
    
  ) PIVOT ( MAX(exchangeRate) FOR currencyCode IN ($activeCurrencyCodes$) )
   ORDER BY 
      cast(to_char(to_date(startDate, 'DD-Mon-YYYY'),'YYYY') AS NUMBER(4,0)) desc,
      cast(to_char(to_date(startDate, 'DD-Mon-YYYY'),'MM') AS NUMBER(2,0)) desc,
      cast(to_char(to_date(startDate, 'DD-Mon-YYYY'),'DD') AS NUMBER(2,0)) desc
	  
</select>

 <!--
<select id ="activatedCurrency" resultClass="java.lang.String">
 SELECT wm_concat(''''||replace(currency_code,',',''',''')||'''')  FROM CMS_CURRENCY_MASTER WHERE STATUS = 1
</select>
 -->

</sqlMap>