<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="UnconfirmBudget">


	<select id="unconfirmedBudgetDetails" resultClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO" 
				parameterClass="java.lang.String">
		   select * from(select ccc.CRN crn,ccc.ORDER_GUID isisOrderId,ccc.BULK_ORDER_ID bulkOrderId,ccsm.STATUS_CODE caseStatus, 
			  TO_CHAR(ccc.REQ_RECD_DT,'dd-Mon-yyyy HH24:MI:SS') receivedDate,
			TO_CHAR(ccc.RSRCH_INT_DUEDATE1,'dd Mon, YYYY') RIDD1,
            TO_CHAR(ccc.RSRCH_INT_DUEDATE2,'dd Mon, YYYY') RIDD2,
            TO_CHAR(ccc.RSRCH_FINAL_DUE_DATE,'dd Mon, YYYY') finalRDate,
			  TO_CHAR(ccc.CLIENT_INT_DUEDATE1,'dd Mon, YYYY') IDD1 ,
			  TO_CHAR(ccc.CLIENT_INT_DUEDATE2,'dd Mon, YYYY') IDD2,
			TO_CHAR(ccc.FINAL_DUE_DATE,'dd Mon, YYYY')  finalDate, 
			decode(ca.CASE_FEE,null,0,ca.CASE_FEE) caseFee ,ccm.CURRENCY_CODE currency,ca.ISBUDGETDUEDATECONFIRMED isConfirmed,
            TO_CHAR(ctd.REV_INTDUEDATE1,'dd Mon, YYYY') STIDD1,
            TO_CHAR(ctd.REV_INTDUEDATE2,'dd Mon, YYYY') STIDD2,
			CASE WHEN ctd.TEAM_TYPE_ID=2 THEN TO_CHAR(ctd.REV_FINDUEDATE,'dd Mon, YYYY') ELSE '' END supportingTeam1DueDate,
			ctd.TEAM_ID teamId,
			cum.LOGIN_ID caseMgrId,
            cum.USER_FULL_NAME caseManagerName,
            row_number() over(PARTITION BY ca.crn ORDER BY CASE WHEN ctd.team_type_id = 2 THEN to_date(ctd.rev_finduedate,'dd-MM-YYYY')   
			ELSE sysdate  END) r_num
			from CMS_CLIENTCASE ccc
			LEFT JOIN CMS_ACCOUNTS ca ON ca.CRN = ccc.CRN
			LEFT JOIN CMS_CURRENCY_MASTER ccm ON ccm.CURRENCY_CODE = ca.CURRENCY_CODE
			LEFT JOIN CMS_TEAM_DETAILS ctd ON ctd.CRN = ccc.CRN
			LEFT JOIN CMS_USER_MASTER cum ON ccc.CASE_MGR_ID = cum.LOGIN_ID
			LEFT JOIN CMS_CASE_STATUS_MASTER ccsm ON ccc.CASE_STATUS_ID = ccsm.CASE_STATUS_ID
			where ccc.CRN = #crn# and ccc.IS_ISIS=1 ) where r_num=1

	</select>
	
	<select id="getDetailForISIS" resultClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO" 
				parameterClass="java.lang.String">
		select a.*,b.currency 
		from (select ccc.CRN crn, ccsm.STATUS_CODE caseStatus 
		        from CMS_CLIENTCASE ccc,CMS_CASE_STATUS_MASTER ccsm 
		        where ccc.CRN = #crn# and ccc.CASE_STATUS_ID = ccsm.CASE_STATUS_ID) a
		left join (select ca.crn,ca.CASE_FEE,ccm.CURRENCY_CODE currency 
		        from CMS_ACCOUNTS ca,CMS_CURRENCY_MASTER ccm 
		        where ca.CURRENCY_CODE = ccm.CURRENCY_CODE) b 
		on b.CRN = a.CRN
	</select>
	
	<update id="saveUnconfirmedBudgetDetails" parameterClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO">
		update CMS_ACCOUNTS set 
			CASE_FEE = #caseFee#,
			ISBUDGETDUEDATECONFIRMED = 1,
			UPDATED_BY = #updatedBy#, 
			UPDATED_ON = SYSDATE
		where CRN = #CRN#
	</update>

	<update id="updateFinalDueDate" parameterClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO">
		update CMS_CLIENTCASE set
			CASE_MGR_ID = #caseMgrId#,
			FINAL_DUE_DATE = #finalDate#,  
			RSRCH_FINAL_DUE_DATE= #finalRDate#,  
			UPDATED_BY = #updatedBy#, 
			UPDATED_ON = SYSDATE
		where CRN = #CRN#
	</update>
	
	<update id="updateFinalDueDateForBulk" parameterClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO">
		update CMS_CLIENTCASE set
			CASE_MGR_ID = #caseMgrId#,
			FINAL_DUE_DATE = #finalDate#,
			RSRCH_FINAL_DUE_DATE= #finalRDate#,  
			UPDATED_BY = #updatedBy#, 
			UPDATED_ON = SYSDATE
		where CRN = #CRN#
	</update>
	
	<update id="updateSupportingInternal1DueDate" parameterClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO">
		update CMS_TEAM_DETAILS set
			REV_FINDUEDATE = #supportingTeam1DueDate#, 
			UPDATED_BY = #updatedBy#, 
			UPDATED_ON = SYSDATE
		where TEAM_ID = #teamId#
	</update>
	
	
	
	<select id="getUnconfirmedBudgetDetails"
		resultClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO"
		parameterClass="com.worldcheck.atlas.vo.task.invoice.UnconfimredBudgetVO">
		SELECT * FROM (SELECT searchResult.*, ROWNUM rn FROM (select ca.CRN
		crn,ccm.CURRENCY_CODE currency,decode(ca.CASE_FEE,null,0,ca.CASE_FEE)
		caseFee,
		TO_CHAR(ccc.REQ_RECD_DT,'dd-Mon-yyyy HH24:MI:SS') receivedDate,
		TO_CHAR(ccc.RSRCH_INT_DUEDATE1,'dd Mon, YYYY') RIDD1,
                TO_CHAR(ccc.RSRCH_INT_DUEDATE2,'dd Mon, YYYY') RIDD2,
                TO_CHAR(ccc.RSRCH_FINAL_DUE_DATE,'dd Mon, YYYY') finalRDate,
		TO_CHAR(ccc.CLIENT_INT_DUEDATE1,'dd Mon, YYYY') IDD1 ,
		TO_CHAR(ccc.CLIENT_INT_DUEDATE2,'dd Mon, YYYY') IDD2,
		TO_CHAR(ccc.FINAL_DUE_DATE,'dd Mon, YYYY') finalDate,
                TO_CHAR(ctd.REV_INTDUEDATE1,'dd Mon, YYYY') STIDD1,
                TO_CHAR(ctd.REV_INTDUEDATE2,'dd Mon, YYYY') STIDD2,
        CASE WHEN ctd.TEAM_TYPE_ID=2 THEN TO_CHAR(ctd.REV_FINDUEDATE,'dd Mon, YYYY') ELSE '' END supportingTeam1DueDate,
        ctd.TEAM_ID teamId,
        cum.LOGIN_ID caseMgrId,
        cum.USER_FULL_NAME caseManagerName,
		ccc.IS_SUBJ_LEVEL_SUBRPT_REQ isSubreportRequire,
		
        row_number() over(PARTITION BY ca.crn ORDER BY CASE WHEN ctd.team_type_id = 2 THEN to_date(ctd.rev_finduedate,'dd-MM-YYYY')   
		ELSE sysdate  END) r_num
		from CMS_CLIENTCASE ccc 
        LEFT JOIN CMS_ACCOUNTS ca ON ca.CRN = ccc.CRN
        LEFT JOIN CMS_CURRENCY_MASTER ccm ON ccm.CURRENCY_CODE = ca.CURRENCY_CODE
        LEFT JOIN CMS_TEAM_DETAILS ctd ON ctd.CRN = ccc.CRN
        LEFT JOIN CMS_USER_MASTER cum ON ccc.CASE_MGR_ID = cum.LOGIN_ID
		where ca.ISBUDGETDUEDATECONFIRMED = 0 and ccc.IS_ISIS=1 
        and ccc.CASE_STATUS_ID in (2,3) and ccc.CASE_MGR_ID = #caseMgrId#
		order by upper($sortColumnName$)
		$sortType$)searchResult WHERE ROWNUM <![CDATA[ <= ]]>
		#limit# and r_num=1) WHERE rn <![CDATA[ >= ]]>
		#start#
	</select>

	<select id="getUnconfirmedBudgetDetailsCount" resultClass="java.lang.Integer"
	parameterClass="java.lang.String">
		select count(ca.CRN)
		from CMS_CLIENTCASE ccc, CMS_ACCOUNTS ca, CMS_CURRENCY_MASTER ccm
		where ca.ISBUDGETDUEDATECONFIRMED = 0 and ca.CRN = ccc.CRN and
		ccm.CURRENCY_CODE = ca.CURRENCY_CODE and ccc.IS_ISIS=1 and ccc.CASE_STATUS_ID in (2,3) and ccc.CASE_MGR_ID = #caseMgrId#
	</select>

   <select id="getCaseOffice" resultClass="java.lang.String" parameterClass="java.lang.String">
	select office_id from cms_clientcase where crn=#crn#
	</select>	
	
		
	
</sqlMap>