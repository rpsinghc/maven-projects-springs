<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap 
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="AuditHistory">
<insert id="insertCaseHistoryEvent" parameterClass="com.worldcheck.atlas.vo.audit.CaseHistory">
	<selectKey resultClass="int" type="pre" keyProperty="caseHistoryID">
		select CMS_CASEHISTORY_SEQ.NEXTVAL AS VALUE FROM DUAL
   </selectKey>
	insert into CMS_CASE_HISTORY (
		CASE_HISTORY_ID,
		PID,
		PROCESSCYCLE,
		CRN,
		TASKNAME,
		TASKSTATUS,
		PERFORMER,
		MODTIME,
		IS_VISIBLE_TO_ALL
	)values (
		#caseHistoryID#,
        #pid#,
		#processCycle#,
        #CRN#,
		#taskName#,
        #taskStatus#,
        #performer#,
		SYSDATE,
		#isVisibileForAll#
	)

</insert>
<insert id="insertCaseHistoryDetail" parameterClass="com.worldcheck.atlas.vo.audit.CaseHistory">
	insert into CMS_CASE_HISTORY_DETAILS (
		CASE_HISTORY_ID,
		OLDINFO,
		NEWINFO,
		FIELDNAME,
		MODTIME
	)values (
		#caseHistoryID#,
        #oldInfo#,
		#newInfo#,
        #action#,
		SYSDATE
	)
</insert>

<insert id="insertReviewHistoryEvent" parameterClass="com.worldcheck.atlas.vo.audit.ReviewHistory">
	<selectKey resultClass="int" type="pre" keyProperty="reviewId">
		select cms_review_history_SEQ.NEXTVAL AS VALUE FROM DUAL
   </selectKey>
	insert into CMS_REVIEW_HISTORY (
		REVIEW_ID,
		CRN,
		TASK_NAME,
		REVIEW_STATUS,
		REVIEW_COMMENTS,
		COMMENT_FROM,
                SERVER_TIME,
		UPDATED_BY,
		UPDATED_ON
	)values (
		#reviewId#,#CRN#,
		#taskName#,#reviewStatus#,
		#reviewComment#,#commentFrom#, sysdate,
        #updatedBy#, sysdate
       )

</insert>
	<resultMap id="reviewHistoryResultMap"   class="com.worldcheck.atlas.vo.audit.ReviewHistory">
		
		 <result property="reviewId" column="REVIEW_ID"/>
		<result property="CRN" column="CRN"/>
		<result property="taskName" column="taskName"/>
		<result property="reviewStatus" column="REVIEW_STATUS"/>
		<result property="reviewComment" column="REVIEW_COMMENTS"/>		
		<result property="commentFrom" column="commentFrom"/>
		<result property="updatedOn" column="updatedOn"/>
	</resultMap>

	<select id="getReviewHistoryData" resultMap="reviewHistoryResultMap" parameterClass="java.util.HashMap">
		SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (
			select REVIEW_ID,CRN,TASK_NAME as taskName,REVIEW_STATUS,
			REVIEW_COMMENTS,
			 decode(cum.USER_FULL_NAME,null,crh.COMMENT_FROM ,cum.USER_FULL_NAME) commentFrom,
			TO_CHAR(SERVER_TIME, 'DD-MM-YY HH24:MI:SS') as updatedOn 

			FROM CMS_REVIEW_HISTORY crh
			LEFT JOIN CMS_USER_MASTER  cum ON cum.LOGIN_ID = crh.COMMENT_FROM
			WHERE crn=#crn# 
			order by upper($sort$) $dir$
		) a WHERE ROWNUM &lt;= #limit#) WHERE rn  >= #start#
	</select> 

<select id="getReviewHistoryCount" parameterClass="java.lang.String" resultClass="java.lang.Integer">
		SELECT COUNT(*)
		FROM CMS_REVIEW_HISTORY 
		WHERE crn=#CRN# 
		ORDER BY SERVER_TIME DESC
	</select>

 <resultMap id="caseHistoryResultMap" class="com.worldcheck.atlas.vo.audit.CaseHistory">

		<result property="CRN" column="CRN"/>
		<result property="processCycle" column="PROCESSCYCLE"/>
		<result property="action" column="ACTION"/>
		<result property="taskName" column="TASKNAME"/>
		<result property="taskStatus" column="TASKSTATUS"/>		
		<result property="performer" column="PERFORMER"/>
		<result property="oldInfo" column="OLDINFO"/>
		<result property="newInfo" column="NEWINFO"/>
		<result property="serverTime" column="serverTime"/>
	</resultMap>

	<select id="getCaseHistoryData" resultMap="caseHistoryResultMap" parameterClass="java.util.HashMap">	        
	SELECT * FROM (SELECT  a.*, ROWNUM rn FROM (
        SELECT ch.CRN ,PROCESSCYCLE,
        chd.FIELDNAME AS ACTION,
        TASKNAME,TASKSTATUS,
        decode(cum.USER_FULL_NAME,null,ch.PERFORMER,cum.USER_FULL_NAME) PERFORMER,
        chd.OLDINFO,chd.NEWINFO,
        TO_CHAR(ch.MODTIME , 'DD-MM-YY HH24:MI:SS')AS serverTime
        FROM 
        CMS_CASE_HISTORY_DETAILS chd ,CMS_CASE_HISTORY ch
        left join   CMS_USER_MASTER cum  on cum.LOGIN_ID = ch.PERFORMER
        WHERE ch.CASE_HISTORY_ID = chd.CASE_HISTORY_ID   and crn=#CRN# 
		<isEqual property="isEligibleForCompleteCaseHistory" compareValue="0">
				  and IS_VISIBLE_TO_ALL =1    
		</isEqual> 

		<isEqual property="sort" compareValue="serverTime">
				  order by ch.MODTIME $dir$ ,ch.CASE_HISTORY_ID
		</isEqual>  			
		<isNotEqual property="sort" compareValue="serverTime">
		  	ORDER By upper($sort$) $dir$,ch.CASE_HISTORY_ID
	    </isNotEqual> 
	) a WHERE ROWNUM &lt;= #limit#) WHERE rn  >= #start#
	</select> 

<select id="getCaseHistoryCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
	SELECT count(*)
        FROM 
        CMS_CASE_HISTORY_DETAILS chd ,CMS_CASE_HISTORY ch
        left join   CMS_USER_MASTER cum  on cum.LOGIN_ID = ch.PERFORMER
        WHERE ch.CASE_HISTORY_ID = chd.CASE_HISTORY_ID   and crn=#CRN# 
		<isEqual property="isEligibleForCompleteCaseHistory" compareValue="0">
				  and IS_VISIBLE_TO_ALL =1    
		</isEqual>
	</select>

<resultMap id="subjectResultMap" class="java.util.HashMap">   
	<result property="key" column="subject_id"/> 
	 <result property="value" column="subject_name"/>
</resultMap>
<select id="getSubjectIdNameMap" resultMap="subjectResultMap" parameterClass="java.util.List" remapResults="true">
		
		 SELECT subject_id , subject_name
		FROM cms_subject WHERE crn in 
			<iterate open="(" close=")" conjunction=",">
				#crnList[]#
			</iterate>	
		
</select> 

<select id="getCCSTimestamp" parameterClass="java.lang.String" resultClass="java.sql.Timestamp">
	select max(chd.modtime)
	from cms_case_history_details chd left join cms_case_history ch on 
	chd.case_history_id=ch.case_history_id
	where ch.pid=#pid#
	AND ch.taskname='Client Submission Task' 
	and ch.taskstatus='Approved'
	and chd.fieldname ='Approved at Client Submission Task'
</select>



</sqlMap>