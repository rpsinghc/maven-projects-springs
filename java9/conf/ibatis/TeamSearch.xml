<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="TeamSearch">

	<select id="getAllAnalyst" resultClass="com.worldcheck.atlas.vo.masters.UserMasterVO">
		SELECT DISTINCT(UM.LOGIN_ID) USERID,
		UM.USER_FULL_NAME USERFULLNAME
		FROM CMS_USER_MASTER UM,
		CMS_USER_ROLE_MAP RM
		WHERE UM.STATUS = 1
		AND RM.ROLE_ID IN('R4', 'R5', 'R6')
		AND UM.USER_MASTER_ID = RM.USER_ID
		ORDER BY UPPER(UM.USER_FULL_NAME)
	</select>

	<select id="getAllReviewer" resultClass="com.worldcheck.atlas.vo.masters.UserMasterVO">
		SELECT
		DISTINCT(UM.LOGIN_ID) USERID,
		UM.USER_FULL_NAME USERFULLNAME
		FROM CMS_USER_MASTER UM, CMS_USER_ROLE_MAP RM
		WHERE
		UM.STATUS = 1
		AND
		RM.ROLE_ID IN ('R2','R4','R7')
		AND
		UM.USER_MASTER_ID = RM.USER_ID
		ORDER BY UPPER(UM.USER_FULL_NAME)
	</select>

	<select id="getAllBIVendorMgr" resultClass="com.worldcheck.atlas.vo.masters.UserMasterVO">
		SELECT
		DISTINCT(UM.LOGIN_ID) USERID,
		UM.USER_FULL_NAME USERFULLNAME
		FROM CMS_USER_MASTER UM, CMS_USER_ROLE_MAP RM
		WHERE
		UM.STATUS = 1
		AND
		RM.ROLE_ID IN ('R2','R4','R5','R6','R7')
		AND
		UM.USER_MASTER_ID = RM.USER_ID
		ORDER BY UPPER(UM.USER_FULL_NAME)
  </select>

  <select id="getAllVendorMgr" resultClass="com.worldcheck.atlas.vo.masters.UserMasterVO">
		SELECT
		DISTINCT(UM.LOGIN_ID) USERID,
		UM.USER_FULL_NAME USERFULLNAME
		FROM CMS_USER_MASTER UM, CMS_USER_ROLE_MAP RM
		WHERE
		UM.STATUS = 1
		AND
		RM.ROLE_ID IN ('R2','R4','R5','R12','R7')
		AND
		UM.USER_MASTER_ID = RM.USER_ID
		ORDER BY UPPER(UM.USER_FULL_NAME)
  </select>


	<select id="getTeamSearchResult" parameterClass="com.worldcheck.atlas.vo.search.TeamSearchVO"
		resultClass="com.worldcheck.atlas.vo.search.TeamSearchVO">
		SELECT * FROM (SELECT a.*, ROWNUM rn FROM (SELECT DISTINCT(cc.crn) crnno,
		sub.subject_name primarySubject,
		com.office,
		concat(concat(ctt.TEAM_TYPE,'##'),td.team_id) teamName,
		cum.user_full_name analyst,
		rev1.user_full_name reviewer1,
		rev2.user_full_name reviewer2,
		rev3.user_full_name reviewer3,
		 to_char(td.REV_INTDUEDATE1,    'dd-MM-yy') intrimduedate1,
       to_char(td.REV_INTDUEDATE2,    'dd-MM-yy') intrimduedate2,
       to_char(td.REV_FINDUEDATE,    'dd-MM-yy') finalduedate,
		'0' islegacydata,
		(case when ctt.TEAM_TYPE = 'Supporting - BI' then
		managername.user_full_name end) bianalyst,
		(case when ctt.TEAM_TYPE = 'Primary' then managername.user_full_name
		when ctt.team_type = 'Supporting - Internal' then
		managername.user_full_name end) caseManager,
		(case when ctt.TEAM_TYPE = 'Supporting - Vendor' then
		managername.user_full_name end) vendorManager
		FROM cms_clientcase cc,
		 cms_subject cs,
		cms_case_status_master ccsm,
		cms_user_master cum,
		cms_user_master rev1,
		cms_user_master rev2,
		cms_user_master rev3,
		cms_user_master managername,
		cms_subject sub,
		cms_country_master ccm,
		cms_team_details td,
		cms_office_master com,
		cms_team_type ctt
		WHERE
		ccsm.case_status_id = cc.case_status_id
		AND sub.crn(+) = cc.crn
		AND cs.crn = cc.crn
		AND cum.login_id(+) = td.main_analyst
		and managername.LOGIN_ID(+) = td.manager_id
		AND ctt.team_type_id = td.team_type_id
		AND rev1.login_id(+) = td.reviewer1
		AND rev2.login_id(+) = td.reviewer2
		AND rev3.login_id(+) = td.reviewer3
		AND sub.is_primary_sub = 1
		AND td.crn = cc.crn
		AND com.office_master_id(+) = td.office_id
		<isNotNull prepend="AND" property="crnNumbers">
			<isNotEmpty property="crnNumbers">
				<iterate property="crnNumbers" conjunction="OR" open="("
					close=")">
					upper(cc.CRN) LIKE '%' || trim(upper(#crnNumbers[]#)) || '%'
                </iterate>
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="office">
			<isNotEmpty property="office">
				td.office_id = #office#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="caseStatus">
			<isNotEmpty property="caseStatus">
				 upper(cc.CASE_STATUS_ID) = #caseStatus#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="startCaseRecvDate">
				<isNotEmpty property="startCaseRecvDate">
					trunc(cc.REQ_RECD_DT)  <![CDATA[ >= ]]> to_date(#startCaseRecvDate#,'dd-Mon-yyyy HH24:MI:SS')
			 </isNotEmpty>
	    </isNotNull>
	    <isNotNull prepend="AND" property="endCaseRecvDate">
				<isNotEmpty property="endCaseRecvDate">
					trunc(cc.REQ_RECD_DT)  <![CDATA[ <= ]]>  to_date(#endCaseRecvDate#,'dd-Mon-yyyy HH24:MI:SS')
			 </isNotEmpty>
	    </isNotNull>
	    <isNotNull prepend="AND" property="subjectName">
			<isNotEmpty property="subjectName">
			  <isEqual property="exactMatch" compareValue='true'>
				 upper(cs.SUBJECT_NAME) = UPPER(#subjectName#)
		      </isEqual>
			  <isEqual property="exactMatch" compareValue='false'> 
				 upper(cs.SUBJECT_NAME) like '%' || UPPER(#subjectName#) || '%'
			  </isEqual>				
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="analyst">
			<isNotEmpty property="analyst">
				 td.main_analyst = #analyst#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="biAnalyst">
			<isNotEmpty property="biAnalyst">
				 td.manager_id = #biAnalyst#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="vendorManager">
			<isNotEmpty property="vendorManager">
				 td.manager_id = #vendorManager#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="caseManager">
			<isNotEmpty property="caseManager">
				 td.manager_id = #caseManager#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="reviewer">
			<isNotEmpty property="reviewer">
				  ( td.reviewer1 = #reviewer# OR td.reviewer2 = #reviewer# OR td.reviewer3 = #reviewer# )
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="reviewer">
			<isNotEmpty property="reviewer">
				  ( td.reviewer1 = #reviewer# OR td.reviewer2 = #reviewer# OR td.reviewer3 = #reviewer# )
			</isNotEmpty>
		</isNotNull>
		ORDER BY upper($sortColumnName$) $sortType$ )a WHERE ROWNUM <![CDATA[ <= ]]>
		#maxRecord#) WHERE rn <![CDATA[ >= ]]>
		#minRecord#
	</select>


	<select id="getTeamSearchCount" parameterClass="com.worldcheck.atlas.vo.search.TeamSearchVO"
		resultClass="java.lang.Integer">
		select count(*) from
		(
		SELECT DISTINCT(cc.crn) crnno,
		sub.subject_name primarySubject,
		com.office,
		 concat(concat(ctt.TEAM_TYPE,'##'),td.team_id) teamName,
		cum.user_full_name analyst,
		rev1.user_full_name reviewer1,
		rev2.user_full_name reviewer2,
		rev3.user_full_name reviewer3,
		 to_char(td.REV_INTDUEDATE1,    'dd-MM-yy') intrimduedate1,
       to_char(td.REV_INTDUEDATE2,    'dd-MM-yy') intrimduedate2,
       to_char(td.REV_FINDUEDATE,    'dd-MM-yy') finalduedate,
		'0' islegacydata,
		(case when ctt.TEAM_TYPE = 'Supporting - BI' then
		managername.user_full_name end) bianalyst,
		(case when ctt.TEAM_TYPE = 'Primary' then managername.user_full_name
		when ctt.team_type = 'Supporting - Internal' then
		managername.user_full_name end) caseManager,
		(case when ctt.TEAM_TYPE = 'Supporting - Vendor' then
		managername.user_full_name end) vendorManager
		FROM cms_clientcase cc,
		 cms_subject cs,
		cms_case_status_master ccsm,
		cms_user_master cum,
		cms_user_master rev1,
		cms_user_master rev2,
		cms_user_master rev3,
		cms_user_master managername,
		cms_subject sub,
		cms_country_master ccm,
		cms_team_details td,
		cms_office_master com,
		cms_team_type ctt
		WHERE
		ccsm.case_status_id = cc.case_status_id
		AND sub.crn(+) = cc.crn
		AND cs.crn = cc.crn
		AND cum.login_id(+) = td.main_analyst
		and managername.LOGIN_ID(+) = td.manager_id
		AND ctt.team_type_id = td.team_type_id
		AND rev1.login_id(+) = td.reviewer1
		AND rev2.login_id(+) = td.reviewer2
		AND rev3.login_id(+) = td.reviewer3
		AND sub.is_primary_sub = 1
		AND td.crn = cc.crn
		AND com.office_master_id(+) = td.office_id
		<isNotNull prepend="AND" property="crnNumbers">
			<isNotEmpty property="crnNumbers">
				<iterate property="crnNumbers" conjunction="OR" open="("
					close=")">
					upper(cc.CRN) LIKE '%' || trim(upper(#crnNumbers[]#)) || '%'
          </iterate>
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="office">
			<isNotEmpty property="office">
				td.office_id = #office#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="caseStatus">
			<isNotEmpty property="caseStatus">
				 upper(cc.CASE_STATUS_ID) = #caseStatus#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="startCaseRecvDate">
				<isNotEmpty property="startCaseRecvDate">
					trunc(cc.REQ_RECD_DT)  <![CDATA[ >= ]]> to_date(#startCaseRecvDate#,'dd-Mon-yyyy HH24:MI:SS')
			 </isNotEmpty>
	    </isNotNull>
	    <isNotNull prepend="AND" property="endCaseRecvDate">
				<isNotEmpty property="endCaseRecvDate">
					trunc(cc.REQ_RECD_DT)  <![CDATA[ <= ]]>  to_date(#endCaseRecvDate#,'dd-Mon-yyyy HH24:MI:SS')
			 </isNotEmpty>
	    </isNotNull>
	    <isNotNull prepend="AND" property="subjectName">
			<isNotEmpty property="subjectName">
				 <isEqual property="exactMatch" compareValue='true'>
				 upper(cs.SUBJECT_NAME) = UPPER(#subjectName#)
		      </isEqual>
			  <isEqual property="exactMatch" compareValue='false'> 
				 upper(cs.SUBJECT_NAME) like '%' || UPPER(#subjectName#) || '%'
			  </isEqual> 
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="analyst">
			<isNotEmpty property="analyst">
				 td.main_analyst = #analyst#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="biAnalyst">
			<isNotEmpty property="biAnalyst">
				 td.manager_id = #biAnalyst#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="vendorManager">
			<isNotEmpty property="vendorManager">
				 td.manager_id = #vendorManager#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="caseManager">
			<isNotEmpty property="caseManager">
				 td.manager_id = #caseManager#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="reviewer">
			<isNotEmpty property="reviewer">
				  ( td.reviewer1 = #reviewer# OR td.reviewer2 = #reviewer# OR td.reviewer3 = #reviewer# )
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="reviewer">
			<isNotEmpty property="reviewer">
				  ( td.reviewer1 = #reviewer# OR td.reviewer2 = #reviewer# OR td.reviewer3 = #reviewer# )
			</isNotEmpty>
		</isNotNull>
		)
	</select>

	<select id="getTeamSearchExportToExl" resultClass="com.worldcheck.atlas.vo.search.TeamSearchVO"
		parameterClass="java.util.Map">
		SELECT DISTINCT(cc.crn) crnno,
		sub.subject_name primarySubject,
		com.office,
		 concat(concat(ctt.TEAM_TYPE,'##'),td.team_id) teamName,
		cum.user_full_name analyst,
		rev1.user_full_name reviewer1,
		rev2.user_full_name reviewer2,
		rev3.user_full_name reviewer3,
		 to_char(td.REV_INTDUEDATE1,    'dd-MM-yy') intrimduedate1,
       to_char(td.REV_INTDUEDATE2,    'dd-MM-yy') intrimduedate2,
       to_char(td.REV_FINDUEDATE,    'dd-MM-yy') finalduedate,
		'0' islegacydata,
		(case when ctt.TEAM_TYPE = 'Supporting - BI' then
		managername.user_full_name end) bianalyst,
		(case when ctt.TEAM_TYPE = 'Primary' then managername.user_full_name
		when ctt.team_type = 'Supporting - Internal' then
		managername.user_full_name end) caseManager,
		(case when ctt.TEAM_TYPE = 'Supporting - Vendor' then
		managername.user_full_name end) vendorManager
		FROM cms_clientcase cc,
		 cms_subject cs,
      	cms_case_status_master ccsm,
		cms_user_master cum,
		cms_user_master rev1,
		cms_user_master rev2,
		cms_user_master rev3,
		cms_user_master managername,
		cms_subject sub,
		cms_country_master ccm,
		cms_team_details td,
		cms_office_master com,
		cms_team_type ctt
		WHERE
		ccsm.case_status_id = cc.case_status_id
		AND sub.crn(+) = cc.crn
		  AND cs.crn = cc.crn
		AND cum.login_id(+) = td.main_analyst
		and managername.LOGIN_ID(+) = td.manager_id
		AND ctt.team_type_id = td.team_type_id
		AND rev1.login_id(+) = td.reviewer1
		AND rev2.login_id(+) = td.reviewer2
		AND rev3.login_id(+) = td.reviewer3
		AND sub.is_primary_sub = 1
		AND td.crn = cc.crn
		AND com.office_master_id(+) = td.office_id
		<isNotNull prepend="AND" property="crnNumbers">
			<isNotEmpty property="crnNumbers">
				<iterate property="crnNumbers" conjunction="OR" open="("
					close=")">
					upper(cc.CRN) LIKE '%' || trim(upper(#crnNumbers[]#)) || '%'
                </iterate>
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="office">
			<isNotEmpty property="office">
				td.office_id = #office#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="caseStatus">
			<isNotEmpty property="caseStatus">
				 upper(cc.CASE_STATUS_ID) = #caseStatus#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="startCaseRecvDate">
				<isNotEmpty property="startCaseRecvDate">
					trunc(cc.REQ_RECD_DT)  <![CDATA[ >= ]]> to_date(#startCaseRecvDate#,'dd-Mon-yyyy HH24:MI:SS')
			 </isNotEmpty>
	    </isNotNull>
	    <isNotNull prepend="AND" property="endCaseRecvDate">
				<isNotEmpty property="endCaseRecvDate">
					trunc(cc.REQ_RECD_DT)  <![CDATA[ <= ]]>  to_date(#endCaseRecvDate#,'dd-Mon-yyyy HH24:MI:SS')
			 </isNotEmpty>
	    </isNotNull>
	    <isNotNull prepend="AND" property="subjectName">
			<isNotEmpty property="subjectName">
				  <isEqual property="exactMatch" compareValue='true'>
				 upper(cs.SUBJECT_NAME) = UPPER(#subjectName#)
		      </isEqual>
			  <isEqual property="exactMatch" compareValue='false'> 
				 upper(cs.SUBJECT_NAME) like '%' || UPPER(#subjectName#) || '%'
			  </isEqual> 
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="analyst">
			<isNotEmpty property="analyst">
				 td.main_analyst = #analyst#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="biAnalyst">
			<isNotEmpty property="biAnalyst">
				 td.manager_id = #biAnalyst#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="vendorManager">
			<isNotEmpty property="vendorManager">
				 td.manager_id = #vendorManager#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="caseManager">
			<isNotEmpty property="caseManager">
				 td.manager_id = #caseManager#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="reviewer">
			<isNotEmpty property="reviewer">
				  ( td.reviewer1 = #reviewer# OR td.reviewer2 = #reviewer# OR td.reviewer3 = #reviewer# )
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="reviewer">
			<isNotEmpty property="reviewer">
				  ( td.reviewer1 = #reviewer# OR td.reviewer2 = #reviewer# OR td.reviewer3 = #reviewer# )
			</isNotEmpty>
		</isNotNull>
	</select>
</sqlMap>