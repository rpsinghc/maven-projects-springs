<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap 
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="AtlasScheduler">

	<resultMap id="schedulerResultMap" class="com.worldcheck.atlas.scheduler.vo.SchedulerVo">

		<result property="recClientCaseId" column="RECUR_CLIENTCASE_ID"/>
		<result property="CRN" column="CRN"/>
		<result property="clientCode" column="CLIENT_CODE"/>
		<result property="reportType" column="report_type"/>
		<result property="interimClientDueDays1" column="INT_CLIENT_DUEDAYS1"/>
		<result property="interimClientDueDays2" column="INT_CLIENT_DUEDAYS2"/>
		<result property="finalDueDays" column="FINAL_DUE_DAYS"/>
		<result property="officeName" column="OFFICE"/>
	</resultMap>

	<select id="getAvailableCasesForCreation" resultMap="schedulerResultMap" parameterClass="java.util.HashMap">	        
		SELECT RECUR_CLIENTCASE_ID,CRN,CLIENT_CODE,rtm.report_type
		,INT_CLIENT_DUEDAYS1,INT_CLIENT_DUEDAYS2,FINAL_DUE_DAYS,OFFICE
		  FROM  CMS_RECURR_CLIENTCASE rcc
		  left join CMS_REPORT_TYPE_MASTER rtm on rcc.REPORT_TYPE_ID = rtm.REPORT_TYPE_MASTER_ID 
		  left join cms_office_master com on  com.OFFICE_MASTER_ID=rcc.OFFICE_ID
		  WHERE to_date(RECURR_ENDDATE,'DD-MON-YY') >= to_date(SYSDATE,'DD-MON-YY')
		  AND 
		  to_date(NEXT_RUN_DATE,'DD-MON-YY')= to_date(sysdate,'DD-MON-YY')
	</select> 
	 
	 <update id="updateSchedulerLastNextRunDate" parameterClass="java.util.List">
			 UPDATE CMS_RECURR_CLIENTCASE
			 SET NEXT_RUN_DATE = (
			  SYSDATE + (
				trunc(to_date(NEXT_RUN_DATE,'dd-mm-yyyy hh24:mi'))-trunc(to_date(LAST_RUN_DATE,'dd-mm-yyyy hh24:mi'))
				))
			  ,LAST_RUN_DATE= SYSDATE
			 WHERE CRN in
			 <iterate  open="(" close=")" conjunction=",">
				#crnList[]#
			</iterate>	
	</update>

<insert id="insertRecCaseNotification" parameterClass="com.worldcheck.atlas.scheduler.vo.SchedulerVo">
	
	INSERT INTO CMS_REC_CASE_SCHEDULER(
		REC_CASE_SCH_ID,
		REC_CLIENT_CASE_ID,
		DESCRIPTION,
		CLIENT_INT_DUE_DATE1,
		CLIENT_INT_DUE_DATE2,
		FINAL_DUE_DATE,
		RSRCH_INT1_DATE,
		RSRCH_INT2_DATE,
		RSRCH_FINAL_DATE,
		REQ_RECVD_DATE,
		UPDATED_BY,
		UPDATED_ON
	)
	VALUES(CMS_REC_CASE_SCHEDULER_SEQ.NEXTVAL,
	  #recClientCaseId#,
	  #description# || decode (
             (
                select count(*) from cms_subject where crn=#CRN#
             )
             , 0,
	   '',
             (' and for Subjects ' || (
                                    cast((select tab_to_clob(CAST(COLLECT(subject_name)
                                    AS t_varchar2_tab))
                                     from cms_subject 
                                     where crn=#CRN#
                                     )AS VARCHAR2(64 BYTE)) 
                                  )
              )
	   )
	   || ' .Request Recieved date is ' || sysdate|| '.',
	  #clientInterm1Date#,#clientInterm2Date#,#clientFinalDate#,#rschInterm1Date#,#rschInterm2Date#,
	  #rschFinalDate#,TO_DATE(#requestRecvdDate#,'dd-Mon-yyyy HH24:mi:ss'),
	  'SYSTEM',
	  sysdate
	)
</insert>

 <update id="updateLastRecurNumber" parameterClass="java.util.HashMap">
	update CMS_RECURR_CLIENTCASE
	set LAST_RECURR_NUM=LAST_RECURR_NUM+1
	where RECUR_CLIENTCASE_ID=#recClientCaseId#
</update>
 <update id="updateNewCrnInScheduler" parameterClass="java.util.HashMap">
	 update CMS_REC_CASE_SCHEDULER
	 set crn= #CRN#,ACKNOWLEDGE_DATE=sysdate
	 where rec_case_sch_id =#recCaseSchedulerId#
</update>
 <update id="updateAcknowledgeDate" parameterClass="java.util.HashMap">
	 update CMS_REC_CASE_SCHEDULER
	 set  ACKNOWLEDGE_DATE=sysdate,UPDATED_BY = #updatedBy#,UPDATED_ON=sysdate
	 where rec_case_sch_id =#recCaseSchedulerId#
</update>
<resultMap id="subjectDetMap" class="com.worldcheck.atlas.vo.SubjectDetails">
			<result property="crn" column="CRN"/>
			<result property="subjectId" column="SUBJECT_ID"/>
			<result property="subjectName" column="SUBJECT_NAME"/>
			<result property="primarySub" column="IS_PRIMARY_SUB"/>
			<result property="entityTypeId" column="ENTITY_TYPE_ID"/>
			<result property="position" column="POSITION"/>
			<result property="countryId" column="COUNTRY_ID"/>
			<result property="countryName" column="COUNTRY"/>
			<result property="address" column="ADDRESS"/>
			<result property="otherDetails" column="OTHER_DETAILS"/>
			<result property="reIds" column="RE_IDS"/>			
			<result property="reportSubjectName" column="REPORT_SUBJECT_NAME"/>			
	</resultMap>
	<select id="getSubjectForCrn" resultMap="subjectDetMap" parameterClass="java.util.HashMap">	        
		SELECT CRN,SUBJECT_ID,SUBJECT_NAME,
		IS_PRIMARY_SUB,ENTITY_TYPE_ID,ccm.COUNTRY,
		POSITION,COUNTRY_ID,ADDRESS,
		OTHER_DETAILS,RE_IDS,REPORT_SUBJECT_NAME
		from cms_subject cs,
        CMS_COUNTRY_MASTER ccm
		where ccm.COUNTRY_MASTER_ID = cs.COUNTRY_ID
		and  crn=#recurCaseCrn#
	</select> 

<resultMap id="caseDetailsMap" class="com.worldcheck.atlas.vo.CaseDetails">
			<result property="crn" column="CRN"/>
			<result property="clientCode" column="CLIENT_NAME"/>
			<result property="clientRef" column="CLIENT_REF"/>
			<result property="caseInfo" column="CASE_INFO"/>
			<result property="caseMgrId" column="CASE_MGR_ID"/>
			<result property="reportTypeId" column="REPORT_TYPE"/>
			<result property="subReportTypeId" column="SUB_REPORT"/>
			<result property="officeId" column="OFFICE"/>
			<result property="expressCase" column="IS_EXPRESS"/>
			<result property="caseStatus" column="CASE_STATUS_ID"/>			
			
	</resultMap>
  <select id="getCaseDetails" resultMap="caseDetailsMap" parameterClass="java.lang.String">	        
		SELECT cc.CRN,CLIENT_NAME,
		cc.CLIENT_REF,cc.CASE_INFO
		,cc.CASE_MGR_ID
		,rtm.REPORT_TYPE,SUB_REPORT,OFFICE,
		cc.IS_EXPRESS,cc.CASE_STATUS_ID
		FROM CMS_CLIENTCASE cc
		left join cms_recurr_clientcase rcc on cc.CRN=rcc.crn                    
		left join cms_client_master  ccm on ccm.CLIENT_CODE=rcc.CLIENT_CODE
		left join CMS_REPORT_TYPE_MASTER  rtm on rtm.REPORT_TYPE_MASTER_ID=cc.REPORT_TYPE_ID
		 left join CMS_SUBREPORT_TYPE_MASTER  stm on stm.SUBREPORT_TYPE_MASTER_ID=cc.SUB_REPORT_TYPE_ID
		left join CMS_office_MASTER  com on com.OFFICE_MASTER_ID=cc.OFFICE_ID
		WHERE RECUR_CLIENTCASE_ID=#recClientCaseId#
	</select>

  <insert id="insertSubject" parameterClass="com.worldcheck.atlas.vo.SubjectDetails">
			<selectKey resultClass="int" type="pre" keyProperty="subjectId">
				SELECT CMS_SUBJECT_SEQ.NEXTVAL AS VALUE FROM DUAL
		   </selectKey>
			INSERT INTO CMS_SUBJECT (
			CRN,
			SUBJECT_ID,
			SUBJECT_NAME,
			IS_PRIMARY_SUB,
			ENTITY_TYPE_ID,
			POSITION,
			COUNTRY_ID,
			ADDRESS,
			OTHER_DETAILS,
			RE_IDS,
			REPORT_SUBJECT_NAME,
			UPDATED_BY,
			UPDATED_ON
			)values (
			#crn#,
			#subjectId#,
			#subjectName#,
			#primarySub#,
			#entityTypeId#,
			#position#,
			#countryId#,
			#address#,
			#otherDetails#,
			#reIds#,
			#subjectName#,
			'Scheduler',
			SYSDATE
		)
		</insert>

<resultMap id="schedulerRunResultMap" class="com.worldcheck.atlas.scheduler.vo.SchedulerVo">
		<result property="CRN" column="CRN"/>
		<result property="lastRecurrenceNumber" column="LAST_RECURR_NUM"/>
		<result property="requestRecvdDate" column="REQ_RECVD_DATE"/>
		<result property="clientInterm1Date" column="CLIENT_INT_DUE_DATE1"/>
		<result property="clientInterm2Date" column="CLIENT_INT_DUE_DATE2"/>
		<result property="clientFinalDate" column="FINAL_DUE_DATE"/>
		<result property="rschInterm2Date" column="RSRCH_INT2_DATE"/>
		<result property="rschInterm1Date" column="RSRCH_INT1_DATE"/>
		<result property="rschFinalDate" column="RSRCH_FINAL_DATE"/>

	</resultMap>
 <select id="getLastRecurNumber" resultMap="schedulerRunResultMap" parameterClass="java.lang.String">	        
	select rcc.CRN,LAST_RECURR_NUM,
	TO_CHAR(rcs.REQ_RECVD_DATE,'dd-Mon-yyyy HH24:MI:SS') REQ_RECVD_DATE,
	TO_CHAR(rcs.CLIENT_INT_DUE_DATE1,'dd-Mon-yyyy HH24:MI:SS')CLIENT_INT_DUE_DATE1,
	TO_CHAR(rcs.CLIENT_INT_DUE_DATE2,'dd-Mon-yyyy HH24:MI:SS')CLIENT_INT_DUE_DATE2,
	TO_CHAR(rcs.FINAL_DUE_DATE,'dd-Mon-yyyy HH24:MI:SS')FINAL_DUE_DATE,
	TO_CHAR(rcs.RSRCH_INT2_DATE,'dd-Mon-yyyy HH24:MI:SS')RSRCH_INT2_DATE,
	TO_CHAR(rcs.RSRCH_INT1_DATE,'dd-Mon-yyyy HH24:MI:SS')RSRCH_INT1_DATE,
	TO_CHAR(rcs.RSRCH_FINAL_DATE,'dd-Mon-yyyy HH24:MI:SS')RSRCH_FINAL_DATE
	from CMS_RECURR_CLIENTCASE rcc
	left join CMS_REC_CASE_SCHEDULER rcs on rcs.REC_CLIENT_CASE_ID=rcc.RECUR_CLIENTCASE_ID
	WHERE rcs.REC_CASE_SCH_ID =#recCaseSchedulerId#
	</select> 

	<select id="getTurnAround" parameterClass="java.lang.String" resultClass="java.lang.Integer">
		select turn_around_time from cms_report_type_master where
		report_type=#reportType#
	</select>
	<select id="isHoliday" parameterClass="java.util.Map"
		resultClass="java.lang.Integer">
		select count(*) from cms_holiday_master where
		dated_on=to_date(#holidayDate#) and office_id=(select office_master_id
		from cms_office_master where office=#officeName#)
	</select>
	
	<update id="updatePidForCrn" parameterClass="java.util.Map">
	  update cms_clientcase set pid=#pid# 
	 where crn=#crn#
	</update>

	 <insert id="insertAscSubject" parameterClass="java.util.HashMap">
		INSERT INTO CMS_ASC_SUBJECT (ASC_SUBJECT_ID,CRN,SUBJECT_ID,UPDATED_BY,UPDATED_ON,IS_LEGACY)
		(select CMS_ASSOSUBJECT_SEQ.NEXTVAL, CRN ,#newSubjectId#  SUBJECT_ID,'SYSTEM'  UPDATED_BY, sysdate UPDATED_ON, IS_LEGACY
            from CMS_ASC_SUBJECT
            where subject_id=#baseSubjectId#
         )
		</insert>

<resultMap id="getAttachmentsForCaseMap" class="com.worldcheck.atlas.vo.document.DocMapVO">
		<result property="docId" column="DOCID"/>
		<result property="names" column="DOCNAME"/>
		<result property="uploadedByJuno" column="UPLOADEDBYJUNO"/>
		<result property="version" column="VERSION"/>
		<result property="teamName" column="TEAMNAME"/>
		<result property="pid" column="PID"/>

	</resultMap>
 <select id="getAttachmentsForCase" resultMap="getAttachmentsForCaseMap" parameterClass="java.util.Map">	        
	     select DOCID,
        DOCNAME,
        UPLOADEDBYJUNO,
        VERSION,
        TEAMNAME,
        docs.PID 
        from CMS_DOCUMENT docs,
        CMS_CLIENTCASE cc  
        where cc.pid = docs.PID and marked =0  and cc.crn=#crn#
	</select> 
	<delete id="deleteCrn" parameterClass="java.util.Map">
		DELETE FROM CMS_ClientCase WHERE crn =#CRN#
	</delete> 

	<resultMap id="overDueNotificationResultMap" class="com.worldcheck.atlas.scheduler.vo.OverdueCasesSchedulerVo">
		<result property="crn" column="CRN"/>
		<result property="overdueMsg" column="overduemsg"/>
		<result property="caseManagerFullName" column="CASE_MANAGER"/>
		<result property="caseManagerLoginID" column="MANAGER_LOGIN_ID"/>
		<result property="teamType" column="TEAM_TYPE"/>
		<result property="eligibleUsersForNotification" column="sent_to"/>

	</resultMap>
 <select id="getUsersForOverdueNotification" resultMap="overDueNotificationResultMap">	        
		SELECT distinct CAST (cc.CRN  AS VARCHAR2(128 CHAR)) AS CRN,
		CAST(manager.user_full_name AS VARCHAR2(64 BYTE)) AS CASE_MANAGER ,
		CAST(manager_id AS VARCHAR2(64 BYTE)) AS MANAGER_LOGIN_ID ,

		CAST(TEAM_TYPE_ID AS NUMBER(2,0) ) AS TEAM_TYPE,
		(
		  case when (team_type_id =1 or team_type_id =2 ) then 'This case is OVERDUE by ' || com.OFFICE || '.'
			   when (team_type_id =3) then 'This case is OVERDUE by BI Team. Please check it out.'
			   when (team_type_id =4) then 'This case is OVERDUE by '|| ctd.MANAGER_ID || '.'
		  else '' end ) as overduemsg   ,
		  
		cast( ( case when (team_type_id =1) then 
				   cast((select ANALYSTS || ',' || REVIEWER1 || ',' || REVIEWER2  || ',' || REVIEWER3 || ',' || MANAGER_ID || ',' || RESEARCH_HEAD 
				  || ',' || ccsub.CASE_MGR_ID
					from cms_team_details ctdsub,cms_clientcase ccsub
					where ctdsub.team_id =CTD.team_id
					and ccsub.crn = ctdsub.crn
				  )AS VARCHAR2(64 BYTE))
			  when (team_type_id =2) then 
				   cast((select ANALYSTS || ',' || REVIEWER1 || ',' || REVIEWER2  || ',' || REVIEWER3 || ',' || MANAGER_ID || ',' || RESEARCH_HEAD
				  from cms_team_details where team_id =CTD.team_id 
				  )AS VARCHAR2(64 BYTE))
			 when (team_type_id =3 ) then 
				 cast((select tab_to_clob(CAST(COLLECT(ANALYSTS || ',' || REVIEWER1 || ',' || REVIEWER2  || ',' || REVIEWER3 || ',' || MANAGER_ID || ',' || RESEARCH_HEAD)
				 AS t_varchar2_tab))
				 from cms_team_details 
				 where team_id in(select team_id as pt_teamid from cms_team_details where crn= Ctd.CRN and team_type_id in( 1,3))  
				 )AS VARCHAR2(64 BYTE))
			 when (team_type_id =4) then 
			 cast((select tab_to_clob(CAST(COLLECT(ANALYSTS || ',' || REVIEWER1 || ',' || REVIEWER2  || ',' || REVIEWER3 || ',' || MANAGER_ID || ',' || RESEARCH_HEAD)
			AS t_varchar2_tab))
			 from cms_team_details 
			 where team_id in(select team_id as pt_teamid from cms_team_details where crn= Ctd.CRN and team_type_id in( 1,4))  
			 )AS VARCHAR2(64 BYTE))  
                        
		  else '' end ) AS VARCHAR2(64 BYTE)) AS sent_to

		FROM CMS_USER_MASTER CUM,CMS_TEAM_DETAILS CTD,
		CMS_OFFICE_MASTER COM,CMS_CLIENTCASE CC,
		cms_user_master manager
		WHERE CTD.CRN= CC.CRN
		AND CC.case_status_id IN(2,3)
		AND CTD.OFFICE_ID=COM.OFFICE_MASTER_ID
		and manager_id=manager.LOGIN_ID
		and (CASE WHEN trunc(REV_INTDUEDATE1)<![CDATA[ < ]]> TRUNC(SYSDATE) AND INT1RESEARCHCOMPDT is null then 1
		WHEN trunc(REV_INTDUEDATE2)<![CDATA[ < ]]> TRUNC(SYSDATE) AND  INT2RESEARCHCOMPDT is null then 1
		WHEN trunc(REV_FINDUEDATE)<![CDATA[ < ]]> TRUNC(SYSDATE) AND FINALRESEARCHCOMPDT is null then  1 else 0 END) = 1

</select> 
 <update id="updateDocVersion" parameterClass="com.worldcheck.atlas.vo.document.DocMapVO">
	update cms_document
	set version =#version#
	where docid=#docId#

	</update>
	
	<select id="getEmailPrepaymentCaseResult" resultClass="com.worldcheck.atlas.scheduler.vo.EmailPrepaymentCaseVo">
		
		select cc.crn crn,
		cc.FINAL_DUE_DATE caseDueDate,
		(select ua.attr_value from SAVVIONDB.userattr ua 
		where ua.attr_name='email'and ua.user_id = (select uu.user_id from SAVVIONDB.umuser uu where uu.user_name=cc.case_mgr_id)) as emailCM,
		(select ua.attr_value from SAVVIONDB.userattr ua 
		where ua.attr_name='email'and ua.user_id = (select uu.user_id from SAVVIONDB.umuser uu where uu.user_name=cc.sales_representative)) as emailBDM,
		(dwcc.CASEFEE_USD + dwcc.CREDIT_USD +dwcc.MULTIPLE_YEAR_BONUS_USD - NVL((calculate.total_spent_USD),0)) totalBalanceUSD
		from cms_clientcase cc,
		(SELECT calchild.crn ,
		SUM(dccchild.case_fee) AS total_spent,
		SUM(dccchild.casefee_usd) total_spent_USD
		FROM cms_accounts_linkcases calchild,
		dw_currency_conversion dccchild
		WHERE calchild.linked_crn= dccchild.crn
		GROUP BY calchild.crn
		) calculate,
		dw_currency_conversion dwcc
		where
		cc.report_type_id=(select REPORT_TYPE_MASTER_ID from cms_report_type_master where Report_Code='ISRPT4' and status=1)
		AND cc.sub_report_type_id=(select SUBREPORT_TYPE_MASTER_ID from cms_subreport_type_master where sub_crn_initial='SSP' and status=1 )
		AND dwcc.crn = cc.crn
		AND calculate.crn(+)= cc.crn
		AND ((TO_DATE(TO_CHAR(cc.FINAL_DUE_DATE,'DD-MON-YY'),'DD-MON-YY') =  TO_DATE(TO_CHAR(sysdate+90,'DD-MON-YY'),'DD-MON-YY')) OR 
		(TO_DATE(TO_CHAR(cc.FINAL_DUE_DATE,'DD-MON-YY'),'DD-MON-YY') =  TO_DATE(TO_CHAR(sysdate-30,'DD-MON-YY'),'DD-MON-YY')))

	</select>
	  <!--Added by Himanshu for BI40, get folder locations from temporary tables -->
	<select id="getTempFeedbackAttach" resultClass="java.lang.String">
		select distinct(attachement_path) from cms_temporary_attachment
		where TO_DATE(attached_on,'DD-MM-YY') = TO_DATE(sysdate-1,'DD-MM-YY')
	</select>
	
	 <!--Added by Himanshu for BI40, delete enteries from temporary tables -->
	<delete id="removeTempFeedbackAttach" parameterClass="com.worldcheck.atlas.scheduler.vo.SchedulerVo">
		 delete from cms_temporary_attachment where attachement_path in
		  <iterate property="listOfEnteries" open="(" close=")" conjunction=",">
				#listOfEnteries[]#
			</iterate>
		and TO_DATE(attached_on,'DD-MM-YY') = TO_DATE(sysdate-1,'DD-MM-YY')
	</delete> 
</sqlMap>
