<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ClientMaster">

	<resultMap id="resultClientMasterVO"
		class="com.worldcheck.atlas.vo.masters.ClientMasterVO">
		<result property="clientCode" column="clientCode" />
		<result property="clientName" column="clientName" />
		<result property="country" column="country" />
		<result property="associatedCM" column="associatedCM" />
		<result property="associatedBDM" column="associatedBDM"/>
		<result property="clientSince" column="clientSince" />
		<result property="countryMasterId" column="countryMasterId" />
		<result property="clientMasterId" column="CLIENT_MASTER_ID" />
		<!--<result property="clientGroupId" column="CLIENT_GROUP_ID" /> -->
		<result property="groupName" column="CLIENT_GROUP_MASTER_NAME" />	
	</resultMap>
	<resultMap id="contactVO"
		class="com.worldcheck.atlas.vo.masters.ClientContactVO">
		<result property="clientCode" column="CLIENT_CODE" />
		<result property="name" column="CONTACT_NAME" />
		<result property="fax" column="FAX" />
		<result property="phone" column="PHONE" />
		<result property="remark" column="REMARKS" />
		<result property="email" column="EMAIL" />


	</resultMap>
	<resultMap id="countryVO"
		class="com.worldcheck.atlas.vo.masters.CountryMasterVO">
		<result property="countryCode" column="COUNTRY_CODE" />
		<result property="country" column="COUNTRY" />
	</resultMap>

	<!--
		=====================================< Show dropdown
		Info>==================
	-->
	<!-- Start BI 293 Added by 6035037  Extra condition added-->
	<select id="selectClientInfo" resultClass="com.worldcheck.atlas.vo.masters.ClientMasterVO" parameterClass="com.worldcheck.atlas.vo.masters.ClientMasterVO">

		Select distinct
		CCM.CLIENT_MASTER_ID "clientMasterId" ,
		CCM.CLIENT_CODE "clientCode",
		CCM.CLIENT_CODE||'-'||CCM.CLIENT_NAME "codeName",
		CCM.ASSOCIATED_CM "associatedCM",
		CCM.ASSOCIATED_BDM "associatedBDM"
		FROM
		CMS_CLIENT_MASTER CCM 
		WHERE STATUS = #clientStatus#
		<isNotNull prepend="AND" property="isSubreportRequired">
			<isNotEmpty property="isSubreportRequired">
			CCM.IS_SUBJ_LEVEL_SUBRPT_REQ ='1'
			</isNotEmpty>
		</isNotNull>
	
		ORDER BY CLIENT_CODE asc
										
								    
	 </select>


	<!--
		===================================== </Show dropdown
		Info>==================
	-->



	<!--
		===================================== <Show Search
		Info>==================
	-->
	<select id="searchClient" parameterClass="com.worldcheck.atlas.vo.masters.ClientMasterVO"
		resultMap="resultClientMasterVO">

		SELECT * FROM (SELECT a.*, ROWNUM rn FROM ( SELECT
		CCM.CLIENT_CODE clientCode,
		CCM.CLIENT_MASTER_ID,
		CCM.CLIENT_NAME clientName,
		CNM.COUNTRY country	,	
		CCM.ASSOCIATED_BDM 	associatedBDM,
		CCM.COUNTRY_MASTER_ID countryMasterId,
		CCM.CLIENT_SINCE clientSince,
		CG.CLIENT_GROUP_MASTER_NAME AS CLIENT_GROUP_MASTER_NAME
       , cum.USER_FULL_NAME associatedCM
		FROM
		CMS_CLIENT_MASTER CCM,
		CMS_COUNTRY_MASTER CNM,
                CMS_OFFICE_MASTER com,
                CMS_USER_MASTER cum,
				CMS_CLIENT_GROUP_MASTER CG
		WHERE
		CCM.COUNTRY_MASTER_ID = CNM.COUNTRY_MASTER_ID
		 AND cum.LOGIN_ID(+) = CCM.ASSOCIATED_CM
                 and com.OFFICE_MASTER_ID(+)  = ccm.BRANCH_OFFICE_ID
		AND CCM.CLIENT_GROUP_ID =CG.CLIENT_GROUP_MASTER_ID
		AND CCM.STATUS =
		#clientStatus#
		<isNotNull prepend="AND" property="country">
			<isNotEmpty property="country">
				CNM.COUNTRY=#country#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="clientCode">
			<isNotEmpty property="clientCode">
				CCM.CLIENT_CODE = #clientCode#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="clientName">
			<isNotEmpty property="clientName">
				upper(CCM.CLIENT_NAME) LIKE '%' || upper(#clientName#) || '%'
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="associatedCM">
			<isNotEmpty property="associatedCM">
				CCM.ASSOCIATED_CM = #associatedCM#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="associatedBDM">
			<isNotEmpty property="associatedBDM">
				CCM.ASSOCIATED_BDM = #associatedBDM#
			</isNotEmpty>
		</isNotNull>
		
		<isNotNull prepend="AND" property="clientGroupId">
			<isNotEmpty property="clientGroupId">
				CCM.CLIENT_GROUP_ID = #clientGroupId#
			</isNotEmpty>
		</isNotNull>
		
		<isNotNull prepend="AND" property="alphabet">
			<isNotEmpty property="alphabet">
				UPPER(CCM.CLIENT_NAME) LIKE
				UPPER(TRIM(#alphabet#))||'%'
			</isNotEmpty>
		</isNotNull>
		ORDER BY upper($sortColumnName$) $sortType$ ) a WHERE ROWNUM <![CDATA[ <= ]]>
		#maxRecord#) WHERE rn <![CDATA[ >= ]]>
		#minRecord#
	</select>


	<select id="searchClientCount" parameterClass="com.worldcheck.atlas.vo.masters.ClientMasterVO"
		resultClass="java.lang.Integer">
		SELECT count(*)
		FROM
		CMS_CLIENT_MASTER CCM,
		CMS_COUNTRY_MASTER CNM,
                CMS_OFFICE_MASTER com,
		CMS_USER_MASTER cum,
		CMS_CLIENT_GROUP_MASTER CG		
		WHERE
		CCM.COUNTRY_MASTER_ID = CNM.COUNTRY_MASTER_ID
		 AND cum.LOGIN_ID(+) = CCM.ASSOCIATED_CM
         and com.OFFICE_MASTER_ID(+)  = ccm.BRANCH_OFFICE_ID
		  AND  CCM.CLIENT_GROUP_ID =CG.CLIENT_GROUP_MASTER_ID
		 AND CCM.STATUS = #clientStatus#
		<isNotNull prepend="AND" property="country">
			<isNotEmpty property="country">
				CNM.COUNTRY=#country#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="clientCode">
			<isNotEmpty property="clientCode">
				CCM.CLIENT_CODE = #clientCode#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="clientName">
			<isNotEmpty property="clientName">
				upper(CCM.CLIENT_NAME) LIKE '%' || upper(#clientName#) || '%'
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="associatedCM">
			<isNotEmpty property="associatedCM">
				CCM.ASSOCIATED_CM = #associatedCM#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="associatedBDM">
			<isNotEmpty property="associatedBDM">
				CCM.ASSOCIATED_BDM = #associatedBDM#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="alphabet">
			<isNotEmpty property="alphabet">
				UPPER(CCM.CLIENT_NAME) LIKE
				UPPER(TRIM(#alphabet#))||'%'
			</isNotEmpty>
		</isNotNull>
		
		<isNotNull prepend="AND" property="clientGroupId">
			<isNotEmpty property="clientGroupId">
				CCM.CLIENT_GROUP_ID = #clientGroupId#
			</isNotEmpty>
		</isNotNull>
	</select>


	<select id="searchClientExport" parameterClass="java.util.Map"
		resultClass="com.worldcheck.atlas.vo.masters.ClientMasterVO">

		SELECT
			CCM.CLIENT_MASTER_ID clientMasterId,
		CG.CLIENT_GROUP_MASTER_NAME AS groupName,
		CCM.CLIENT_CODE clientCode ,
		CCM.CLIENT_NAME clientName ,
		TO_CHAR(CCM.CLIENT_SINCE,'DD-Mon-YYYY') clientSince,
		CCM.INVOICE_TO invoiceTo,
		CCM.INVOICE_ADDRESS invoiceAddress,
		CNM.COUNTRY country,
		CCM.LOCATION location,
		CCM.PHONE phone,
		CCM.FAX fax,
		CCM.EMAIL emailaddress,
		cum1.USER_FULL_NAME associatedCM,
		cum2.USER_FULL_NAME associatedBDM,
                com.OFFICE branch,
		CCM.INVOICE_INSTRUCTION invoiceInstruction,
		DECODE(CCM.STATUS,1,'Active','Deactive') clientStatus,
			REPLACE(c1.B , ',', ';')             AS clientContact,          
			REPLACE(c1.C , ',', ';')             AS  clientPhone  ,
			REPLACE(c1.D , ',', ';')             AS  clientFax    ,
			REPLACE(c1.E , ',', ';')             AS clientEmail  ,
			REPLACE(c1.F , ',', ';')            AS clientRemark ,				
   		to_char(MAX(CS.case_creation_date) , 'dd-MON-yyyy') caseOrdaerDate, 
		ccm.IS_SUBJ_LEVEL_SUBRPT_REQ as isSubreportRequired
		
		FROM 
		  (select client_code A ,
  		dbms_lob.substr(wm_concat(contact_name)) B,
                dbms_lob.substr(wm_concat(phone)) C       ,
                dbms_lob.substr(wm_concat(fax)) D         ,
                dbms_lob.substr(wm_concat(email)) E       ,
                dbms_lob.substr(wm_concat(remarks)) F
              from CMS_CLIENT_CONTACT  group by client_code) c1 ,
				CMS_CLIENT_MASTER CCM,CMS_COUNTRY_MASTER CNM, CMS_CLIENT_GROUP_MASTER CG,
                CMS_OFFICE_MASTER com,
        CMS_USER_MASTER cum1,
                CMS_USER_MASTER cum2,
                  CMS_CLIENTCASE CS
                
		WHERE CCM.COUNTRY_MASTER_ID = CNM.COUNTRY_MASTER_ID
                and com.OFFICE_MASTER_ID(+)  = ccm.BRANCH_OFFICE_ID
                 AND cum1.LOGIN_ID(+) = CCM.ASSOCIATED_CM
                  AND cum2.LOGIN_ID(+) = CCM.ASSOCIATED_BDM
				   AND CCM.CLIENT_GROUP_ID =CG.CLIENT_GROUP_MASTER_ID(+)
		AND CCM.STATUS = #clientStatus#
					 AND CS.CLIENT_CODE(+)=CCM.CLIENT_CODE
					  AND c1.A(+)=CCM.CLIENT_CODE						  
		<isNotNull prepend="AND" property="country">
			<isNotEmpty property="country">
				CNM.COUNTRY=#country#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="clientCode">
			<isNotEmpty property="clientCode">
				CCM.CLIENT_CODE = #clientCode#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="clientName">
			<isNotEmpty property="clientName">
				upper(CCM.CLIENT_NAME) LIKE '%' || upper(#clientName#) || '%'
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="associatedCM">
			<isNotEmpty property="associatedCM">
				CCM.ASSOCIATED_CM = #associatedCM#
			</isNotEmpty>
		</isNotNull>
		<isNotNull prepend="AND" property="associatedBDM">
			<isNotEmpty property="associatedBDM">
				CCM.ASSOCIATED_BDM = #associatedBDM#
			</isNotEmpty>
		</isNotNull>
		
		<isNotNull prepend="AND" property="clientGroupId">
			<isNotEmpty property="clientGroupId">
				CCM.CLIENT_GROUP_ID = #clientGroupId#
			</isNotEmpty>
		</isNotNull>
		
		<isNotNull prepend="AND" property="alphabet">
			<isNotEmpty property="alphabet">
				UPPER(CCM.CLIENT_NAME) LIKE
				UPPER(TRIM(#alphabet#))||'%'
			</isNotEmpty>
		</isNotNull>
		group by CCM.CLIENT_MASTER_ID, CG.CLIENT_GROUP_MASTER_NAME, CCM.CLIENT_CODE, CCM.CLIENT_NAME,
				CCM.CLIENT_SINCE,
				CCM.INVOICE_TO
				,CCM.INVOICE_ADDRESS
				,CNM.COUNTRY,
				CCM.LOCATION ,
				CCM.PHONE,
				CCM.FAX,
				CCM.EMAIL,
				cum1.USER_FULL_NAME,
				cum2.USER_FULL_NAME,
				com.OFFICE ,
				CCM.INVOICE_INSTRUCTION,
				CCM.STATUS,
				c1.B,
				c1.C,
				c1.D,
				c1.E,
				c1.F,	
		        ccm.IS_SUBJ_LEVEL_SUBRPT_REQ 
		ORDER BY CCM.CLIENT_CODE
	</select>



	<!--
		===================================== </Show Search
		Info>==================
	-->

	<!--
		==========================================<Insertion in
		Client_Master==============
	-->

	<insert id="addNewClient" parameterClass="com.worldcheck.atlas.vo.masters.ClientMasterVO">
	<selectKey resultClass="java.lang.String" type="pre" keyProperty="clientMasterId">
			SELECT CMS_CLIENT_MASTER_SEQ.NEXTVAL AS VALUE FROM DUAL
  	</selectKey>
		insert into
		CMS_CLIENT_MASTER
		(
		CLIENT_MASTER_ID, CLIENT_CODE, CLIENT_NAME,
		ADDRESS,
		INVOICE_TO, INVOICE_ADDRESS,
		COUNTRY_MASTER_ID, PHONE, FAX,
		EMAIL,
		LOCATION, ASSOCIATED_CM,
		ASSOCIATED_BDM, BRANCH_OFFICE_ID, STATUS,
		CLIENT_SINCE, INVOICE_INSTRUCTION,IS_SUBJ_LEVEL_SUBRPT_REQ,
		UPDATED_BY, UPDATED_ON,CLIENT_GROUP_ID
		)

		values
		(
		#clientMasterId#,#clientCode#,#clientName#,
		#address#,#invoiceTo#,
		#invoiceAddress#,(select COUNTRY_MASTER_ID from
		CMS_COUNTRY_MASTER where
		CODE=#countryMasterId#),
		#phone#,#fax#,#emailaddress#,
		#location#,#associatedCM#,
		#associatedBDM#,#branchOfficeId#,
		#clientStatus#,#clientSince#,
		#invoiceInstruction#,#isSubreportRequired#,
		#updatedBy#,sysdate
		<isNotEmpty property="clientGroupId">
		,#clientGroupId#
		</isNotEmpty>
	   <isEmpty property="clientGroupId">
		,0
		</isEmpty>
		)								    						
</insert>

	<!--
		==========================================<\Insertion in
		Client_Master==============
	-->


	<select id="getClientInfo" resultClass="com.worldcheck.atlas.vo.masters.ClientMasterVO"
		parameterClass="java.lang.Integer">

		Select distinct
		cm.CLIENT_MASTER_ID clientMasterId,
		cm.CLIENT_CODE clientCode, cm.CLIENT_NAME clientName,
		cm.INVOICE_TO
		invoiceTo, cm.INVOICE_ADDRESS invoiceAddress,
		ccm.CODE countryMasterId,
		cm.PHONE phone, cm.FAX fax,
		cm.EMAIL emailaddress, cm.LOCATION
		location, cm.ASSOCIATED_CM associatedCM,
		cm.ASSOCIATED_BDM
		associatedBDM, cm.BRANCH_OFFICE_ID branchOfficeId,
		cm.STATUS
		clientStatus,
		TO_CHAR(cm.CLIENT_SINCE,'DD Mon YYYY') clientSince, cm.INVOICE_INSTRUCTION
		invoiceInstruction,
		cm.IS_SUBJ_LEVEL_SUBRPT_REQ isSubreportRequired,
	   cm.client_group_id clientGroupId
		FROM
		CMS_CLIENT_MASTER cm,CMS_COUNTRY_MASTER ccm
		where ccm.country_master_id
		=cm.country_master_id
		AND
		cm.CLIENT_MASTER_ID=#idVal#
											
										
								    
	 </select>


	<update id="updateClient" parameterClass="com.worldcheck.atlas.vo.masters.ClientMasterVO">

		update
		CMS_CLIENT_MASTER set
		INVOICE_TO =#invoiceTo#,
		INVOICE_ADDRESS=#invoiceAddress#,
		COUNTRY_MASTER_ID =( select COUNTRY_MASTER_ID from CMS_COUNTRY_MASTER where CODE=#countryMasterId#), 
		PHONE =#phone#, 
		FAX=#fax#,
		EMAIL=#emailaddress#, 
		LOCATION=#location#,
		ASSOCIATED_CM=#associatedCM#,
		ASSOCIATED_BDM=#associatedBDM#,
		BRANCH_OFFICE_ID=#branchOfficeId#, 
		STATUS=#clientStatus#,
		CLIENT_SINCE=#clientSince#,
		INVOICE_INSTRUCTION=#invoiceInstruction#,
		IS_SUBJ_LEVEL_SUBRPT_REQ=#isSubreportRequired#,
		UPDATED_BY=#updatedBy#,
		UPDATED_ON=SYSDATE
		<isNotEmpty property="clientGroupId">
		,CLIENT_GROUP_ID=#clientGroupId#
		</isNotEmpty>
		<isEmpty property="clientGroupId">
		,CLIENT_GROUP_ID=0
		</isEmpty>
							
		WHERE CLIENT_MASTER_ID=#clientMasterId#
	 
	 </update>

	<select id="getClientCode" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		 SELECT nvl(MAX(TO_NUMBER(SUBSTR(client_code,   
                INSTR(UPPER(client_code), UPPER(TRIM(#compAlphabet#)), -1)+1,   LENGTH(client_code)))),   0) 
                clientcode
		FROM cms_client_master
		WHERE UPPER(client_code) LIKE
		UPPER(TRIM(#compAlphabet#))||'%'
	 </select>

	<insert id="addClientContact" parameterClass="com.worldcheck.atlas.vo.masters.ClientContactVO">
<selectKey resultClass="int" type="pre" keyProperty="clientContactId">
			SELECT CMS_CLIENT_CONTACT_SEQ.nextval AS VALUE FROM DUAL
  	</selectKey>
		INSERT INTO
		CMS_CLIENT_CONTACT
		(CLIENT_CONTACT_ID,CLIENT_CODE,CONTACT_NAME,PHONE,FAX,EMAIL,REMARKS,UPDATED_BY,UPDATED_ON)
		VALUES
		(#clientContactId#,#clientCode#,#name#,#phone#,#fax#,#email#,#remark#,#userName#,sysdate)
	</insert>

	<select id="getContactDetail" parameterClass="java.lang.String"
		resultMap="contactVO">
		select CLIENT_CODE ,CONTACT_NAME,PHONE,FAX,EMAIL,REMARKS
		from CMS_CLIENT_CONTACT where CLIENT_CODE=#clientCode#
	</select>

	<delete id="deleteContact" parameterClass="java.lang.String">
		delete from CMS_CLIENT_CONTACT where CLIENT_CODE=#clientCode#
	</delete>

	<update id="deActivate" parameterClass="java.lang.String">

		update
		CMS_CLIENT_MASTER 
		set STATUS=0 
		where CLIENT_MASTER_ID in ($clientCodeValue$)
	
	</update>

	<select id="checkClientName" parameterClass="java.lang.String"
		resultClass="java.lang.String">

		SELECT CLIENT_CODE FROM cms_client_master where upper(CLIENT_NAME)=upper(#clientName#)

	</select>

	<select id="getTopTen" resultMap="countryVO">
		select COUNTRY,COUNTRY_CODE from DW_TOP10_COUNTRY
	</select>

	<update id="updateDeactiveClient" parameterClass="java.lang.String">

		update
		CMS_CLIENT_MASTER set STATUS=1 where CLIENT_CODE=#clientCode#
	
	</update>
	
	<update id="updateClientStatus" parameterClass="com.worldcheck.atlas.vo.masters.ClientMasterVO">

		update
		CMS_CLIENT_MASTER set STATUS=#clientStatus# where CLIENT_MASTER_ID in ($clientMasterId$)
	
	</update>

</sqlMap>


